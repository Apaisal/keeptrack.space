(function(){"use strict";async function e(e,t,i){let n=satellite.twoline2satrec(e,t),o=a(i.getUTCFullYear(),i.getUTCMonth()+1,i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds());o+=i.getUTCMilliseconds()*MILLISECONDS_PER_DAY;satellite.gstime(o);let r=(o-n.jdsatepoch)*MINUTES_PER_DAY,s=satellite.sgp4(n,r);return s}function a(e,a,t,i,n,o){return 367*e-Math.floor(7*(e+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+t+1721013.5+((o/60+n)/60+i)/24}function t(e,a,t,n,o,M,l,g){let _,p,x,h,d=1e3*t[1],u=1e3*t[2],v=1e3*t[3],A=1e3*t[4],y=1e3*t[5],P=1e3*t[6],b="m",f="m/s";"kg"!=n&&void 0!==n&&("g"==n&&(e/=1e3),"M_Sun"==n&&(e*=1.98894729428839e30),"M_Mercury"==n&&(e*=3.30192458710471e23),"M_Venus"==n&&(e*=4.86862144253118e24),"M_Earth"==n&&(e*=5.97378250603408e24),"M_Mars"==n&&(e*=6.41863349674674e23),"M_Jupiter"==n&&(e*=1.89863768365072e27),"M_Saturn"==n&&(e*=5.68470940139966e26),"M_Uranus"==n&&(e*=8.68333186484441e25),"M_Neptune"==n&&(e*=1.02431564713932e26),"M_Pluto"==n&&(e*=1.30861680530754e22),"M_Moon"==n&&(e*=7.34777534869879e22),"M_Phobos"==n&&(e*=0x24bd0bab7c4050),"M_Deimos"==n&&(e*=0x663a8fc6ea712),"M_Io"==n&&(e*=8.9320629865446e22),"M_Europa"==n&&(e*=4.79990319196655e22),"M_Ganymede"==n&&(e*=1.48187846087315e23),"M_Callisto"==n&&(e*=1.07595283170753e23),"M_Amalthea"==n&&(e*=749344708762353e4),"M_Himalia"==n&&(e*=955630662185067e4),"M_Elara"==n&&(e*=0xac7645e3016ec80),"M_Pasiphae"==n&&(e*=0x2a64e604bbd2640),"M_Sinope"==n&&(e*=77669981644121200),"M_Lysithea"==n&&(e*=77669981644121200),"M_Carme"==n&&(e*=95563066218506700),"M_Ananke"==n&&(e*=0x87a946758c3b40),"M_Leda"==n&&(e*=5677805607961500),"M_Thebe"==n&&(e*=0xac7645e3016ec80),"M_Adrastea"==n&&(e*=0x43d4a33ac61d6c),"M_Metis"==n&&(e*=95563066218506700),"M_Mimas"==n&&(e*=381429321227243e5),"M_Enceladus"==n&&(e*=117050220435577e6),"M_Tethys"==n&&(e*=617639232970985e6),"M_Dione"==n&&(e*=1.09569832670221e21),"M_Rhea"==n&&(e*=2.31572188769539e21),"M_Titan"==n&&(e*=1.34555202850711e23),"M_Hyperion"==n&&(e*=554593618108186e4),"M_Iapetus"==n&&(e*=1.80652899243564e21),"M_Phoebe"==n&&(e*=828855423929348e4),"M_Janus"==n&&(e*=18972946850153e5),"M_Epimetheus"==n&&(e*=0x74d7501b13c6740),"M_Atlas"==n&&(e*=0x40c23cc7584ce),"M_Prometheus"==n&&(e*=0x29963217b952de0),"M_Pandora"==n&&(e*=0x20f627f182f7260),"M_Ariel"==n&&(e*=1.29013922898875e21),"M_Umbriel"==n&&(e*=1.25880780428295e21),"M_Titania"==n&&(e*=3.4460391356142e21),"M_Oberon"==n&&(e*=2.99680258484984e21),"M_Miranda"==n&&(e*=651349484606072e5),"M_Triton"==n&&(e*=2.13993058500051e22),"M_Charon"==n&&(e*=1.62268483858135e21),"M_Ceres"==n&&(e*=870013290062687e6),"M_Pallas"==n&&(e*=31800485774705e7),"M_Vesta"==n&&(e*=300004582780236e6)),"kg"!=o&&void 0!==o&&("g"==o&&(a/=1e3),"M_Sun"==o&&(a*=1.98894729428839e30),"M_Mercury"==o&&(a*=3.30192458710471e23),"M_Venus"==o&&(a*=4.86862144253118e24),"M_Earth"==o&&(a*=5.97378250603408e24),"M_Mars"==o&&(a*=6.41863349674674e23),"M_Jupiter"==o&&(a*=1.89863768365072e27),"M_Saturn"==o&&(a*=5.68470940139966e26),"M_Uranus"==o&&(a*=8.68333186484441e25),"M_Neptune"==o&&(a*=1.02431564713932e26),"M_Pluto"==o&&(a*=1.30861680530754e22),"M_Moon"==o&&(a*=7.34777534869879e22),"M_Phobos"==o&&(a*=0x24bd0bab7c4050),"M_Deimos"==o&&(a*=0x663a8fc6ea712),"M_Io"==o&&(a*=8.9320629865446e22),"M_Europa"==o&&(a*=4.79990319196655e22),"M_Ganymede"==o&&(a*=1.48187846087315e23),"M_Callisto"==o&&(a*=1.07595283170753e23),"M_Amalthea"==o&&(a*=749344708762353e4),"M_Himalia"==o&&(a*=955630662185067e4),"M_Elara"==o&&(a*=0xac7645e3016ec80),"M_Pasiphae"==o&&(a*=0x2a64e604bbd2640),"M_Sinope"==o&&(a*=77669981644121200),"M_Lysithea"==o&&(a*=77669981644121200),"M_Carme"==o&&(a*=95563066218506700),"M_Ananke"==o&&(a*=0x87a946758c3b40),"M_Leda"==o&&(a*=5677805607961500),"M_Thebe"==o&&(a*=0xac7645e3016ec80),"M_Adrastea"==o&&(a*=0x43d4a33ac61d6c),"M_Metis"==o&&(a*=95563066218506700),"M_Mimas"==o&&(a*=381429321227243e5),"M_Enceladus"==o&&(a*=117050220435577e6),"M_Tethys"==o&&(a*=617639232970985e6),"M_Dione"==o&&(a*=1.09569832670221e21),"M_Rhea"==o&&(a*=2.31572188769539e21),"M_Titan"==o&&(a*=1.34555202850711e23),"M_Hyperion"==o&&(a*=554593618108186e4),"M_Iapetus"==o&&(a*=1.80652899243564e21),"M_Phoebe"==o&&(a*=828855423929348e4),"M_Janus"==o&&(a*=18972946850153e5),"M_Epimetheus"==o&&(a*=0x74d7501b13c6740),"M_Atlas"==o&&(a*=0x40c23cc7584ce),"M_Prometheus"==o&&(a*=0x29963217b952de0),"M_Pandora"==o&&(a*=0x20f627f182f7260),"M_Ariel"==o&&(a*=1.29013922898875e21),"M_Umbriel"==o&&(a*=1.25880780428295e21),"M_Titania"==o&&(a*=3.4460391356142e21),"M_Oberon"==o&&(a*=2.99680258484984e21),"M_Miranda"==o&&(a*=651349484606072e5),"M_Triton"==o&&(a*=2.13993058500051e22),"M_Charon"==o&&(a*=1.62268483858135e21),"M_Ceres"==o&&(a*=870013290062687e6),"M_Pallas"==o&&(a*=31800485774705e7),"M_Vesta"==o&&(a*=300004582780236e6)),void 0!==M&&(_=M[0],p=M[1],b=M[2],x=M[3],h=M[4],f=M[5],"cm"==_&&(d/=100),"km"==_&&(d*=1e3),"AU"==_&&(d*=149597870691),"LY"==_&&(d*=94605e11),"PC"==_&&(d*=30857e12),"mi"==_&&(d*=1609.344),"ft"==_&&(d*=.3048),"cm"==p&&(u/=100),"km"==p&&(u*=1e3),"AU"==p&&(u*=149597870691),"LY"==p&&(u*=94605e11),"PC"==p&&(u*=30857e12),"mi"==p&&(u*=1609.344),"ft"==p&&(u*=.3048),"cm"==b&&(v/=100),"km"==b&&(v*=1e3),"AU"==b&&(v*=149597870691),"LY"==b&&(v*=94605e11),"PC"==b&&(v*=30857e12),"mi"==b&&(v*=1609.344),"ft"==b&&(v*=.3048),"km/s"==x&&(A*=1e3),"km/s"==h&&(y*=1e3),"km/s"==f&&(P*=1e3)),0==d&&(d=1e-15),0==u&&(u=1e-15),0==v&&(v=1e-15),0==A&&(A=1e-15),0==y&&(y=1e-15),0==P&&(P=1e-15);let C=s*(e+a),T=Math.sqrt(d*d+u*u+v*v),k=Math.sqrt(A*A+y*y+P*P),D=1/(2/T-k*k/C),U=u*P-v*y,E=v*A-d*P,j=d*y-u*A,S=Math.sqrt(U*U+E*E+j*j),L=S*S/C,F=d*A+u*y+v*P,I=Math.sqrt(1-L/D),R=1-T/D,Y=F/Math.sqrt(D*C),$=Math.acos(j/S),w=0;0!=$&&(w=i(U,-E));let G=S*S/(T*C)-1,q=S*F/(T*C),N=i(q,G),H=(d*Math.cos(w)+u*Math.sin(w))/T,O=0;O=0==$||$==c?(u*Math.cos(w)-d*Math.sin(w))/T:v/(T*Math.sin($));let J=i(O,H)-N;J<0&&(J=m+J);let V=i(Y,R),z=V-I*Math.sin(V),B=J+N+w;for(;B>=m;)B-=m;const K=D*I;let Q=D-K-r,W=D+K-r,X=m*Math.sqrt(D*D*D/(s*(e+a)));return void 0===l?l="m":("cm"==l&&(D*=100),"km"==l&&(D/=1e3),"AU"==l&&(D/=149597870691),"LY"==l&&(D/=94605e11),"PC"==l&&(D/=30857e12),"mi"==l&&(D/=1609.344),"ft"==l&&(D/=.3048),"cm"==l&&(Q*=100),"km"==l&&(Q/=1e3),"AU"==l&&(Q/=149597870691),"LY"==l&&(Q/=94605e11),"PC"==l&&(Q/=30857e12),"mi"==l&&(Q/=1609.344),"ft"==l&&(Q/=.3048),"cm"==l&&(W*=100),"km"==l&&(W/=1e3),"AU"==l&&(W/=149597870691),"LY"==l&&(W/=94605e11),"PC"==l&&(W/=30857e12),"mi"==l&&(W/=1609.344),"ft"==l&&(W/=.3048)),void 0===g?g="s":("m"==g&&(X/=60),"h"==g&&(X/=3600),"d"==g&&(X/=86400),"yr"==g&&(X/=31558100),"Ky"==g&&(X/=315581e5),"My"==g&&(X/=315581e8),"By"==g&&(X/=315581e11)),$=RAD2DEG*$,w=RAD2DEG*w,J=RAD2DEG*J,z=RAD2DEG*z,N=RAD2DEG*N,B=RAD2DEG*B,{semiMajorAxis:D,eccentricity:I,inclination:$,raan:w,argPe:J,mo:z,ta:N,tl:B,perigee:Q,apogee:W,period:X}}function i(e,a){let t;return 0!=a?(t=Math.atan(e/a),a<0&&(t+=c),a>0&&e<0&&(t+=m)):(e<0&&(t=-c/2),0==e&&(t=0),e>0&&(t=c/2)),t}function n(e,a,t,i,n){return(Math.floor(275*e/9)+a+((n/60+i)/60+t)/24).toFixed(5)}function o(e,a){return e.length<a?o("0"+e,a):e}const r=6371e3,s=6.6725985e-11,c=Math.PI,m=2*c;let M={sat2sv:e=>[timeManager.propTime(),e.position.x,e.position.y,e.position.z,e.velocity.x,e.velocity.y,e.velocity.z],sat2kp:e=>{const a=M.sat2sv(e);return M.sv2kp(a)},sat2tle:e=>{const a=M.sat2kp(e);return M.kp2tle(a)},sv2kp:e=>{const a=t(1,1,e,"kg","M_Earth",[0,0,0,0,0,0],"km","m");return a},kp2tle:(e,a)=>{const t=e.inclination,i=e.raan,r=e.eccentricity,s=e.argPe,c=e.mo,m=1440/e.period;a=void 0===a?new Date(timeManager.propTime()):a;const M=a.getUTCFullYear()-2e3;let l=n(a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds());l=1*l+a.getUTCMilliseconds()*MILLISECONDS_PER_DAY;const g=`1 80000U 58001A   ${M}${o(parseFloat(l).toFixed(8),12)} 0.00000000 +00000-0 +00000-0 0 99990`,_=`2 80000 ${o(t.toFixed(4),8)} ${o(i.toFixed(4),8)} ${r.toPrecision(7).substr(2,7)} ${o(parseFloat(s).toFixed(4),8)} ${o(c.toFixed(4),8)} ${o(m.toFixed(8),11)}000010`;return{tle1:g,tle2:_}},svs2kps:e=>{let a=[];for(let t=0;t<e.length;t++)a.push(M.sv2kp(e[t]));let t={max:{}};t.max.apogee=0,t.max.argPe=0,t.max.eccentricity=0,t.max.inclination=0,t.max.mo=0,t.max.perigee=0,t.max.period=0,t.max.raan=0,t.max.semiMajorAxis=0,t.max.ta=0,t.max.tl=0,t.min={},t.min.apogee=1e6,t.min.argPe=1e6,t.min.eccentricity=1e6,t.min.inclination=1e6,t.min.mo=1e6,t.min.perigee=1e6,t.min.period=1e6,t.min.raan=1e6,t.min.semiMajorAxis=1e6,t.min.ta=1e6,t.min.tl=1e6,t.avg={},t.avg.apogee=0,t.avg.argPe=0,t.avg.eccentricity=0,t.avg.inclination=0,t.avg.mo=0,t.avg.perigee=0,t.avg.period=0,t.avg.raan=0,t.avg.semiMajorAxis=0,t.avg.ta=0,t.avg.tl=0;for(let e=0;e<a.length;e++)a[e].apogee<t.min.apogee&&(t.min.apogee=a[e].apogee),a[e].apogee>t.max.apogee&&(t.max.apogee=a[e].apogee),t.avg.apogee+=a[e].apogee,a[e].argPe<t.min.argPe&&(t.min.argPe=a[e].argPe),a[e].argPe>t.max.argPe&&(t.max.argPe=a[e].argPe),t.avg.argPe+=a[e].argPe,a[e].eccentricity<t.min.eccentricity&&(t.min.eccentricity=a[e].eccentricity),a[e].eccentricity>t.max.eccentricity&&(t.max.eccentricity=a[e].eccentricity),t.avg.eccentricity+=a[e].eccentricity,a[e].inclination<t.min.inclination&&(t.min.inclination=a[e].inclination),a[e].inclination>t.max.inclination&&(t.max.inclination=a[e].inclination),t.avg.inclination+=a[e].inclination,a[e].mo<t.min.mo&&(t.min.mo=a[e].mo),a[e].mo>t.max.mo&&(t.max.mo=a[e].mo),t.avg.mo+=a[e].mo,a[e].perigee<t.min.perigee&&(t.min.perigee=a[e].perigee),a[e].perigee>t.max.perigee&&(t.max.perigee=a[e].perigee),t.avg.perigee+=a[e].perigee,a[e].period<t.min.period&&(t.min.period=a[e].period),a[e].period>t.max.period&&(t.max.period=a[e].period),t.avg.period+=a[e].period,a[e].raan<t.min.raan&&(t.min.raan=a[e].raan),a[e].raan>t.max.raan&&(t.max.raan=a[e].raan),t.avg.raan+=a[e].raan,a[e].semiMajorAxis<t.min.semiMajorAxis&&(t.min.semiMajorAxis=a[e].semiMajorAxis),a[e].semiMajorAxis>t.max.semiMajorAxis&&(t.max.semiMajorAxis=a[e].semiMajorAxis),t.avg.semiMajorAxis+=a[e].semiMajorAxis,a[e].ta<t.min.ta&&(t.min.ta=a[e].ta),a[e].ta>t.max.ta&&(t.max.ta=a[e].ta),t.avg.ta+=a[e].ta,a[e].tl<t.min.tl&&(t.min.tl=a[e].tl),a[e].tl>t.max.tl&&(t.max.tl=a[e].tl),t.avg.tl+=a[e].tl;return t.avg.apogee/=a.length,t.avg.argPe/=a.length,t.avg.eccentricity/=a.length,t.avg.inclination/=a.length,t.avg.mo/=a.length,t.avg.perigee/=a.length,t.avg.period/=a.length,t.avg.raan/=a.length,t.avg.semiMajorAxis/=a.length,t.avg.ta/=a.length,t.avg.tl/=a.length,t},iod:async e=>{const a=M.svs2kps(e);e.sort(function(e,a){return e[0].value-a[0].value});const t=new Date(e[0][0]);return M.fitTles(t,e,a)},fitTles:async(a,t,i)=>{M.debug.closestApproach=0;const n=settingsManager.fitTleSteps,o=(i.max.inclination,i.min.inclination,(i.max.raan-i.min.raan)/n),r=(i.max.eccentricity,i.min.eccentricity,(i.max.argPe-i.min.argPe)/n),s=(i.max.mo-i.min.mo)/n;i.max.period,i.min.period;let c=[1e7];for(let m=-n/2;m<n/2;m++)for(let l=-n;l<n;l++)for(let g=2*-n;g<2*n;g++){let n={};n.inclination=i.avg.inclination,n.raan=i.avg.raan+o*m,n.eccentricity=i.avg.eccentricity,n.argPe=i.avg.argPe+r*l,n.mo=i.avg.mo+s*g/2,n.period=i.avg.period;const _=M.kp2tle(n,a);let p=0,x=0,h=0,d=0;for(let i=0;i<t.length;i++){const n=await e(_.tle1,_.tle2,new Date(a+(t[i][0]-t[0][0])));p+=Math.abs(n.position.x-t[i][1]),x+=Math.abs(n.position.y-t[i][2]),h+=Math.abs(n.position.z-t[i][3]),d+=Math.sqrt(p**2+x**2+h**2)}d/=t.length,d<c[0]&&(c=[d,m,l,g])}console.log(`Closest Approach: ${c[0]}`),M.debug.closestApproach+=c[0];let m={};return m.inclination=i.avg.inclination,m.raan=i.avg.raan+o*c[1],m.eccentricity=i.avg.eccentricity,m.argPe=i.avg.argPe+r*c[2],m.mo=i.avg.mo+s*c[3],m.period=i.avg.period,M.kp2tle(m,a)},svs2analyst:async e=>{M.iod(e).then(e=>{satSet.insertNewAnalystSatellite(e.tle1,e.tle2,satSet.getIdFromObjNum(8e4))})},testIod:()=>{fetch("/metObs.json").then(e=>e.json()).then(e=>{for(let a=0;a<e.length;a++){let t=e[a];omManager.svs2analyst(t)}M.debug.closestApproach/=e.length,console.log(`Average Approach: ${M.debug.closestApproach}`)})},debug:{}};M.debug.closestApproach=0,window.omManager=M})();
"use strict";function _lookAnglesToEcf(s,e,a,t,o,n){return geodeticCoords={},geodeticCoords.latitude=t,geodeticCoords.longitude=o,geodeticCoords.height=n,siteXYZ=satellite.geodeticToEcf(geodeticCoords),sitex=siteXYZ.x,sitey=siteXYZ.y,sitez=siteXYZ.z,slat=Math.sin(t),slon=Math.sin(o),clat=Math.cos(t),clon=Math.cos(o),azRad=DEG2RAD*s,elRad=DEG2RAD*e,south=-a*Math.cos(elRad)*Math.cos(azRad),east=a*Math.cos(elRad)*Math.sin(azRad),zenith=a*Math.sin(elRad),x=slat*clon*south+-slon*east+clat*clon*zenith+sitex,y=slat*slon*south+clon*east+clat*slon*zenith+sitey,z=-clat*south+slat*zenith+sitez,{x:x,y:y,z:z}}function propagateCruncher(){propagationRunning=!0;var s=propTime(),e=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds());e+=1.15741e-8*s.getUTCMilliseconds();var a=satellite.gstime(e),t=!1;if(isSunlightView&&!isMultiSensor){var o=new A.JulianDay(e),n=A.EclCoord.fromWgs84(0,0,0),i=A.EclCoord.fromWgs84(sensor.observerGd.latitude*RAD2DEG,sensor.observerGd.longitude*RAD2DEG,sensor.observerGd.height),r=A.Solar.topocentricPosition(o,n,!1),l=A.Solar.topocentricPosition(o,i,!1);sunAz=r.hz.az*RAD2DEG+180,sunEl=r.hz.alt*RAD2DEG%360,sunElRel=l.hz.alt*RAD2DEG%360;var c=new A.JulianDay(A.JulianDay.dateToJD(s)).jdJ2000Century();sunG=180*A.Solar.meanAnomaly(c)/PI,sunG%=360,sunR=1.00014-.01671*Math.cos(sunG)-14e-5*Math.cos(2*sunG),sunRange=149597870700*sunR/1e3,sunECI=satellite.ecfToEci(_lookAnglesToEcf(sunAz,sunEl,sunRange,0,0,0),a),t=sensor.observerGd!==defaultGd&&("Optical"===sensor.type||"Observer"===sensor.type)&&sunElRel>-6}var h=e;h=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()+1),h+=1.15741e-8*s.getUTCMilliseconds();var m=satellite.gstime(h);len=satCache.length-1,(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(len-=fieldOfViewSetLength);var d=-1;let b,u,g,f,M,S,R,V,P,D,p,x,C,E,v,z,G,T,w,y,I,O,k,F,_,L,U,N,B,j,H,J,Y,q,X,Z,W,K,Q,$,ss,es,as,ts=!1;for(;d<len;){if(d++,w=satCache[d],w.satnum){if(w.skip)continue;v=1440*(e-w.jdsatepoch),z=satellite.sgp4(w,v);try{satPos[3*d]=z.position.x,satPos[3*d+1]=z.position.y,satPos[3*d+2]=z.position.z,satVel[3*d]=z.velocity.x,satVel[3*d+1]=z.velocity.y,satVel[3*d+2]=z.velocity.z,ts||(sensor.observerGd===defaultGd||isMultiSensor?ts=!0:(b=satellite.eciToEcf(z.position,a),u=satellite.ecfToLookAngles(sensor.observerGd,b),g=u.azimuth,f=u.elevation,M=u.rangeSat))}catch(s){satCache[d].skip=!0,satPos[3*d]=0,satPos[3*d+1]=0,satPos[3*d+2]=0,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,b=0,u=0,g=0,f=0,M=0}if(satInView[d]=!1,satInSun[d]=2,isSunlightView&&(_=Math.asin(RADIUS_OF_EARTH/Math.sqrt(Math.pow(-satPos[3*d],2)+Math.pow(-satPos[3*d+1],2)+Math.pow(-satPos[3*d+2],2)))*RAD2DEG,L=Math.asin(RADIUS_OF_SUN/Math.sqrt(Math.pow(-satPos[3*d]+sunECI.x,2)+Math.pow(-satPos[3*d+1]+sunECI.y,2)+Math.pow(-satPos[3*d+2]+sunECI.z,2)))*RAD2DEG,U=Math.acos(numeric.dot([-satPos[3*d],-satPos[3*d+1],-satPos[3*d+2]],[-satPos[3*d]+sunECI.x,-satPos[3*d+1]+sunECI.y,-satPos[3*d+2]+sunECI.z])/(Math.sqrt(Math.pow(-satPos[3*d],2)+Math.pow(-satPos[3*d+1],2)+Math.pow(-satPos[3*d+2],2))*Math.sqrt(Math.pow(-satPos[3*d]+sunECI.x,2)+Math.pow(-satPos[3*d+1]+sunECI.y,2)+Math.pow(-satPos[3*d+2]+sunECI.z,2))))*RAD2DEG,_>L&&U<_-L&&(satInSun[d]=0),Math.abs(_-L)<U&&U<_+L&&(satInSun[d]=1),L>_&&(satInSun[d]=1),U<L-_&&(satInSun[d]=1)),sensor.observerGd!==defaultGd&&!t)if(isMultiSensor){for(E=0;E<mSensor.length;E++)if("Optical"!=sensor.type||0!=satInSun[d]){if(satInView[d])break;sensor=mSensor[E],sensor.observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei};try{b=satellite.eciToEcf(z.position,a),u=satellite.ecfToLookAngles(sensor.observerGd,b)}catch(s){continue}g=u.azimuth,f=u.elevation,M=u.rangeSat,g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[d]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[d]=!0)}}else"Optical"==sensor.type&&0==satInSun[d]||(g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[d]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[d]=!0))}else if(satCache[d].isRadarData){if(satCache[d].skip)continue;satCache[d].skip=!0,satPos[3*d]=0,satPos[3*d+1]=0,satPos[3*d+2]=0,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0}else if(satCache[d].static&&!satCache[d].marker)"Star"==satCache[d].type?(N=getStarPosition(s,180,0,satCache[d]),N=_lookAnglesToEcf(N.azimuth*RAD2DEG,N.altitude*RAD2DEG,STAR_DISTANCE,0,0,0),(0==satPos[3*d]||satPos[3*d]-N.x<.1&&satPos[3*d]-N.x>-.1)&&(satPos[3*d]=N.x),(0==satPos[3*d+1]||satPos[3*d+1]-N.y<.1&&satPos[3*d+1]-N.y>-.1)&&(satPos[3*d+1]=N.y),(0==satPos[3*d+2]||satPos[3*d+2]-N.z<.1&&satPos[3*d+2]-N.z>-.1)&&(satPos[3*d+2]=N.z)):(P=Math.cos(satCache[d].lat*DEG2RAD),D=Math.sin(satCache[d].lat*DEG2RAD),p=Math.cos(satCache[d].lon*DEG2RAD+a),x=Math.sin(satCache[d].lon*DEG2RAD+a),satPos[3*d]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[d].alt)*P*p,satPos[3*d+1]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[d].alt)*P*x,satPos[3*d+2]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[d].alt)*D),satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0;else if(satCache[d].missile){if(!satCache[d].active)continue;for(G=satCache[d].altList.length,T=0;T<G;T++)if(1*satCache[d].startTime+1e3*T>=1*s){C=T;break}satCache[d].lastTime=satCache[d].lastTime>=0?satCache[d].lastTime:0,P=Math.cos(satCache[d].latList[satCache[d].lastTime+1]*DEG2RAD),D=Math.sin(satCache[d].latList[satCache[d].lastTime+1]*DEG2RAD),p=Math.cos(satCache[d].lonList[satCache[d].lastTime+1]*DEG2RAD+m),x=Math.sin(satCache[d].lonList[satCache[d].lastTime+1]*DEG2RAD+m),0==satCache[d].lastTime?(satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0):0==satVel[3*d]&&0==satVel[3*d+1]&&0==satVel[3*d+2]?(satVel[3*d]=(6371+satCache[d].altList[satCache[d].lastTime+1])*P*p-satPos[3*d],satVel[3*d+1]=(6371+satCache[d].altList[satCache[d].lastTime+1])*P*x-satPos[3*d+1],satVel[3*d+2]=(6371+satCache[d].altList[satCache[d].lastTime+1])*D-satPos[3*d+2]):(satVel[3*d]+=(6371+satCache[d].altList[satCache[d].lastTime+1])*P*p-satPos[3*d],satVel[3*d+1]+=(6371+satCache[d].altList[satCache[d].lastTime+1])*P*x-satPos[3*d+1],satVel[3*d+2]+=(6371+satCache[d].altList[satCache[d].lastTime+1])*D-satPos[3*d+2],satVel[3*d]*=.5,satVel[3*d+1]*=.5,satVel[3*d+2]*=.5),P=Math.cos(satCache[d].latList[C]*DEG2RAD),D=Math.sin(satCache[d].latList[C]*DEG2RAD),p=Math.cos(satCache[d].lonList[C]*DEG2RAD+a),x=Math.sin(satCache[d].lonList[C]*DEG2RAD+a),satPos[3*d]=(6371+satCache[d].altList[C])*P*p,satPos[3*d+1]=(6371+satCache[d].altList[C])*P*x,satPos[3*d+2]=(6371+satCache[d].altList[C])*D,satCache[d].lastTime=C,S=satPos[3*d],R=satPos[3*d+1],V=satPos[3*d+2],b=satellite.eciToEcf({x:S,y:R,z:V},a),satellite.eciToGeodetic({x:S,y:R,z:V},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[d].skip=!0),u=satellite.ecfToLookAngles(sensor.observerGd,b),g=u.azimuth*RAD2DEG,f=u.elevation*RAD2DEG,M=u.rangeSat,satInView[d]=!1,sensor.obsminaz>sensor.obsmaxaz?(g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2?satInView[d]=!0:satInView[d]=!1:g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2?satInView[d]=!0:satInView[d]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],E=0;E<mSensor.length;E++)if(sensorMarkerArray.push(d),sensor=mSensor[E],sensor.observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[d].marker){if(satPos[3*d]=0,satPos[3*d+1]=0,satPos[3*d+2]=0,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Observer"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(F=20,!isShowSurvFence||sensor.volume)if(0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=sensor.obsminaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2){k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a);try{satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}catch(s){console.log(s)}}for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=sensor.obsmaxaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++;if(void 0!==sensor.obsminaz2){for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=sensor.obsminaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++;for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=sensor.obsmaxaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}}else for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(I=sensor.obsmaxel,y=sensor.obsminaz;y<sensor.obsmaxaz;y+=2)k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++;for(F=2,O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=0;y<360;y+=1*F){if(sensor.obsminaz>sensor.obsmaxaz){if(!(y>=sensor.obsminaz||y<=sensor.obsmaxaz))continue}else if(!(y>=sensor.obsminaz&&y<=sensor.obsmaxaz))continue;if(k=satellite.ecfToEci(_lookAnglesToEcf(y,sensor.obsminel,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),d===len){console.error("No More Markers");break}satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}if(void 0!==sensor.obsminaz2)for(F=2,O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=0;y<360;y+=1*F){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(y>=sensor.obsminaz2||y<=sensor.obsmaxaz2))continue}else if(!(y>=sensor.obsminaz2&&y<=sensor.obsmaxaz2))continue;if(k=satellite.ecfToEci(_lookAnglesToEcf(y,sensor.obsminel2,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),d===len){console.error("No More Markers");break}satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}if(!isShowSurvFence||sensor.volume){for(O=Math.min(sensor.obsmaxrange,6e4),y=0;y<360;y+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(y>=sensor.obsminaz||y<=sensor.obsmaxaz))continue}else if(!(y>=sensor.obsminaz&&y<=sensor.obsmaxaz))continue;for(I=sensor.obsminel;I<sensor.obsmaxel;I+=2){if(k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),d===len){console.error("No More Markers");break}satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}}if(void 0!==sensor.obsminaz2)for(O=Math.min(sensor.obsmaxrange2,6e4),y=0;y<360;y+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(y>=sensor.obsminaz2||y<=sensor.obsmaxaz2))continue}else if(!(y>=sensor.obsminaz2&&y<=sensor.obsmaxaz2))continue;for(I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2){if(k=satellite.ecfToEci(_lookAnglesToEcf(y,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),d===len){console.error("No More Markers");break}satCache[d].active=!0,satPos[3*d]=k.x,satPos[3*d+1]=k.y,satPos[3*d+2]=k.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[d].marker){if(isResetSatOverfly&&!0===satCache[d].active){satCache[d].active=!1,satPos[3*d]=0,satPos[3*d+1]=0,satPos[3*d+2]=0,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0;continue}for(B=0;B<satelliteSelected.length;B++)if(-1!==satelliteSelected[B]){if(!isShowSatOverfly)continue;for(J=satPos[3*satelliteSelected[B]],Y=satPos[3*satelliteSelected[B]+1],q=satPos[3*satelliteSelected[B]+2],X={x:J,y:Y,z:q},Z=satellite.ecfToEci(X,a),W=satellite.eciToGeodetic(Z,a),K=W.height,Q={longitude:W.longitude,latitude:W.latitude,height:1},ss=1,K<2500&&selectedSatFOV<=60&&(ss=.5),(K>7e3||selectedSatFOV>=90)&&(ss=2),satelliteSelected.length>1&&(ss=2),$=-60;$<60;$+=ss)if(j=Math.max(Math.min(Math.round(W.latitude*RAD2DEG)+$,90),-90)*DEG2RAD,!(j>90))for(as=1,K<2500&&selectedSatFOV<=60&&(as=.5),(K>7e3||selectedSatFOV>=90)&&(as=2),satelliteSelected.length>1&&(as=2),es=0;es<181;es+=as){if(H=W.longitude+es*DEG2RAD,Q={longitude:H,latitude:j,height:15},u=satellite.ecfToLookAngles(Q,X),f=u.elevation,f*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(Q=satellite.geodeticToEcf(Q),d===len){console.error("Ran out of Markers");continue}satCache[d].active=!0,satPos[3*d]=Q.x,satPos[3*d+1]=Q.y,satPos[3*d+2]=Q.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}if(0!==es&&180!==es){if(H=W.longitude-es*DEG2RAD,Q={longitude:H,latitude:j,height:15},u=satellite.ecfToLookAngles(Q,X),f=u.elevation,f*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(Q=satellite.geodeticToEcf(Q),d===len){console.error("Ran out of Markers");continue}satCache[d].active=!0,satPos[3*d]=Q.x,satPos[3*d+1]=Q.y,satPos[3*d+2]=Q.z,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,d++}if(90===j||-90===j)break}}}}if(isResetSatOverfly=!1,satCache[d].marker)for(;d<len;d++){if(!satCache[d].active){len-=fieldOfViewSetLength;break}satPos[3*d]=0,satPos[3*d+1]=0,satPos[3*d+2]=0,satVel[3*d]=0,satVel[3*d+1]=0,satVel[3*d+2]=0,satCache[d].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,len-=fieldOfViewSetLength),postMessageArray={satPos:satPos,satVel:satVel},sensor.observerGd!==defaultGd&&(postMessageArray.satInView=satInView),isSunlightView&&(postMessageArray.satInSun=satInSun),sensorMarkerArray.length>1&&(postMessageArray.sensorMarkerArray=sensorMarkerArray),postMessage(postMessageArray),setTimeout(()=>{propagateCruncher()},1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(s,e,a,t,o,n){return 367*s-Math.floor(7*(s+Math.floor((e+9)/12))*.25)+Math.floor(275*e/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){var s=new Date,e=Number(s)-Number(propRealTime),a=e*propRate;return s.setTime(Number(propRealTime)+propOffset+a),s}function toJulian(s){return s.valueOf()/MILLISECONDS_PER_DAY-.5+J1970}function toDays(s){return toJulian(s)-J2000}function getAzimuth(s,e,a){return atan(sin(s),cos(s)*sin(e)-tan(a)*cos(e))}function getAltitude(s,e,a){return asin(sin(e)*sin(a)+cos(e)*cos(a)*cos(s))}function getSiderealTime(s,e){return rad*(280.16+360.9856235*s)-e}function getStarPosition(s,e,a,t){return lw=rad*-a,phi=rad*e,d=toDays(s),H=getSiderealTime(d,lw)-t.ra/12*PI,h=getAltitude(H,phi,t.dec/180*PI),h+=.017*rad/tan(h+10.26*rad/(h+5.1*rad)),{azimuth:getAzimuth(H,phi,t.dec/180*PI),altitude:h,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}}importScripts("lib/satellite.js"),importScripts("lib/numeric.js"),importScripts("lib/meuusjs.1.0.3.min.js");const PI=Math.PI,TAU=2*PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,GROUND_BUFFER_DISTANCE=1,RADIUS_OF_SUN=695700,STAR_DISTANCE=25e4,MILLISECONDS_PER_DAY=864e5;var satPos,satVel,satInView,satInSun,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1];let globalPropagationRate=1e3,globalPropagationRateMultiplier=1;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now(),selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,isSunlightView=!1,isLowPerf=!1,isResetMarker=!1,isResetInView=!1,isResetSunlight=!1;let fieldOfViewSetLength,len,postMessageArray={};var geodeticCoords,siteXYZ,sitex,sitey,sitez,slat,slon,clat,clon,azRad,elRad,south,east,zenith,x,y,z,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd,onmessage=function(s){switch(propRealTime=Date.now(),s.data.isSunlightView&&(isSunlightView=s.data.isSunlightView,0==isSunlightView&&(isResetSunlight=!0)),s.data.satelliteSelected&&(satelliteSelected=s.data.satelliteSelected,-1===satelliteSelected[0]&&(isResetSatOverfly=!0,0==isResetMarker&&(isResetMarker=!0))),s.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),s.data.isLowPerf&&(isLowPerf=!0),s.data.fieldOfViewSetLength&&(fieldOfViewSetLength=s.data.fieldOfViewSetLength),"enable"===s.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=s.data.selectedSatFOV),"reset"===s.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===s.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowSurvFence&&(isShowSurvFence=!0,0==isResetMarker&&(isResetMarker=!0)),"disable"===s.data.isShowSurvFence&&(isShowSurvFence=!1,0==isResetMarker&&(isResetMarker=!0)),s.data.multiSensor?(isMultiSensor=!0,mSensor=s.data.sensor,sensor=s.data.sensor,globalPropagationRate=2e3,0==isResetInView&&(isResetInView=!0)):s.data.sensor&&(sensor=s.data.sensor,s.data.setlatlong&&(s.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={},0==isResetInView&&(isResetInView=!0)):(globalPropagationRate=2e3,sensor.observerGd={longitude:s.data.sensor.long*DEG2RAD,latitude:s.data.sensor.lat*DEG2RAD,height:1*s.data.sensor.obshei},0==isResetInView&&(isResetInView=!0))),isMultiSensor=!1),s.data.typ){case"offset":return propOffset=Number(s.data.dat.split(" ")[0]),propRate=Number(s.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var e=JSON.parse(s.data.dat);len=e.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,e[t].static||e[t].missile||e[t].isRadarData?(a=e[t],delete a.id,o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(e[t].TLE1,e[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),delete a.id,satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),satInSun=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),e=null;break;case"satEdit":satCache[s.data.id]=satellite.twoline2satrec(s.data.TLE1,s.data.TLE2),a=satCache[s.data.id],o=[],n={},n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=s.data.TLE1,n.TLE2=s.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:s.data.id});break;case"newMissile":satCache[s.data.id]=s.data}propagationRunning||(len=-1,propagateCruncher())};var sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180;const J1970=2440588,J2000=2451545;var lw,phi,d,H,h;
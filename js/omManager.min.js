!function(){"use strict";const e=6371e3,a=6.6725985e-11,t=Math.PI,i=2*t;let n={};var o,r,s,c,m;async function M(e,a,t){let i=satellite.twoline2satrec(e,a),n=function(e,a,t,i,n,o){return 367*e-Math.floor(7*(e+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+t+1721013.5+((o/60+n)/60+i)/24}(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds());n+=t.getUTCMilliseconds()*MILLISECONDS_PER_DAY;satellite.gstime(n);let o=(n-i.jdsatepoch)*MINUTES_PER_DAY;return satellite.sgp4(i,o)}function l(e,a){let n;return 0!=a?(n=Math.atan(e/a),a<0&&(n+=t),a>0&&e<0&&(n+=i)):(e<0&&(n=-t/2),0==e&&(n=0),e>0&&(n=t/2)),n}function g(e,a){return e.length<a?g("0"+e,a):e}n.sat2sv=(e=>[timeManager.propTime(),e.position.x,e.position.y,e.position.z,e.velocity.x,e.velocity.y,e.velocity.z]),n.sat2kp=(e=>{const a=n.sat2sv(e);return n.sv2kp(a)}),n.sat2tle=(e=>{const a=n.sat2kp(e);return n.kp2tle(a)}),n.sv2kp=(n=>{return function(n,o,r,s,c,m,M,g){let _,p,x,h,d=1e3*r[1],v=1e3*r[2],u=1e3*r[3],A=1e3*r[4],y=1e3*r[5],P=1e3*r[6],b="m",f="m/s";"kg"!=s&&void 0!==s&&("g"==s&&(n/=1e3),"M_Sun"==s&&(n*=1.98894729428839e30),"M_Mercury"==s&&(n*=3.30192458710471e23),"M_Venus"==s&&(n*=4.86862144253118e24),"M_Earth"==s&&(n*=5.97378250603408e24),"M_Mars"==s&&(n*=6.41863349674674e23),"M_Jupiter"==s&&(n*=1.89863768365072e27),"M_Saturn"==s&&(n*=5.68470940139966e26),"M_Uranus"==s&&(n*=8.68333186484441e25),"M_Neptune"==s&&(n*=1.02431564713932e26),"M_Pluto"==s&&(n*=1.30861680530754e22),"M_Moon"==s&&(n*=7.34777534869879e22),"M_Phobos"==s&&(n*=0x24bd0bab7c4050),"M_Deimos"==s&&(n*=0x663a8fc6ea712),"M_Io"==s&&(n*=8.9320629865446e22),"M_Europa"==s&&(n*=4.79990319196655e22),"M_Ganymede"==s&&(n*=1.48187846087315e23),"M_Callisto"==s&&(n*=1.07595283170753e23),"M_Amalthea"==s&&(n*=749344708762353e4),"M_Himalia"==s&&(n*=955630662185067e4),"M_Elara"==s&&(n*=0xac7645e3016ec80),"M_Pasiphae"==s&&(n*=0x2a64e604bbd2640),"M_Sinope"==s&&(n*=77669981644121200),"M_Lysithea"==s&&(n*=77669981644121200),"M_Carme"==s&&(n*=95563066218506700),"M_Ananke"==s&&(n*=0x87a946758c3b40),"M_Leda"==s&&(n*=5677805607961500),"M_Thebe"==s&&(n*=0xac7645e3016ec80),"M_Adrastea"==s&&(n*=0x43d4a33ac61d6c),"M_Metis"==s&&(n*=95563066218506700),"M_Mimas"==s&&(n*=381429321227243e5),"M_Enceladus"==s&&(n*=117050220435577e6),"M_Tethys"==s&&(n*=617639232970985e6),"M_Dione"==s&&(n*=1.09569832670221e21),"M_Rhea"==s&&(n*=2.31572188769539e21),"M_Titan"==s&&(n*=1.34555202850711e23),"M_Hyperion"==s&&(n*=554593618108186e4),"M_Iapetus"==s&&(n*=1.80652899243564e21),"M_Phoebe"==s&&(n*=828855423929348e4),"M_Janus"==s&&(n*=18972946850153e5),"M_Epimetheus"==s&&(n*=0x74d7501b13c6740),"M_Atlas"==s&&(n*=0x40c23cc7584ce),"M_Prometheus"==s&&(n*=0x29963217b952de0),"M_Pandora"==s&&(n*=0x20f627f182f7260),"M_Ariel"==s&&(n*=1.29013922898875e21),"M_Umbriel"==s&&(n*=1.25880780428295e21),"M_Titania"==s&&(n*=3.4460391356142e21),"M_Oberon"==s&&(n*=2.99680258484984e21),"M_Miranda"==s&&(n*=651349484606072e5),"M_Triton"==s&&(n*=2.13993058500051e22),"M_Charon"==s&&(n*=1.62268483858135e21),"M_Ceres"==s&&(n*=870013290062687e6),"M_Pallas"==s&&(n*=31800485774705e7),"M_Vesta"==s&&(n*=300004582780236e6));"kg"!=c&&void 0!==c&&("g"==c&&(o/=1e3),"M_Sun"==c&&(o*=1.98894729428839e30),"M_Mercury"==c&&(o*=3.30192458710471e23),"M_Venus"==c&&(o*=4.86862144253118e24),"M_Earth"==c&&(o*=5.97378250603408e24),"M_Mars"==c&&(o*=6.41863349674674e23),"M_Jupiter"==c&&(o*=1.89863768365072e27),"M_Saturn"==c&&(o*=5.68470940139966e26),"M_Uranus"==c&&(o*=8.68333186484441e25),"M_Neptune"==c&&(o*=1.02431564713932e26),"M_Pluto"==c&&(o*=1.30861680530754e22),"M_Moon"==c&&(o*=7.34777534869879e22),"M_Phobos"==c&&(o*=0x24bd0bab7c4050),"M_Deimos"==c&&(o*=0x663a8fc6ea712),"M_Io"==c&&(o*=8.9320629865446e22),"M_Europa"==c&&(o*=4.79990319196655e22),"M_Ganymede"==c&&(o*=1.48187846087315e23),"M_Callisto"==c&&(o*=1.07595283170753e23),"M_Amalthea"==c&&(o*=749344708762353e4),"M_Himalia"==c&&(o*=955630662185067e4),"M_Elara"==c&&(o*=0xac7645e3016ec80),"M_Pasiphae"==c&&(o*=0x2a64e604bbd2640),"M_Sinope"==c&&(o*=77669981644121200),"M_Lysithea"==c&&(o*=77669981644121200),"M_Carme"==c&&(o*=95563066218506700),"M_Ananke"==c&&(o*=0x87a946758c3b40),"M_Leda"==c&&(o*=5677805607961500),"M_Thebe"==c&&(o*=0xac7645e3016ec80),"M_Adrastea"==c&&(o*=0x43d4a33ac61d6c),"M_Metis"==c&&(o*=95563066218506700),"M_Mimas"==c&&(o*=381429321227243e5),"M_Enceladus"==c&&(o*=117050220435577e6),"M_Tethys"==c&&(o*=617639232970985e6),"M_Dione"==c&&(o*=1.09569832670221e21),"M_Rhea"==c&&(o*=2.31572188769539e21),"M_Titan"==c&&(o*=1.34555202850711e23),"M_Hyperion"==c&&(o*=554593618108186e4),"M_Iapetus"==c&&(o*=1.80652899243564e21),"M_Phoebe"==c&&(o*=828855423929348e4),"M_Janus"==c&&(o*=18972946850153e5),"M_Epimetheus"==c&&(o*=0x74d7501b13c6740),"M_Atlas"==c&&(o*=0x40c23cc7584ce),"M_Prometheus"==c&&(o*=0x29963217b952de0),"M_Pandora"==c&&(o*=0x20f627f182f7260),"M_Ariel"==c&&(o*=1.29013922898875e21),"M_Umbriel"==c&&(o*=1.25880780428295e21),"M_Titania"==c&&(o*=3.4460391356142e21),"M_Oberon"==c&&(o*=2.99680258484984e21),"M_Miranda"==c&&(o*=651349484606072e5),"M_Triton"==c&&(o*=2.13993058500051e22),"M_Charon"==c&&(o*=1.62268483858135e21),"M_Ceres"==c&&(o*=870013290062687e6),"M_Pallas"==c&&(o*=31800485774705e7),"M_Vesta"==c&&(o*=300004582780236e6));void 0!==m&&(_=m[0],p=m[1],b=m[2],x=m[3],h=m[4],f=m[5],"cm"==_&&(d/=100),"km"==_&&(d*=1e3),"AU"==_&&(d*=149597870691),"LY"==_&&(d*=94605e11),"PC"==_&&(d*=30857e12),"mi"==_&&(d*=1609.344),"ft"==_&&(d*=.3048),"cm"==p&&(v/=100),"km"==p&&(v*=1e3),"AU"==p&&(v*=149597870691),"LY"==p&&(v*=94605e11),"PC"==p&&(v*=30857e12),"mi"==p&&(v*=1609.344),"ft"==p&&(v*=.3048),"cm"==b&&(u/=100),"km"==b&&(u*=1e3),"AU"==b&&(u*=149597870691),"LY"==b&&(u*=94605e11),"PC"==b&&(u*=30857e12),"mi"==b&&(u*=1609.344),"ft"==b&&(u*=.3048),"km/s"==x&&(A*=1e3),"km/s"==h&&(y*=1e3),"km/s"==f&&(P*=1e3));0==d&&(d=1e-15);0==v&&(v=1e-15);0==u&&(u=1e-15);0==A&&(A=1e-15);0==y&&(y=1e-15);0==P&&(P=1e-15);let C=a*(n+o),T=Math.sqrt(d*d+v*v+u*u),k=Math.sqrt(A*A+y*y+P*P),D=1/(2/T-k*k/C),U=v*P-u*y,E=u*A-d*P,j=d*y-v*A,S=Math.sqrt(U*U+E*E+j*j),L=S*S/C,F=d*A+v*y+u*P,I=Math.sqrt(1-L/D),R=1-T/D,Y=F/Math.sqrt(D*C),$=Math.acos(j/S),w=0;0!=$&&(w=l(U,-E));let G=l(S*F/(T*C),S*S/(T*C)-1),q=(d*Math.cos(w)+v*Math.sin(w))/T,N=0;N=0==$||$==t?(v*Math.cos(w)-d*Math.sin(w))/T:u/(T*Math.sin($));let H=l(N,q)-G;H<0&&(H=i+H);let O=l(Y,R),J=O-I*Math.sin(O),V=H+G+w;for(;V>=i;)V-=i;const z=D*I;let B=D-z-e,K=D+z-e,Q=i*Math.sqrt(D*D*D/(a*(n+o)));void 0===M?M="m":("cm"==M&&(D*=100),"km"==M&&(D/=1e3),"AU"==M&&(D/=149597870691),"LY"==M&&(D/=94605e11),"PC"==M&&(D/=30857e12),"mi"==M&&(D/=1609.344),"ft"==M&&(D/=.3048),"cm"==M&&(B*=100),"km"==M&&(B/=1e3),"AU"==M&&(B/=149597870691),"LY"==M&&(B/=94605e11),"PC"==M&&(B/=30857e12),"mi"==M&&(B/=1609.344),"ft"==M&&(B/=.3048),"cm"==M&&(K*=100),"km"==M&&(K/=1e3),"AU"==M&&(K/=149597870691),"LY"==M&&(K/=94605e11),"PC"==M&&(K/=30857e12),"mi"==M&&(K/=1609.344),"ft"==M&&(K/=.3048));void 0===g?g="s":("m"==g&&(Q/=60),"h"==g&&(Q/=3600),"d"==g&&(Q/=86400),"yr"==g&&(Q/=31558100),"Ky"==g&&(Q/=315581e5),"My"==g&&(Q/=315581e8),"By"==g&&(Q/=315581e11));return $=RAD2DEG*$,w=RAD2DEG*w,H=RAD2DEG*H,J=RAD2DEG*J,G=RAD2DEG*G,V=RAD2DEG*V,{semiMajorAxis:D,eccentricity:I,inclination:$,raan:w,argPe:H,mo:J,ta:G,tl:V,perigee:B,apogee:K,period:Q}}(1,1,n,"kg","M_Earth",[0,0,0,0,0,0],"km","m")}),n.kp2tle=((e,a)=>{const t=e.inclination,i=e.raan,n=e.eccentricity,M=e.argPe,l=e.mo,_=1440/e.period,p=(a=void 0===a?new Date(timeManager.propTime()):a).getUTCFullYear()-2e3;let x=(o=a.getUTCMonth(),r=a.getUTCDate(),s=a.getUTCHours(),c=a.getUTCMinutes(),m=a.getUTCSeconds(),(Math.floor(275*o/9)+r+((m/60+c)/60+s)/24).toFixed(5));return x=1*x+a.getUTCMilliseconds()*MILLISECONDS_PER_DAY,{tle1:`1 80000U 58001A   ${p}${g(parseFloat(x).toFixed(8),12)} 0.00000000 +00000-0 +00000-0 0 99990`,tle2:`2 80000 ${g(t.toFixed(4),8)} ${g(i.toFixed(4),8)} ${n.toPrecision(7).substr(2,7)} ${g(parseFloat(M).toFixed(4),8)} ${g(l.toFixed(4),8)} ${g(_.toFixed(8),11)}000010`}}),n.svs2kps=(e=>{let a=[];for(let t=0;t<e.length;t++)a.push(n.sv2kp(e[t]));let t={max:{}};t.max.apogee=0,t.max.argPe=0,t.max.eccentricity=0,t.max.inclination=0,t.max.mo=0,t.max.perigee=0,t.max.period=0,t.max.raan=0,t.max.semiMajorAxis=0,t.max.ta=0,t.max.tl=0,t.min={},t.min.apogee=1e6,t.min.argPe=1e6,t.min.eccentricity=1e6,t.min.inclination=1e6,t.min.mo=1e6,t.min.perigee=1e6,t.min.period=1e6,t.min.raan=1e6,t.min.semiMajorAxis=1e6,t.min.ta=1e6,t.min.tl=1e6,t.avg={},t.avg.apogee=0,t.avg.argPe=0,t.avg.eccentricity=0,t.avg.inclination=0,t.avg.mo=0,t.avg.perigee=0,t.avg.period=0,t.avg.raan=0,t.avg.semiMajorAxis=0,t.avg.ta=0,t.avg.tl=0;for(let e=0;e<a.length;e++)a[e].apogee<t.min.apogee&&(t.min.apogee=a[e].apogee),a[e].apogee>t.max.apogee&&(t.max.apogee=a[e].apogee),t.avg.apogee+=a[e].apogee,a[e].argPe<t.min.argPe&&(t.min.argPe=a[e].argPe),a[e].argPe>t.max.argPe&&(t.max.argPe=a[e].argPe),t.avg.argPe+=a[e].argPe,a[e].eccentricity<t.min.eccentricity&&(t.min.eccentricity=a[e].eccentricity),a[e].eccentricity>t.max.eccentricity&&(t.max.eccentricity=a[e].eccentricity),t.avg.eccentricity+=a[e].eccentricity,a[e].inclination<t.min.inclination&&(t.min.inclination=a[e].inclination),a[e].inclination>t.max.inclination&&(t.max.inclination=a[e].inclination),t.avg.inclination+=a[e].inclination,a[e].mo<t.min.mo&&(t.min.mo=a[e].mo),a[e].mo>t.max.mo&&(t.max.mo=a[e].mo),t.avg.mo+=a[e].mo,a[e].perigee<t.min.perigee&&(t.min.perigee=a[e].perigee),a[e].perigee>t.max.perigee&&(t.max.perigee=a[e].perigee),t.avg.perigee+=a[e].perigee,a[e].period<t.min.period&&(t.min.period=a[e].period),a[e].period>t.max.period&&(t.max.period=a[e].period),t.avg.period+=a[e].period,a[e].raan<t.min.raan&&(t.min.raan=a[e].raan),a[e].raan>t.max.raan&&(t.max.raan=a[e].raan),t.avg.raan+=a[e].raan,a[e].semiMajorAxis<t.min.semiMajorAxis&&(t.min.semiMajorAxis=a[e].semiMajorAxis),a[e].semiMajorAxis>t.max.semiMajorAxis&&(t.max.semiMajorAxis=a[e].semiMajorAxis),t.avg.semiMajorAxis+=a[e].semiMajorAxis,a[e].ta<t.min.ta&&(t.min.ta=a[e].ta),a[e].ta>t.max.ta&&(t.max.ta=a[e].ta),t.avg.ta+=a[e].ta,a[e].tl<t.min.tl&&(t.min.tl=a[e].tl),a[e].tl>t.max.tl&&(t.max.tl=a[e].tl),t.avg.tl+=a[e].tl;return t.avg.apogee/=a.length,t.avg.argPe/=a.length,t.avg.eccentricity/=a.length,t.avg.inclination/=a.length,t.avg.mo/=a.length,t.avg.perigee/=a.length,t.avg.period/=a.length,t.avg.raan/=a.length,t.avg.semiMajorAxis/=a.length,t.avg.ta/=a.length,t.avg.tl/=a.length,t}),n.iod=(async e=>{const a=n.svs2kps(e);e.sort(function(e,a){return e[0].value-a[0].value});const t=new Date(e[0][0]);return n.fitTles(t,e,a)}),n.fitTles=(async(e,a,t)=>{n.debug.closestApproach=0;const i=settingsManager.fitTleSteps,o=(t.max.inclination,t.min.inclination,(t.max.raan-t.min.raan)/i),r=(t.max.eccentricity,t.min.eccentricity,(t.max.argPe-t.min.argPe)/i),s=(t.max.mo-t.min.mo)/i;t.max.period,t.min.period;let c=[1e7];for(let m=-i/2;m<i/2;m++)for(let l=-i;l<i;l++)for(let g=2*-i;g<2*i;g++){let i={};i.inclination=t.avg.inclination,i.raan=t.avg.raan+o*m,i.eccentricity=t.avg.eccentricity,i.argPe=t.avg.argPe+r*l,i.mo=t.avg.mo+s*g/2,i.period=t.avg.period;const _=n.kp2tle(i,e);let p=0,x=0,h=0,d=0;for(let t=0;t<a.length;t++){const i=await M(_.tle1,_.tle2,new Date(e+(a[t][0]-a[0][0])));p+=Math.abs(i.position.x-a[t][1]),x+=Math.abs(i.position.y-a[t][2]),h+=Math.abs(i.position.z-a[t][3]),d+=Math.sqrt(p**2+x**2+h**2)}(d/=a.length)<c[0]&&(c=[d,m,l,g])}console.log(`Closest Approach: ${c[0]}`),n.debug.closestApproach+=c[0];let m={};return m.inclination=t.avg.inclination,m.raan=t.avg.raan+o*c[1],m.eccentricity=t.avg.eccentricity,m.argPe=t.avg.argPe+r*c[2],m.mo=t.avg.mo+s*c[3],m.period=t.avg.period,n.kp2tle(m,e)}),n.svs2analyst=(async e=>{n.iod(e).then(e=>{satSet.insertNewAnalystSatellite(e.tle1,e.tle2,satSet.getIdFromObjNum(8e4))})}),n.testIod=(()=>{fetch("/metObs.json").then(e=>e.json()).then(e=>{for(let a=0;a<e.length;a++){let t=e[a];omManager.svs2analyst(t)}n.debug.closestApproach/=e.length,console.log(`Average Approach: ${n.debug.closestApproach}`)})}),n.debug={},n.debug.closestApproach=0,window.omManager=n}();
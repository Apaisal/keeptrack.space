importScripts("lib/satellite.js");const PI=Math.PI,TAU=2*PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,GROUND_BUFFER_DISTANCE=45,RADIUS_OF_SUN=695700,STAR_DISTANCE=25e4,MILLISECONDS_PER_DAY=864e5;var satPos,satVel,satInView,satInSun,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1];let globalPropagationRate=1e3,globalPropagationRateMultiplier=1;var geodeticCoords,siteXYZ,sitex,sitey,sitez,slat,slon,clat,clon,azRad,elRad,south,east,zenith,x,y,z,propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now(),selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,isSunlightView=!1,isLowPerf=!1,isResetMarker=!1,isResetInView=!1,isResetSunlight=!1,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};function _lookAnglesToEcf(e,s,a,t,o,n){return(geodeticCoords={}).latitude=t,geodeticCoords.longitude=o,geodeticCoords.height=n,siteXYZ=satellite.geodeticToEcf(geodeticCoords),sitex=siteXYZ.x,sitey=siteXYZ.y,sitez=siteXYZ.z,slat=Math.sin(t),slon=Math.sin(o),clat=Math.cos(t),clon=Math.cos(o),azRad=DEG2RAD*e,elRad=DEG2RAD*s,south=-a*Math.cos(elRad)*Math.cos(azRad),east=a*Math.cos(elRad)*Math.sin(azRad),zenith=a*Math.sin(elRad),{x:x=slat*clon*south+-slon*east+clat*clon*zenith+sitex,y:y=slat*slon*south+clon*east+clat*slon*zenith+sitey,z:z=-clat*south+slat*zenith+sitez}}function propagateCruncher(){propagationRunning=!0;var e=propTime(),s=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds());s+=1.15741e-8*e.getUTCMilliseconds();var a=satellite.gstime(s),t=s;t=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()+1),t+=1.15741e-8*e.getUTCMilliseconds();var o=satellite.gstime(t),n=satCache.length-1;(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(n-=fieldOfViewSetLength);for(var i,r,l,c,h,d,m,b,g,u,f,S,M,P,R,E,v,A,V,x,D,p,C=-1;C<n;){if(satCache[++C].static&&!satCache[C].marker)"Star"==satCache[C].type?(p=_lookAnglesToEcf((p=getStarPosition(e,180,0,satCache[C])).azimuth*RAD2DEG,p.altitude*RAD2DEG,STAR_DISTANCE,0,0,0),(0==satPos[3*C]||satPos[3*C]-p.x<.1&&satPos[3*C]-p.x>-.1)&&(satPos[3*C]=p.x),(0==satPos[3*C+1]||satPos[3*C+1]-p.y<.1&&satPos[3*C+1]-p.y>-.1)&&(satPos[3*C+1]=p.y),(0==satPos[3*C+2]||satPos[3*C+2]-p.z<.1&&satPos[3*C+2]-p.z>-.1)&&(satPos[3*C+2]=p.z)):(g=Math.cos(satCache[C].lat*DEG2RAD),u=Math.sin(satCache[C].lat*DEG2RAD),f=Math.cos(satCache[C].lon*DEG2RAD+a),S=Math.sin(satCache[C].lon*DEG2RAD+a),satPos[3*C]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[C].alt)*g*f,satPos[3*C+1]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[C].alt)*g*S,satPos[3*C+2]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[C].alt)*u),satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0;else if(satCache[C].missile){if(!satCache[C].active)continue;for(R=satCache[C].altList.length,E=0;E<R;E++)if(1*satCache[C].startTime+1e3*E>1*e){M=E;break}g=Math.cos(satCache[C].latList[M]*DEG2RAD),u=Math.sin(satCache[C].latList[M]*DEG2RAD),f=Math.cos(satCache[C].lonList[M]*DEG2RAD+a),S=Math.sin(satCache[C].lonList[M]*DEG2RAD+a),satPos[3*C]=(6371+satCache[C].altList[M])*g*f,satPos[3*C+1]=(6371+satCache[C].altList[M])*g*S,satPos[3*C+2]=(6371+satCache[C].altList[M])*u,M=Math.min(M,R),g=Math.cos(satCache[C].latList[M+1]*DEG2RAD),u=Math.sin(satCache[C].latList[M+1]*DEG2RAD),f=Math.cos(satCache[C].lonList[M+1]*DEG2RAD+o),S=Math.sin(satCache[C].lonList[M+1]*DEG2RAD+o),satVel[3*C]=(6371+satCache[C].altList[M+1])*g*f-satPos[3*C],satVel[3*C+1]=(6371+satCache[C].altList[M+1])*g*S-satPos[3*C+1],satVel[3*C+2]=(6371+satCache[C].altList[M+1])*u-satPos[3*C+2],d=satPos[3*C],m=satPos[3*C+1],b=satPos[3*C+2],i=satellite.eciToEcf({x:d,y:m,z:b},a),satellite.eciToGeodetic({x:d,y:m,z:b},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[C].skip=!0),l=(r=satellite.ecfToLookAngles(sensor.observerGd,i)).azimuth,c=r.elevation,h=r.rangeSat,l*=RAD2DEG,c*=RAD2DEG,satInView[C]=!1,sensor.obsminaz>sensor.obsmaxaz?(l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&h<=sensor.obsmaxrange&&h>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&h<=sensor.obsmaxrange2&&h>=sensor.obsminrange2?satInView[C]=!0:satInView[C]=!1:l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&h<=sensor.obsmaxrange&&h>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&h<=sensor.obsmaxrange2&&h>=sensor.obsminrange2?satInView[C]=!0:satInView[C]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],P=0;P<mSensor.length;P++)if(sensorMarkerArray.push(C),(sensor=mSensor[P]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[C].marker){if(satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Observer"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(D=20,!isShowSurvFence||sensor.volume)if(0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(V=Math.max(sensor.obsminrange,100);V<Math.min(sensor.obsmaxrange,6e4);V+=Math.min(sensor.obsmaxrange,6e4)/30)for(v=sensor.obsminaz,A=sensor.obsminel;A<sensor.obsmaxel;A+=2){x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a);try{satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}catch(e){console.log(e)}}for(V=Math.max(sensor.obsminrange,100);V<Math.min(sensor.obsmaxrange,6e4);V+=Math.min(sensor.obsmaxrange,6e4)/30)for(v=sensor.obsmaxaz,A=sensor.obsminel;A<sensor.obsmaxel;A+=2)x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;if(void 0!==sensor.obsminaz2){for(V=Math.max(sensor.obsminrange2,100);V<Math.min(sensor.obsmaxrange2,6e4);V+=Math.min(sensor.obsmaxrange2,6e4)/30)for(v=sensor.obsminaz2,A=sensor.obsminel2;A<sensor.obsmaxel2;A+=2)x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;for(V=Math.max(sensor.obsminrange2,100);V<Math.min(sensor.obsmaxrange2,6e4);V+=Math.min(sensor.obsmaxrange2,6e4)/30)for(v=sensor.obsmaxaz2,A=sensor.obsminel2;A<sensor.obsmaxel2;A+=2)x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}else for(V=Math.max(sensor.obsminrange,100);V<Math.min(sensor.obsmaxrange,6e4);V+=Math.min(sensor.obsmaxrange,6e4)/30)for(A=sensor.obsmaxel,v=sensor.obsminaz;v<sensor.obsmaxaz;v+=2)x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;for(D=2,V=Math.max(sensor.obsminrange,100);V<Math.min(sensor.obsmaxrange,6e4);V+=Math.min(sensor.obsmaxrange,6e4)/30)for(v=0;v<360;v+=1*D){if(sensor.obsminaz>sensor.obsmaxaz){if(!(v>=sensor.obsminaz||v<=sensor.obsmaxaz))continue}else if(!(v>=sensor.obsminaz&&v<=sensor.obsmaxaz))continue;if(x=satellite.ecfToEci(_lookAnglesToEcf(v,sensor.obsminel,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(void 0!==sensor.obsminaz2)for(D=2,V=Math.max(sensor.obsminrange2,100);V<Math.min(sensor.obsmaxrange2,6e4);V+=Math.min(sensor.obsmaxrange2,6e4)/30)for(v=0;v<360;v+=1*D){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(v>=sensor.obsminaz2||v<=sensor.obsmaxaz2))continue}else if(!(v>=sensor.obsminaz2&&v<=sensor.obsmaxaz2))continue;if(x=satellite.ecfToEci(_lookAnglesToEcf(v,sensor.obsminel2,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(!isShowSurvFence||sensor.volume){for(V=Math.min(sensor.obsmaxrange,6e4),v=0;v<360;v+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(v>=sensor.obsminaz||v<=sensor.obsmaxaz))continue}else if(!(v>=sensor.obsminaz&&v<=sensor.obsmaxaz))continue;for(A=sensor.obsminel;A<sensor.obsmaxel;A+=2){if(x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}if(void 0!==sensor.obsminaz2)for(V=Math.min(sensor.obsmaxrange2,6e4),v=0;v<360;v+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(v>=sensor.obsminaz2||v<=sensor.obsmaxaz2))continue}else if(!(v>=sensor.obsminaz2&&v<=sensor.obsmaxaz2))continue;for(A=sensor.obsminel2;A<sensor.obsmaxel2;A+=2){if(x=satellite.ecfToEci(_lookAnglesToEcf(v,A,V,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=x.x,satPos[3*C+1]=x.y,satPos[3*C+2]=x.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[C].marker){if(isResetSatOverfly&&!0===satCache[C].active){satCache[C].active=!1,satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0;continue}for(snum=0;snum<satelliteSelected.length;snum++)if(-1!==satelliteSelected[snum]){if(!isShowSatOverfly)continue;for(satSelPosX=satPos[3*satelliteSelected[snum]],satSelPosY=satPos[3*satelliteSelected[snum]+1],satSelPosZ=satPos[3*satelliteSelected[snum]+2],satSelPosEcf={x:satSelPosX,y:satSelPosY,z:satSelPosZ},satSelPos=satellite.ecfToEci(satSelPosEcf,a),satSelGeodetic=satellite.eciToGeodetic(satSelPos,a),satHeight=satSelGeodetic.height,satSelPosEarth={longitude:satSelGeodetic.longitude,latitude:satSelGeodetic.latitude,height:1},deltaLatInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLatInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLatInt=2),satelliteSelected.length>1&&(deltaLatInt=2),deltaLat=-60;deltaLat<60;deltaLat+=deltaLatInt)if(lat=Math.max(Math.min(Math.round(satSelGeodetic.latitude*RAD2DEG)+deltaLat,90),-90)*DEG2RAD,!(lat>90))for(deltaLonInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLonInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLonInt=2),satelliteSelected.length>1&&(deltaLonInt=2),deltaLon=0;deltaLon<181;deltaLon+=deltaLonInt){if(long=satSelGeodetic.longitude+deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(r=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),C===n){console.error("Ran out of Markers");continue}satCache[C].active=!0,satPos[3*C]=satSelPosEarth.x,satPos[3*C+1]=satSelPosEarth.y,satPos[3*C+2]=satSelPosEarth.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(0!==deltaLon&&180!==deltaLon){if(long=satSelGeodetic.longitude-deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(r=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),C===n){console.error("Ran out of Markers");continue}satCache[C].active=!0,satPos[3*C]=satSelPosEarth.x,satPos[3*C+1]=satSelPosEarth.y,satPos[3*C+2]=satSelPosEarth.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(90===lat||-90===lat)break}}}}if(isResetSatOverfly=!1,satCache[C].marker)for(;C<n;C++){if(!satCache[C].active){n-=fieldOfViewSetLength;break}satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,satCache[C].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,n-=fieldOfViewSetLength),postMessage({satPos:satPos.buffer,satVel:satVel.buffer,sensorMarkerArray:sensorMarkerArray}),setTimeout(()=>{propagateCruncher()},1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(e,s,a,t,o,n){"use strict";return 367*e-Math.floor(7*(e+Math.floor((s+9)/12))*.25)+Math.floor(275*s/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){"use strict";var e=new Date,s=(Number(e)-Number(propRealTime))*propRate;return e.setTime(Number(propRealTime)+propOffset+s),e}sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd,onmessage=function(e){switch(propRealTime=Date.now(),e.data.isSunlightView&&0==(isSunlightView=e.data.isSunlightView)&&(isResetSunlight=!0),e.data.satelliteSelected&&-1===(satelliteSelected=e.data.satelliteSelected)[0]&&(isResetSatOverfly=!0,0==isResetMarker&&(isResetMarker=!0)),e.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),e.data.isLowPerf&&(isLowPerf=!0),e.data.fieldOfViewSetLength&&(fieldOfViewSetLength=e.data.fieldOfViewSetLength),"enable"===e.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=e.data.selectedSatFOV),"reset"===e.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===e.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===e.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===e.data.isShowSurvFence&&(isShowSurvFence=!0,0==isResetMarker&&(isResetMarker=!0)),"disable"===e.data.isShowSurvFence&&(isShowSurvFence=!1,0==isResetMarker&&(isResetMarker=!0)),e.data.multiSensor?(isMultiSensor=!0,mSensor=e.data.sensor,sensor=e.data.sensor,globalPropagationRate=2e3,0==isResetInView&&(isResetInView=!0)):e.data.sensor&&(sensor=e.data.sensor,e.data.setlatlong&&(e.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={},0==isResetInView&&(isResetInView=!0)):(globalPropagationRate=2e3,sensor.observerGd={longitude:e.data.sensor.long*DEG2RAD,latitude:e.data.sensor.lat*DEG2RAD,height:1*e.data.sensor.obshei},0==isResetInView&&(isResetInView=!0))),isMultiSensor=!1),e.data.typ){case"offset":return propOffset=Number(e.data.dat.split(" ")[0]),propRate=Number(e.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var s=JSON.parse(e.data.dat);len=s.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,s[t].static||s[t].missile?(a=s[t],o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(s[t].TLE1,s[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),satInSun=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),s=null;break;case"satEdit":satCache[e.data.id]=satellite.twoline2satrec(e.data.TLE1,e.data.TLE2),a=satCache[e.data.id],o=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=e.data.TLE1,n.TLE2=e.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:e.data.id});break;case"newMissile":satCache[e.data.id]=e.data}propagationRunning||(len=-1,propagateCruncher())};var sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180;const J1970=2440588,J2000=2451545;function toJulian(e){return e.valueOf()/MILLISECONDS_PER_DAY-.5+J1970}function toDays(e){return toJulian(e)-J2000}function getAzimuth(e,s,a){return atan(sin(e),cos(e)*sin(s)-tan(a)*cos(s))}function getAltitude(e,s,a){return asin(sin(s)*sin(a)+cos(s)*cos(a)*cos(e))}function getSiderealTime(e,s){return rad*(280.16+360.9856235*e)-s}var lw,phi,d,H,h;function getStarPosition(e,s,a,t){return lw=rad*-a,phi=rad*s,d=toDays(e),H=getSiderealTime(d,lw)-t.ra/12*PI,h=getAltitude(H,phi,t.dec/180*PI),h+=.017*rad/tan(h+10.26*rad/(h+5.1*rad)),{azimuth:getAzimuth(H,phi,t.dec/180*PI),altitude:h,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}}
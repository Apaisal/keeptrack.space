var satSensorMarkerArray=[];!function(){var e,t,a,r,i,n,l,o,g,c,u,d=360/(2*Math.PI),h={},f=settingsManager.limitSats,m={},S=mat4.create(),M=-1;try{$("#loader-text").text("Locating ELSETs..."),h=new Worker("js/sat-cruncher.js")}catch(e){browserUnsupported()}var p,v,b,L,A,C,w=0,R=0,F=!1;h.onmessage=function(e){if(!F){for(u=JSON.parse(e.data.extraData),L=0;L<m.numSats;L++)c[L].inclination=u[L].inclination,c[L].eccentricity=u[L].eccentricity,c[L].raan=u[L].raan,c[L].argPe=u[L].argPe,c[L].meanMotion=u[L].meanMotion,c[L].semiMajorAxis=u[L].semiMajorAxis,c[L].semiMinorAxis=u[L].semiMinorAxis,c[L].apogee=u[L].apogee,c[L].perigee=u[L].perigee,c[L].period=u[L].period;return F=!0,void(u=null)}if(e.data.extraUpdate)return u=JSON.parse(e.data.extraData),L=e.data.satId,c[L].inclination=u[0].inclination,c[L].eccentricity=u[0].eccentricity,c[L].raan=u[0].raan,c[L].argPe=u[0].argPe,c[L].meanMotion=u[0].meanMotion,c[L].semiMajorAxis=u[0].semiMajorAxis,c[L].semiMinorAxis=u[0].semiMinorAxis,c[L].apogee=u[0].apogee,c[L].perigee=u[0].perigee,c[L].period=u[0].period,c[L].TLE1=u[0].TLE1,c[L].TLE2=u[0].TLE2,void(u=null);l=new Float32Array(e.data.satPos),o=new Float32Array(e.data.satVel),g=new Int8Array(e.data.satInView),satSensorMarkerArray=e.data.sensorMarkerArray,(settingsManager.isMapMenuOpen||settingsManager.isMapUpdateOverride)&&((R=Date.now())>settingsManager.lastMapUpdateTime+3e4?(uiController.updateMap(),settingsManager.lastMapUpdateTime=R,settingsManager.isMapUpdateOverride=!1):settingsManager.isMapUpdateOverride&&(uiController.updateMap(),settingsManager.lastMapUpdateTime=R,settingsManager.isMapUpdateOverride=!1)),settingsManager.socratesOnSatCruncher&&(selectSat(settingsManager.socratesOnSatCruncher),settingsManager.socratesOnSatCruncher=null),(satellite.sensorSelected()||settingsManager.isForceColorScheme)&&(isDragging||m.setColorScheme(settingsManager.currentColorScheme)),settingsManager.cruncherReady||($("#version-info").html(settingsManager.versionNumber),$("#version-info").tooltip({delay:50,html:settingsManager.versionDate,position:"top"}),""!==f&&$("#menu-satellite-collision").hide(),$("body").attr("style","background:black"),$("#canvas-holder").attr("style","display:block"),settingsManager.isBottomIconsEnabled=!0,mobile.checkMobileMode(),settingsManager.isMobileModeEnabled?($("#mobile-start-button").show(),$("#spinner").hide(),$("#loader-text").html("")):($("#loading-screen").removeClass("full-loader"),$("#loading-screen").addClass("mini-loader-container"),$("#logo-inner-container").addClass("mini-loader"),$("#logo-text").html(""),$("#loader-text").html("Attempting to Math..."),$("#loading-screen").fadeOut()),m.setColorScheme(settingsManager.currentColorScheme),settingsManager.cruncherReady=!0,function(){var e=localStorage.getItem("watchlistList");if(null!==e){var t=JSON.parse(e);watchlistInViewList=[];for(var a=0;a<t.length;a++){var r=m.getSatExtraOnly(m.getIdFromObjNum(t[a]));if(null===r)return void console.error("Watchlist File Format Incorret");t[a]=r.id,watchlistInViewList.push(!1)}uiController.updateWatchlist(t,watchlistInViewList)}}(),$(window).width()>$(window).height()?(settingsManager.mapHeight=$(window).width(),$("#map-image").width(settingsManager.mapHeight),settingsManager.mapHeight=3*settingsManager.mapHeight/4,$("#map-image").height(settingsManager.mapHeight),$("#map-menu").width($(window).width())):(settingsManager.mapHeight=$(window).height()-100,$("#map-image").height(settingsManager.mapHeight),settingsManager.mapHeight=4*settingsManager.mapHeight/3,$("#map-image").width(settingsManager.mapHeight),$("#map-menu").width($(window).width())))},m.changeShaders=function(t){switch(gl.detachShader(e,A),gl.detachShader(e,C),t){case"var":gl.shaderSource(A,shaderLoader.getShaderCode("dot-vertex-var.glsl"));break;case 12:gl.shaderSource(A,shaderLoader.getShaderCode("dot-vertex-12.glsl"));break;case 6:gl.shaderSource(A,shaderLoader.getShaderCode("dot-vertex-6.glsl"));break;case 2:gl.shaderSource(A,shaderLoader.getShaderCode("dot-vertex-2.glsl"))}gl.compileShader(A),gl.shaderSource(C,shaderLoader.getShaderCode("dot-fragment.glsl")),gl.compileShader(C),gl.attachShader(e,A),gl.attachShader(e,C),gl.linkProgram(e),e.aPos=gl.getAttribLocation(e,"aPos"),e.aColor=gl.getAttribLocation(e,"aColor"),e.uMvMatrix=gl.getUniformLocation(e,"uMvMatrix"),e.uCamMatrix=gl.getUniformLocation(e,"uCamMatrix"),e.uPMatrix=gl.getUniformLocation(e,"uPMatrix")},m.init=function(a){if(function(){for(var e=window.location.search.substring(1).split("&"),t=0;t<e.length;t++){"vertShadersSize"===e[t].split("=")[0]&&(settingsManager.vertShadersSize=6,document.getElementById("settings-shaders").checked=!0)}}(),e=gl.createProgram(),A=gl.createShader(gl.VERTEX_SHADER),gl.shaderSource(A,shaderLoader.getShaderCode("dot-vertex-var.glsl")),gl.compileShader(A),C=gl.createShader(gl.FRAGMENT_SHADER),gl.shaderSource(C,shaderLoader.getShaderCode("dot-fragment.glsl")),gl.compileShader(C),gl.attachShader(e,A),gl.attachShader(e,C),gl.linkProgram(e),e.aPos=gl.getAttribLocation(e,"aPos"),e.aColor=gl.getAttribLocation(e,"aColor"),e.uMvMatrix=gl.getUniformLocation(e,"uMvMatrix"),e.uCamMatrix=gl.getUniformLocation(e,"uCamMatrix"),e.uPMatrix=gl.getUniformLocation(e,"uPMatrix"),settingsManager.offline)$.getScript("/offline/extra.js"),$.getScript("/offline/satInfo.js"),$.getScript("/offline/tle.js",function(){n(jsTLEfile)}),jsTLEfile=null;else{var r=settingsManager.tleSource;$.get(r+"?v="+settingsManager.versionNumber).done(function(e){n(e)}).fail(function(){$.getScript("/offline/tle.js",function(){n(jsTLEfile)})}),jsTLEfile=null}function n(e){var r,n,o,g,u,d,S,M,p,v=[];!function(){for(var e=window.location.search.substring(1).split("&"),t=0;t<e.length;t++){var a=e[t].split("=")[0],i=e[t].split("=")[1];switch(a){case"limitSats":f=i,$("#limitSats").val(i),$("#limitSats-Label").addClass("active"),v=i.split(",");break;case"lat":r=i;break;case"long":n=i;break;case"hei":o=i;break;case"minaz":g=i;break;case"maxaz":u=i;break;case"minel":d=i;break;case"maxel":S=i;break;case"minrange":M=i;break;case"maxrange":p=i}}}(),c=function(t){var a,r,i=[];null==t[0]&&(f="");for(var n=0;n<e.length;n++)if(e[n].SCC_NUM=y(e[n].TLE1.substr(2,5).trim(),5),""!==f)for(var l=0;l<t.length;l++)e[n].SCC_NUM===t[l]&&(""===(a=e[n].TLE1.substr(9,8).trim().substring(0,2))?e[n].intlDes="none":(a=(a>50?"19":"20")+a,r=e[n].TLE1.substr(9,8).trim().substring(2),e[n].intlDes=a+"-"+r),e[n].id=n,e[n].active=!0,i.push(e[n]));else""===(a=e[n].TLE1.substr(9,8).trim().substring(0,2))?e[n].intlDes="none":(a=(a>50?"19":"20")+a,r=e[n].TLE1.substr(9,8).trim().substring(2),e[n].intlDes=a+"-"+r),e[n].id=n,e[n].active=!0,i.push(e[n]);var o=!1;if("undefined"!=typeof satelliteList){for(s=0;s<satelliteList.length;s++){for(o=!1,n=0;n<i.length;n++)if(void 0!=satelliteList[s].SCC&&void 0!=satelliteList[s].TLE1&&void 0!=satelliteList[s].TLE2&&i[n].SCC_NUM===satelliteList[s].SCC){i[n].TLE1=satelliteList[s].TLE1,i[n].TLE2=satelliteList[s].TLE2,o=!0;break}if(!o){if(void 0==satelliteList[s].TLE1)continue;if(void 0==satelliteList[s].TLE2)continue;a=((a=satelliteList[s].TLE1.substr(9,8).trim().substring(0,2))>50?"19":"20")+a,r=satelliteList[s].TLE1.substr(9,8).trim().substring(2),extrasSatInfo={static:!1,missile:!1,active:!1,ON:"Unknown",C:"Unknown",LV:"Unknown",LS:"Unknown",SCC_NUM:satelliteList[s].SCC.toString(),TLE1:satelliteList[s].TLE1,TLE2:satelliteList[s].TLE2,intlDes:a+"-"+r,type:"sat",id:i.length},i.push(extrasSatInfo)}}satelliteList=null}if("undefined"!=typeof satInfoList){for(s=0;s<satInfoList.length;s++)for(o=!1,n=s;n<i.length;n++)if(satInfoList[s].SCC===i[n].SCC_NUM){i[n].ON=satInfoList[s].ON,i[n].C=satInfoList[s].C,i[n].LV=satInfoList[s].LV,i[n].LS=satInfoList[s].LS,i[n].URL=satInfoList[s].URL,o=!0;break}satInfoList=null}for(m.orbitalSats=i.length,loggerStop=Date.now(),n=0;n<tleManager.staticSet.length;n++)i.push(tleManager.staticSet[n]);for(n=0;n<tleManager.analSatSet.length;n++)tleManager.analSatSet[n].id=i.length,i.push(tleManager.analSatSet[n]);for(n=0;n<tleManager.missileSet.length;n++)i.push(tleManager.missileSet[n]);for(m.missileSats=i.length,n=0;n<tleManager.fieldOfViewSet.length;n++)tleManager.fieldOfViewSet[n].id=i.length,i.push(tleManager.fieldOfViewSet[n]);return i}(v),e=null,m.satDataString=JSON.stringify(c),timeManager.propRealTime=Date.now(),void 0!==r&&void 0!==n&&void 0!==o&&void 0!==g&&void 0!==u&&void 0!==d&&void 0!==S&&void 0!==M&&void 0!==p&&(satellite.setobs({lat:r,long:n,obshei:o,obsminaz:g,obsmaxaz:u,obsminel:d,obsmaxel:S,obsminrange:M,obsmaxrange:p}),h.postMessage({typ:"offset",dat:timeManager.propOffset.toString()+" "+timeManager.propRate.toString(),setlatlong:!0,lat:r,long:n,obshei:o,obsminaz:g,obsmaxaz:u,obsminel:d,obsmaxel:S,obsminrange:M,obsmaxrange:p})),h.postMessage({typ:"satdata",dat:m.satDataString,fieldOfViewSetLength:tleManager.fieldOfViewSet.length,isLowPerf:settingsManager.lowPerf}),t=gl.createBuffer(),l=new Float32Array(3*c.length);var b=[];i=gl.createBuffer();for(var L=0;L<c.length;L++){var A=L+1&255,C=(L+1&65280)>>8,w=(L+1&16711680)>>16;b.push(A/255),b.push(C/255),b.push(w/255)}gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(b),gl.STATIC_DRAW),m.numSats=c.length,m.setColorScheme(ColorScheme.default,!0),settingsManager.shadersReady=!0,a&&a(c)}},m.getSatData=function(){return c},m.getSatInView=function(){return void 0!==g&&g},m.getSatVel=function(){return void 0!==o&&o},m.setColorScheme=function(e,t){settingsManager.currentColorScheme=e,r=e.calculateColorBuffers(t),a=r.colorBuf,n=r.pickableBuf};var x;function y(e,t){return e.length<t?y("0"+e,t):e}m.draw=function(r,s,g){if(settingsManager.shadersReady&&settingsManager.cruncherReady){if(p=Math.max(timeManager.propRate,.001),v=Math.min((g-w)/1e3,1/p),v*=timeManager.propRate,m.satDataLenInDraw=c.length,!settingsManager.lowPerf)if(settingsManager.isSatOverflyModeOn||settingsManager.isFOVBubbleModeOn)for(m.satDataLenInDraw*=3,b=0;b<m.satDataLenInDraw;b++)l[b]+=o[b]*v;else for(m.satDataLenInDraw-=settingsManager.maxFieldOfViewMarkers,b=0;b<3*m.satDataLenInDraw;b++)l[b]+=o[b]*v;gl.useProgram(e),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.uniformMatrix4fv(e.uMvMatrix,!1,S),gl.uniformMatrix4fv(e.uCamMatrix,!1,s),gl.uniformMatrix4fv(e.uPMatrix,!1,r),gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.bufferData(gl.ARRAY_BUFFER,l,gl.STREAM_DRAW),gl.vertexAttribPointer(e.aPos,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,a),gl.enableVertexAttribArray(e.aColor),gl.vertexAttribPointer(e.aColor,4,gl.FLOAT,!1,0,0),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.enable(gl.BLEND),gl.depthMask(!1),gl.drawArrays(gl.POINTS,0,c.length),gl.depthMask(!0),gl.disable(gl.BLEND),gl.useProgram(gl.pickShaderProgram),gl.bindFramebuffer(gl.FRAMEBUFFER,gl.pickFb),gl.uniformMatrix4fv(gl.pickShaderProgram.uMvMatrix,!1,S),gl.uniformMatrix4fv(gl.pickShaderProgram.uCamMatrix,!1,s),gl.uniformMatrix4fv(gl.pickShaderProgram.uPMatrix,!1,r),gl.enableVertexAttribArray(gl.pickShaderProgram.aColor),gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.vertexAttribPointer(gl.pickShaderProgram.aColor,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,n),gl.enableVertexAttribArray(gl.pickShaderProgram.aPickable),gl.vertexAttribPointer(gl.pickShaderProgram.aPickable,1,gl.FLOAT,!1,0,0),gl.drawArrays(gl.POINTS,0,c.length),w=g}},m.mergeSat=function(e){if(!c)return null;var t=m.getIdFromObjNum(e.SCC);c[t].ON=e.ON,c[t].C=e.C,c[t].LV=e.LV,c[t].LS=e.LS,c[t].R=e.R,c[t].URL=e.URL,c[t].NOTES=e.NOTES,c[t].TTP=e.TTP,c[t].FMISSED=e.FMISSED,c[t].ORPO=e.ORPO,c[t].constellation=e.constellation,c[t].associates=e.associates,c[t].maneuver=e.maneuver},m.setSat=function(e,t){if(!c)return null;c[e]=t},m.getSat=function(e){return c&&c[e]?(F&&(c[e].inViewChange=!1,c[e].inview!==g[e]&&(c[e].inViewChange=!0),c[e].inview=g[e],c[e].velocity=Math.sqrt(o[3*e]*o[3*e]+o[3*e+1]*o[3*e+1]+o[3*e+2]*o[3*e+2]),c[e].velocityX=o[3*e],c[e].velocityY=o[3*e+1],c[e].velocityZ=o[3*e+2],c[e].position={x:l[3*e],y:l[3*e+1],z:l[3*e+2]}),c[e]):null},m.getSatInViewOnly=function(e){return c&&c[e]?(c[e].inview=g[e],c[e]):null},m.getSatPosOnly=function(e){return c&&c[e]?(F&&(c[e].position={x:l[3*e],y:l[3*e+1],z:l[3*e+2]}),c[e]):null},m.getSatExtraOnly=function(e){return c&&c[e]?c[e]:null},m.getIdFromIntlDes=function(e){for(var t=0;t<c.length;t++)if(c[t].intlDes===e)return t;return null},m.getSatFromObjNum=function(e){var t=m.getIdFromObjNum(e);return m.getSat(t)},m.getIdFromObjNum=function(e){for(var t,a=0;a<c.length;a++)if(!c[a].static&&!c[a].missile&&(t=parseInt(c[a].SCC_NUM),parseInt(e)===t))return a;return null},m.getScreenCoords=function(e,t,a,r){satScreenPositionArray.error=!1,r||(r=m.getSatPosOnly(e).position),x=vec4.fromValues(r.x,r.y,r.z,1),vec4.transformMat4(x,x,a),vec4.transformMat4(x,x,t),satScreenPositionArray.x=x[0]/x[3],satScreenPositionArray.y=x[1]/x[3],satScreenPositionArray.z=x[2]/x[3],satScreenPositionArray.x=.5*(satScreenPositionArray.x+1)*window.innerWidth,satScreenPositionArray.y=.5*(1-satScreenPositionArray.y)*window.innerHeight,satScreenPositionArray.x>=0&&satScreenPositionArray.y>=0&&satScreenPositionArray.z>=0&&satScreenPositionArray.z<=1||(satScreenPositionArray.error=!0)},m.searchNameRegex=function(e){for(var t=[],a=0;a<c.length;a++)e.test(c[a].ON)&&t.push(a);return t},m.searchCountryRegex=function(e){for(var t=[],a=0;a<c.length;a++)e.test(c[a].C)&&t.push(a);return t},m.searchAzElRange=function(e,t,a,r,i,n,s,l,o,g,u){var h=!isNaN(parseFloat(e))&&isFinite(e),f=!isNaN(parseFloat(t))&&isFinite(t),m=!isNaN(parseFloat(a))&&isFinite(a),S=!isNaN(parseFloat(r))&&isFinite(r),M=!isNaN(parseFloat(o))&&isFinite(o),p=!isNaN(parseFloat(i))&&isFinite(i),v=!isNaN(parseFloat(n))&&isFinite(n),b=!isNaN(parseFloat(s))&&isFinite(s),L=!isNaN(parseFloat(l))&&isFinite(l),A=!isNaN(parseFloat(g))&&isFinite(g);if(u*=1,f||m||h||S||M){p||(i=5),v||(n=5),b||(s=200),L||(l=1),A||(g=.5);for(var C=[],w=0,R=0;R<c.length;R++)c[R].static||c[R].missile||!c[R].active||(C.push(c[R]),satellite.getTEARR(C[w]),C[w].azimuth=satellite.currentTEARR.azimuth,C[w].elevation=satellite.currentTEARR.elevation,C[w].range=satellite.currentTEARR.range,C[w].inview=satellite.currentTEARR.inview,w++);if(S||M||(C=function(e){for(var t=[],a=0;a<e.length;a++)e[a].inview&&t.push(e[a]);return t}(C)),0!==u&&(C=function(e){for(var t=[],a=0;a<e.length;a++)e[a].OT===u&&t.push(e[a]);return t}(C)),h)C=function(e,t,a){for(var r=[],i=0;i<e.length;i++)e[i].azimuth<a&&e[i].azimuth>t&&r.push(e[i]);return r}(C,(e*=1)-(i*=1),e+i);if(f)C=function(e,t,a){for(var r=[],i=0;i<e.length;i++)e[i].elevation<a&&e[i].elevation>t&&r.push(e[i]);return r}(C,(t*=1)-(n*=1),t+n);if(m)C=function(e,t,a){for(var r=[],i=0;i<e.length;i++)e[i].range<a&&e[i].range>t&&r.push(e[i]);return r}(C,(a*=1)-(s*=1),a+s);if(S)C=function(e,t,a){for(var r=[],i=0;i<e.length;i++)(e[i].inclination*d).toFixed(2)<a&&(e[i].inclination*d).toFixed(2)>t&&r.push(e[i]);return r}(C,(r*=1)-(l*=1),r+l);if(M)C=function(e,t,a){for(var r=[],i=0;i<e.length;i++)e[i].period<a&&e[i].period>t&&r.length<=200&&r.push(e[i]);r.length>=200&&$("#findByLooks-results").text("Limited to 200 Results!");return r}(C,(o*=1)-(g*=1),o+g);var F=[];for(R=0;R<C.length;R++)R<C.length-1?$("#search").val($("#search").val()+C[R].SCC_NUM+","):$("#search").val($("#search").val()+C[R].SCC_NUM),F.push(C[R].SCC_NUM);return searchBox.doSearch($("#search").val()),C}},m.setHover=function(e){e!==M&&(gl.bindBuffer(gl.ARRAY_BUFFER,a),-1!==M&&gl.bufferSubData(gl.ARRAY_BUFFER,4*M*4,new Float32Array(settingsManager.currentColorScheme.colorizer(m.getSat(M)).color)),-1!==e&&gl.bufferSubData(gl.ARRAY_BUFFER,4*e*4,new Float32Array(settingsManager.hoverColor)),M=e)},m.selectSat=function(e){e!==selectedSat&&(adviceList.satelliteSelected(),h.postMessage({satelliteSelected:[e]}),settingsManager.isMobileModeEnabled&&mobile.searchToggle(!1),gl.bindBuffer(gl.ARRAY_BUFFER,a),-1!==selectedSat&&gl.bufferSubData(gl.ARRAY_BUFFER,4*selectedSat*4,new Float32Array(settingsManager.currentColorScheme.colorizer(m.getSat(selectedSat)).color)),-1!==e&&(isSatView=!0,gl.bufferSubData(gl.ARRAY_BUFFER,4*e*4,new Float32Array(settingsManager.selectedColor))),selectedSat=e,satellite.sensorSelected()&&$("#menu-lookangles").removeClass("bmenu-item-disabled"),$("#menu-lookanglesmultisite").removeClass("bmenu-item-disabled"),$("#menu-satview").removeClass("bmenu-item-disabled"),$("#menu-map").removeClass("bmenu-item-disabled"),$("#menu-editSat").removeClass("bmenu-item-disabled"),$("#menu-sat-fov").removeClass("bmenu-item-disabled"),$("#menu-newLaunch").removeClass("bmenu-item-disabled"),$("#menu-breakup").removeClass("bmenu-item-disabled"))},m.onCruncherReady=function(e){settingsManager.cruncherReady&&e()},window.satSet=m,window.satCruncher=h,window.satPos=l}();
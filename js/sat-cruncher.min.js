importScripts("lib/satellite.js");var satPos,satVel,satInView,TAU=2*Math.PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,globalPropagationRate=1e3,globalPropagationRateMultiplier=1,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1],selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,planetariumView=!1,isLowPerf=!1,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now();function _lookAnglesToEcf(e,s,a,o,t,n){var r={};r.latitude=o,r.longitude=t,r.height=n;var i,l,c,b=satellite.geodeticToEcf(r);i=b.x,l=b.y,c=b.z;var m=Math.sin(o),d=Math.sin(t),h=Math.cos(o),g=Math.cos(t),f=DEG2RAD*e,u=DEG2RAD*s,S=-a*Math.cos(u)*Math.cos(f),x=a*Math.cos(u)*Math.sin(f),M=a*Math.sin(u);return{x:m*g*S+-d*x+h*g*M+i,y:m*d*S+g*x+h*d*M+l,z:-h*S+m*M+c}}function propagateCruncher(){propagationRunning=!0;var e=propTime(),s=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds());s+=1.15741e-8*e.getUTCMilliseconds();var a=satellite.gstime(s),o=s;o=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()+1),o+=1.15741e-8*e.getUTCMilliseconds();var t=satellite.gstime(o),n=satCache.length-1;(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(n-=fieldOfViewSetLength);for(var r,i,l,c,b,m,d,h,g,f,u,S,x,M,P,V,v,E,p,G,z,D,A,R,T=-1,C=!1;T<n;){if((p=satCache[++T]).satnum){if(p.skip)continue;if(P=1440*(s-p.jdsatepoch),!1!==(V=satellite.sgp4(p,P))[0]?(satPos[3*T]=V.position.x,satPos[3*T+1]=V.position.y,satPos[3*T+2]=V.position.z,satVel[3*T]=V.velocity.x,satVel[3*T+1]=V.velocity.y,satVel[3*T+2]=V.velocity.z,C||(sensor.observerGd===defaultGd||isMultiSensor?C=!0:(r=satellite.eciToEcf(V.position,a),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,b=i.rangeSat))):(satCache[T].skip=!0,satPos[3*T]=0,satPos[3*T+1]=0,satPos[3*T+2]=0,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,r=0,i=0,l=0,c=0,b=0),satInView[T]=!1,sensor.observerGd!==defaultGd)if(isMultiSensor)for(M=0;M<mSensor.length&&!satInView[T];M++)(sensor=mSensor[M]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},r=satellite.eciToEcf(V.position,a),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,b=i.rangeSat,l*=RAD2DEG,c*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2)&&(satInView[T]=!0):(l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2)&&(satInView[T]=!0);else l*=RAD2DEG,c*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2)&&(satInView[T]=!0):(l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2)&&(satInView[T]=!0)}else if(satCache[T].static&&!satCache[T].marker)g=Math.cos(satCache[T].lat*DEG2RAD),f=Math.sin(satCache[T].lat*DEG2RAD),u=Math.cos(satCache[T].lon*DEG2RAD+a),S=Math.sin(satCache[T].lon*DEG2RAD+a),satPos[3*T]=6371.25*g*u,satPos[3*T+1]=6371.25*g*S,satPos[3*T+2]=6371.25*f,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,g=null,u=null,f=null,S=null;else if(satCache[T].missile){if(!satCache[T].active)continue;for(v=satCache[T].altList.length,E=0;E<v;E++)if(satCache[T].startTime+1e3*E>e){x=E;break}g=Math.cos(satCache[T].latList[x]*DEG2RAD),f=Math.sin(satCache[T].latList[x]*DEG2RAD),u=Math.cos(satCache[T].lonList[x]*DEG2RAD+a),S=Math.sin(satCache[T].lonList[x]*DEG2RAD+a),satPos[3*T]=(6371+satCache[T].altList[x])*g*u,satPos[3*T+1]=(6371+satCache[T].altList[x])*g*S,satPos[3*T+2]=(6371+satCache[T].altList[x])*f,x=Math.min(x,v),g=Math.cos(satCache[T].latList[x+1]*DEG2RAD),f=Math.sin(satCache[T].latList[x+1]*DEG2RAD),u=Math.cos(satCache[T].lonList[x+1]*DEG2RAD+t),S=Math.sin(satCache[T].lonList[x+1]*DEG2RAD+t),satVel[3*T]=(6371+satCache[T].altList[x+1])*g*u-satPos[3*T],satVel[3*T+1]=(6371+satCache[T].altList[x+1])*g*S-satPos[3*T+1],satVel[3*T+2]=(6371+satCache[T].altList[x+1])*f-satPos[3*T+2],m=satPos[3*T],d=satPos[3*T+1],h=satPos[3*T+2],g=null,u=null,f=null,S=null,r=satellite.eciToEcf({x:m,y:d,z:h},a),satellite.eciToGeodetic({x:m,y:d,z:h},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[T].skip=!0),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,b=i.rangeSat,l*=RAD2DEG,c*=RAD2DEG,satInView[T]=!1,sensor.obsminaz>sensor.obsmaxaz?(l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2?satInView[T]=!0:satInView[T]=!1:l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&b<=sensor.obsmaxrange&&b>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&b<=sensor.obsmaxrange2&&b>=sensor.obsminrange2?satInView[T]=!0:satInView[T]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],M=0;M<mSensor.length;M++)if(sensorMarkerArray.push(T),(sensor=mSensor[M]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[T].marker){if(satPos[3*T]=0,satPos[3*T+1]=0,satPos[3*T+2]=0,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===sensor.defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(R=20,!isShowSurvFence||sensor.volume)if(console.log(sensor),0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(D=Math.max(sensor.obsminrange,100);D<Math.min(sensor.obsmaxrange,6e4);D+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=sensor.obsminaz,z=sensor.obsminel;z<sensor.obsmaxel;z+=2)A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++;for(D=Math.max(sensor.obsminrange,100);D<Math.min(sensor.obsmaxrange,6e4);D+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=sensor.obsmaxaz,z=sensor.obsminel;z<sensor.obsmaxel;z+=2)A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++;if(void 0!==sensor.obsminaz2){for(D=Math.max(sensor.obsminrange2,100);D<Math.min(sensor.obsmaxrange2,6e4);D+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=sensor.obsminaz2,z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2)A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++;for(D=Math.max(sensor.obsminrange2,100);D<Math.min(sensor.obsmaxrange2,6e4);D+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=sensor.obsmaxaz2,z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2)A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}}else for(D=Math.max(sensor.obsminrange,100);D<Math.min(sensor.obsmaxrange,6e4);D+=Math.min(sensor.obsmaxrange,6e4)/30)for(z=sensor.obsmaxel,G=sensor.obsminaz;G<sensor.obsmaxaz;G+=2)A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++;for(R=2,D=Math.max(sensor.obsminrange,100);D<Math.min(sensor.obsmaxrange,6e4);D+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=0;G<360;G+=1*R){if(sensor.obsminaz>sensor.obsmaxaz){if(!(G>=sensor.obsminaz||G<=sensor.obsmaxaz))continue}else if(!(G>=sensor.obsminaz&&G<=sensor.obsmaxaz))continue;if(A=satellite.ecfToEci(_lookAnglesToEcf(G,sensor.obsminel,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),T===n){console.error("No More Markers");break}satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}if(void 0!==sensor.obsminaz2)for(R=2,D=Math.max(sensor.obsminrange2,100);D<Math.min(sensor.obsmaxrange2,6e4);D+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=0;G<360;G+=1*R){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(G>=sensor.obsminaz2||G<=sensor.obsmaxaz2))continue}else if(!(G>=sensor.obsminaz2&&G<=sensor.obsmaxaz2))continue;if(A=satellite.ecfToEci(_lookAnglesToEcf(G,sensor.obsminel2,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),T===n){console.error("No More Markers");break}satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}if(!isShowSurvFence||sensor.volume){for(D=Math.min(sensor.obsmaxrange,6e4),G=0;G<360;G+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(G>=sensor.obsminaz||G<=sensor.obsmaxaz))continue}else if(!(G>=sensor.obsminaz&&G<=sensor.obsmaxaz))continue;for(z=sensor.obsminel;z<sensor.obsmaxel;z+=2){if(A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),T===n){console.error("No More Markers");break}satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}}if(void 0!==sensor.obsminaz2)for(D=Math.min(sensor.obsmaxrange2,6e4),G=0;G<360;G+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(G>=sensor.obsminaz2||G<=sensor.obsmaxaz2))continue}else if(!(G>=sensor.obsminaz2&&G<=sensor.obsmaxaz2))continue;for(z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2){if(A=satellite.ecfToEci(_lookAnglesToEcf(G,z,D,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),T===n){console.error("No More Markers");break}satCache[T].active=!0,satPos[3*T]=A.x,satPos[3*T+1]=A.y,satPos[3*T+2]=A.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[T].marker){if(isResetSatOverfly&&!0===satCache[T].active){satCache[T].active=!1,satPos[3*T]=0,satPos[3*T+1]=0,satPos[3*T+2]=0,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0;continue}for(snum=0;snum<satelliteSelected.length;snum++)if(-1!==satelliteSelected[snum]){if(!isShowSatOverfly)continue;for(satSelPosX=satPos[3*satelliteSelected[snum]],satSelPosY=satPos[3*satelliteSelected[snum]+1],satSelPosZ=satPos[3*satelliteSelected[snum]+2],satSelPosEcf={x:satSelPosX,y:satSelPosY,z:satSelPosZ},satSelPos=satellite.ecfToEci(satSelPosEcf,a),satSelGeodetic=satellite.eciToGeodetic(satSelPos,a),satHeight=satSelGeodetic.height,satSelPosEarth={longitude:satSelGeodetic.longitude,latitude:satSelGeodetic.latitude,height:1},deltaLatInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLatInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLatInt=2),satelliteSelected.length>1&&(deltaLatInt=2),deltaLat=-60;deltaLat<60;deltaLat+=deltaLatInt)if(lat=Math.max(Math.min(Math.round(satSelGeodetic.latitude*RAD2DEG)+deltaLat,90),-90)*DEG2RAD,!(lat>90))for(deltaLonInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLonInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLonInt=2),satelliteSelected.length>1&&(deltaLonInt=2),deltaLon=0;deltaLon<181;deltaLon+=deltaLonInt){if(long=satSelGeodetic.longitude+deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(i=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),T===n){console.error("Ran out of Markers");continue}satCache[T].active=!0,satPos[3*T]=satSelPosEarth.x,satPos[3*T+1]=satSelPosEarth.y,satPos[3*T+2]=satSelPosEarth.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}if(0!==deltaLon&&180!==deltaLon){if(long=satSelGeodetic.longitude-deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(i=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),T===n){console.error("Ran out of Markers");continue}satCache[T].active=!0,satPos[3*T]=satSelPosEarth.x,satPos[3*T+1]=satSelPosEarth.y,satPos[3*T+2]=satSelPosEarth.z,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,T++}if(90===lat||-90===lat)break}}}}if(isResetSatOverfly=!1,satCache[T].marker)for(;T<n;T++){if(!satCache[T].active){n-=fieldOfViewSetLength;break}satPos[3*T]=0,satPos[3*T+1]=0,satPos[3*T+2]=0,satVel[3*T]=0,satVel[3*T+1]=0,satVel[3*T+2]=0,satCache[T].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,n-=fieldOfViewSetLength),postMessage({satPos:satPos.buffer,satVel:satVel.buffer,satInView:satInView.buffer,sensorMarkerArray:sensorMarkerArray}),setTimeout(propagateCruncher,1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(e,s,a,o,t,n){"use strict";return 367*e-Math.floor(7*(e+Math.floor((s+9)/12))*.25)+Math.floor(275*s/9)+a+1721013.5+((n/60+t)/60+o)/24}function propTime(){"use strict";var e=new Date,s=(Number(e)-Number(propRealTime))*propRate;return e.setTime(Number(propRealTime)+propOffset+s),e}onmessage=function(e){switch(propRealTime=Date.now(),e.data.planetariumView&&(planetariumView=!0),e.data.nonPlanetariumView&&(planetariumView=!1),e.data.satelliteSelected&&-1===(satelliteSelected=e.data.satelliteSelected)[0]&&(isResetSatOverfly=!0),e.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),e.data.isLowPerf&&(isLowPerf=!0),e.data.fieldOfViewSetLength&&(fieldOfViewSetLength=e.data.fieldOfViewSetLength),"enable"===e.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=e.data.selectedSatFOV),"reset"===e.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1),"enable"===e.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===e.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1),"enable"===e.data.isShowSurvFence&&(isShowSurvFence=!0),"disable"===e.data.isShowSurvFence&&(isShowSurvFence=!1),e.data.multiSensor?(isMultiSensor=!0,mSensor=e.data.sensor,sensor=e.data.sensor,globalPropagationRate=2e3):e.data.sensor&&(sensor=e.data.sensor,e.data.setlatlong&&(e.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={}):(globalPropagationRate=2e3,sensor.observerGd={longitude:e.data.sensor.long*DEG2RAD,latitude:e.data.sensor.lat*DEG2RAD,height:1*e.data.sensor.obshei})),isMultiSensor=!1),e.data.typ){case"offset":return propOffset=Number(e.data.dat.split(" ")[0]),propRate=Number(e.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var s=JSON.parse(e.data.dat);len=s.length;for(var a,o=0,t=[],n={};o<len;)n={},a=null,s[o].static||s[o].missile?(a=s[o],t.push(n),satCache.push(a),o++):(a=satellite.twoline2satrec(s[o].TLE1,s[o].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,t.push(n),satCache.push(a),o++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),postMessage({extraData:JSON.stringify(t)}),s=null;break;case"satEdit":satCache[e.data.id]=satellite.twoline2satrec(e.data.TLE1,e.data.TLE2),a=satCache[e.data.id],t=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*Math.PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=e.data.TLE1,n.TLE2=e.data.TLE2,t.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(t),satId:e.data.id});break;case"newMissile":satCache[e.data.id]=e.data}propagationRunning||(len=-1,propagateCruncher())};
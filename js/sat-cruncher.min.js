importScripts("lib/satellite.js"),importScripts("lib/numeric.js"),importScripts("lib/meuusjs.1.0.3.min.js");var satPos,satVel,satInView,satInSun,TAU=2*Math.PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,RADIUS_OF_SUN=695700,globalPropagationRate=1e3,globalPropagationRateMultiplier=1,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1],selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,planetariumView=!1,isSunlightView=!0,isLowPerf=!1,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now();function _lookAnglesToEcf(s,e,a,t,o,n){var r={};r.latitude=t,r.longitude=o,r.height=n;var i,l,c,h=satellite.geodeticToEcf(r);i=h.x,l=h.y,c=h.z;var m=Math.sin(t),b=Math.sin(o),d=Math.cos(t),u=Math.cos(o),g=DEG2RAD*s,f=DEG2RAD*e,S=-a*Math.cos(f)*Math.cos(g),P=a*Math.cos(f)*Math.sin(g),M=a*Math.sin(f);return{x:m*u*S+-b*P+d*u*M+i,y:m*b*S+u*P+d*b*M+l,z:-d*S+m*M+c}}function propagateCruncher(){propagationRunning=!0;var s=propTime(),e=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds());e+=1.15741e-8*s.getUTCMilliseconds();var a=satellite.gstime(e),t=!1;if(isSunlightView){var o=new A.JulianDay(e),n=A.EclCoord.fromWgs84(0,0,0),r=A.EclCoord.fromWgs84(sensor.observerGd.latitude*RAD2DEG,sensor.observerGd.longitude*RAD2DEG,sensor.observerGd.height),i=A.Solar.topocentricPosition(o,n,!1),l=A.Solar.topocentricPosition(o,r,!1);sunAz=i.hz.az*RAD2DEG+180,sunEl=i.hz.alt*RAD2DEG%360,sunElRel=l.hz.alt*RAD2DEG%360;var c=new A.JulianDay(A.JulianDay.dateToJD(s)).jdJ2000Century();sunG=180*A.Solar.meanAnomaly(c)/Math.PI,sunG%=360,sunR=1.00014-.01671*Math.cos(sunG)-14e-5*Math.cos(2*sunG),sunRange=149597870700*sunR/1e3,sunECI=satellite.ecfToEci(_lookAnglesToEcf(sunAz,sunEl,sunRange,0,0,0),a),t=sensor.observerGd!==defaultGd&&"Optical"===sensor.type&&sunElRel>-6}var h=e;h=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()+1),h+=1.15741e-8*s.getUTCMilliseconds();var m=satellite.gstime(h),b=satCache.length-1;(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(b-=fieldOfViewSetLength);for(var d,u,g,f,S,P,M,E,x,p,v,D,G,V,R,z,C,w,y,T,I,O,L,k,F,U,_,j=-1,N=!1;j<b;){if((y=satCache[++j]).satnum){if(y.skip)continue;if(R=1440*(e-y.jdsatepoch),!1!==(z=satellite.sgp4(y,R))[0]?(satPos[3*j]=z.position.x,satPos[3*j+1]=z.position.y,satPos[3*j+2]=z.position.z,satVel[3*j]=z.velocity.x,satVel[3*j+1]=z.velocity.y,satVel[3*j+2]=z.velocity.z,N||(sensor.observerGd===defaultGd||isMultiSensor?N=!0:(d=satellite.eciToEcf(z.position,a),g=(u=satellite.ecfToLookAngles(sensor.observerGd,d)).azimuth,f=u.elevation,S=u.rangeSat))):(satCache[j].skip=!0,satPos[3*j]=0,satPos[3*j+1]=0,satPos[3*j+2]=0,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,d=0,u=0,g=0,f=0,S=0),satInView[j]=!1,satInSun[j]=2,isSunlightView&&(F=Math.asin(RADIUS_OF_EARTH/Math.sqrt(Math.pow(-satPos[3*j],2)+Math.pow(-satPos[3*j+1],2)+Math.pow(-satPos[3*j+2],2)))*RAD2DEG,U=Math.asin(RADIUS_OF_SUN/Math.sqrt(Math.pow(-satPos[3*j]+sunECI.x,2)+Math.pow(-satPos[3*j+1]+sunECI.y,2)+Math.pow(-satPos[3*j+2]+sunECI.z,2)))*RAD2DEG,_=Math.acos(numeric.dot([-satPos[3*j],-satPos[3*j+1],-satPos[3*j+2]],[-satPos[3*j]+sunECI.x,-satPos[3*j+1]+sunECI.y,-satPos[3*j+2]+sunECI.z])/(Math.sqrt(Math.pow(-satPos[3*j],2)+Math.pow(-satPos[3*j+1],2)+Math.pow(-satPos[3*j+2],2))*Math.sqrt(Math.pow(-satPos[3*j]+sunECI.x,2)+Math.pow(-satPos[3*j+1]+sunECI.y,2)+Math.pow(-satPos[3*j+2]+sunECI.z,2))))*RAD2DEG,F>U&&_<F-U&&(satInSun[j]=0),Math.abs(F-U)<_&&_<F+U&&(satInSun[j]=1),U>F&&(satInSun[j]=1),_<U-F&&(satInSun[j]=1)),sensor.observerGd!==defaultGd&&!t)if(isMultiSensor){for(V=0;V<mSensor.length;V++)if("Optical"!=sensor.type||0!=satInSun[j]){if(satInView[j])break;(sensor=mSensor[V]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},d=satellite.eciToEcf(z.position,a),g=(u=satellite.ecfToLookAngles(sensor.observerGd,d)).azimuth,f=u.elevation,S=u.rangeSat,g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2)&&(satInView[j]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2)&&(satInView[j]=!0)}}else"Optical"==sensor.type&&0==satInSun[j]||(g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2)&&(satInView[j]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2)&&(satInView[j]=!0))}else if(satCache[j].static&&!satCache[j].marker){if("Star"==satCache[j].type){var B=StarCalc.getStarPosition(s,180,0,satCache[j]);B=_lookAnglesToEcf(B.azimuth*RAD2DEG,B.altitude*RAD2DEG,2e5,0,0,0),(0==satPos[3*j]||satPos[3*j]-B.x<.1&&satPos[3*j]-B.x>-.1)&&(satPos[3*j]=B.x),(0==satPos[3*j+1]||satPos[3*j+1]-B.y<.1&&satPos[3*j+1]-B.y>-.1)&&(satPos[3*j+1]=B.y),(0==satPos[3*j+2]||satPos[3*j+2]-B.z<.1&&satPos[3*j+2]-B.z>-.1)&&(satPos[3*j+2]=B.z)}else x=Math.cos(satCache[j].lat*DEG2RAD),p=Math.sin(satCache[j].lat*DEG2RAD),v=Math.cos(satCache[j].lon*DEG2RAD+a),D=Math.sin(satCache[j].lon*DEG2RAD+a),satPos[3*j]=(6371.25+satCache[j].alt)*x*v,satPos[3*j+1]=(6371.25+satCache[j].alt)*x*D,satPos[3*j+2]=(6371.25+satCache[j].alt)*p;satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,x=null,v=null,p=null,D=null}else if(satCache[j].missile){if(!satCache[j].active)continue;for(C=satCache[j].altList.length,w=0;w<C;w++)if(satCache[j].startTime+1e3*w>s){G=w;break}x=Math.cos(satCache[j].latList[G]*DEG2RAD),p=Math.sin(satCache[j].latList[G]*DEG2RAD),v=Math.cos(satCache[j].lonList[G]*DEG2RAD+a),D=Math.sin(satCache[j].lonList[G]*DEG2RAD+a),satPos[3*j]=(6371+satCache[j].altList[G])*x*v,satPos[3*j+1]=(6371+satCache[j].altList[G])*x*D,satPos[3*j+2]=(6371+satCache[j].altList[G])*p,G=Math.min(G,C),x=Math.cos(satCache[j].latList[G+1]*DEG2RAD),p=Math.sin(satCache[j].latList[G+1]*DEG2RAD),v=Math.cos(satCache[j].lonList[G+1]*DEG2RAD+m),D=Math.sin(satCache[j].lonList[G+1]*DEG2RAD+m),satVel[3*j]=(6371+satCache[j].altList[G+1])*x*v-satPos[3*j],satVel[3*j+1]=(6371+satCache[j].altList[G+1])*x*D-satPos[3*j+1],satVel[3*j+2]=(6371+satCache[j].altList[G+1])*p-satPos[3*j+2],P=satPos[3*j],M=satPos[3*j+1],E=satPos[3*j+2],x=null,v=null,p=null,D=null,d=satellite.eciToEcf({x:P,y:M,z:E},a),satellite.eciToGeodetic({x:P,y:M,z:E},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[j].skip=!0),g=(u=satellite.ecfToLookAngles(sensor.observerGd,d)).azimuth,f=u.elevation,S=u.rangeSat,g*=RAD2DEG,f*=RAD2DEG,satInView[j]=!1,sensor.obsminaz>sensor.obsmaxaz?(g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2?satInView[j]=!0:satInView[j]=!1:g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&S<=sensor.obsmaxrange&&S>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&S<=sensor.obsmaxrange2&&S>=sensor.obsminrange2?satInView[j]=!0:satInView[j]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],V=0;V<mSensor.length;V++)if(sensorMarkerArray.push(j),(sensor=mSensor[V]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[j].marker){if(satPos[3*j]=0,satPos[3*j+1]=0,satPos[3*j+2]=0,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===sensor.defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(k=20,!isShowSurvFence||sensor.volume)if(0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=sensor.obsminaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2)L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++;for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=sensor.obsmaxaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2)L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++;if(void 0!==sensor.obsminaz2){for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=sensor.obsminaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++;for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=sensor.obsmaxaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}}else for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(I=sensor.obsmaxel,T=sensor.obsminaz;T<sensor.obsmaxaz;T+=2)L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++;for(k=2,O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=0;T<360;T+=1*k){if(sensor.obsminaz>sensor.obsmaxaz){if(!(T>=sensor.obsminaz||T<=sensor.obsmaxaz))continue}else if(!(T>=sensor.obsminaz&&T<=sensor.obsmaxaz))continue;if(L=satellite.ecfToEci(_lookAnglesToEcf(T,sensor.obsminel,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),j===b){console.error("No More Markers");break}satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}if(void 0!==sensor.obsminaz2)for(k=2,O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=0;T<360;T+=1*k){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(T>=sensor.obsminaz2||T<=sensor.obsmaxaz2))continue}else if(!(T>=sensor.obsminaz2&&T<=sensor.obsmaxaz2))continue;if(L=satellite.ecfToEci(_lookAnglesToEcf(T,sensor.obsminel2,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),j===b){console.error("No More Markers");break}satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}if(!isShowSurvFence||sensor.volume){for(O=Math.min(sensor.obsmaxrange,6e4),T=0;T<360;T+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(T>=sensor.obsminaz||T<=sensor.obsmaxaz))continue}else if(!(T>=sensor.obsminaz&&T<=sensor.obsmaxaz))continue;for(I=sensor.obsminel;I<sensor.obsmaxel;I+=2){if(L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),j===b){console.error("No More Markers");break}satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}}if(void 0!==sensor.obsminaz2)for(O=Math.min(sensor.obsmaxrange2,6e4),T=0;T<360;T+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(T>=sensor.obsminaz2||T<=sensor.obsmaxaz2))continue}else if(!(T>=sensor.obsminaz2&&T<=sensor.obsmaxaz2))continue;for(I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2){if(L=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),j===b){console.error("No More Markers");break}satCache[j].active=!0,satPos[3*j]=L.x,satPos[3*j+1]=L.y,satPos[3*j+2]=L.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[j].marker){if(isResetSatOverfly&&!0===satCache[j].active){satCache[j].active=!1,satPos[3*j]=0,satPos[3*j+1]=0,satPos[3*j+2]=0,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0;continue}for(snum=0;snum<satelliteSelected.length;snum++)if(-1!==satelliteSelected[snum]){if(!isShowSatOverfly)continue;for(satSelPosX=satPos[3*satelliteSelected[snum]],satSelPosY=satPos[3*satelliteSelected[snum]+1],satSelPosZ=satPos[3*satelliteSelected[snum]+2],satSelPosEcf={x:satSelPosX,y:satSelPosY,z:satSelPosZ},satSelPos=satellite.ecfToEci(satSelPosEcf,a),satSelGeodetic=satellite.eciToGeodetic(satSelPos,a),satHeight=satSelGeodetic.height,satSelPosEarth={longitude:satSelGeodetic.longitude,latitude:satSelGeodetic.latitude,height:1},deltaLatInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLatInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLatInt=2),satelliteSelected.length>1&&(deltaLatInt=2),deltaLat=-60;deltaLat<60;deltaLat+=deltaLatInt)if(lat=Math.max(Math.min(Math.round(satSelGeodetic.latitude*RAD2DEG)+deltaLat,90),-90)*DEG2RAD,!(lat>90))for(deltaLonInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLonInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLonInt=2),satelliteSelected.length>1&&(deltaLonInt=2),deltaLon=0;deltaLon<181;deltaLon+=deltaLonInt){if(long=satSelGeodetic.longitude+deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(f=(u=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),j===b){console.error("Ran out of Markers");continue}satCache[j].active=!0,satPos[3*j]=satSelPosEarth.x,satPos[3*j+1]=satSelPosEarth.y,satPos[3*j+2]=satSelPosEarth.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}if(0!==deltaLon&&180!==deltaLon){if(long=satSelGeodetic.longitude-deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(f=(u=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),j===b){console.error("Ran out of Markers");continue}satCache[j].active=!0,satPos[3*j]=satSelPosEarth.x,satPos[3*j+1]=satSelPosEarth.y,satPos[3*j+2]=satSelPosEarth.z,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,j++}if(90===lat||-90===lat)break}}}}if(isResetSatOverfly=!1,satCache[j].marker)for(;j<b;j++){if(!satCache[j].active){b-=fieldOfViewSetLength;break}satPos[3*j]=0,satPos[3*j+1]=0,satPos[3*j+2]=0,satVel[3*j]=0,satVel[3*j+1]=0,satVel[3*j+2]=0,satCache[j].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,b-=fieldOfViewSetLength),postMessage({satPos:satPos.buffer,satVel:satVel.buffer,satInView:satInView.buffer,satInSun:satInSun.buffer,sensorMarkerArray:sensorMarkerArray}),setTimeout(propagateCruncher,1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(s,e,a,t,o,n){"use strict";return 367*s-Math.floor(7*(s+Math.floor((e+9)/12))*.25)+Math.floor(275*e/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){"use strict";var s=new Date,e=(Number(s)-Number(propRealTime))*propRate;return s.setTime(Number(propRealTime)+propOffset+e),s}onmessage=function(s){switch(propRealTime=Date.now(),s.data.planetariumView&&(planetariumView=!0),s.data.nonPlanetariumView&&(planetariumView=!1),s.data.satelliteSelected&&-1===(satelliteSelected=s.data.satelliteSelected)[0]&&(isResetSatOverfly=!0),s.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),s.data.isLowPerf&&(isLowPerf=!0),s.data.fieldOfViewSetLength&&(fieldOfViewSetLength=s.data.fieldOfViewSetLength),"enable"===s.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=s.data.selectedSatFOV),"reset"===s.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1),"enable"===s.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===s.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1),"enable"===s.data.isShowSurvFence&&(isShowSurvFence=!0),"disable"===s.data.isShowSurvFence&&(isShowSurvFence=!1),s.data.multiSensor?(isMultiSensor=!0,mSensor=s.data.sensor,sensor=s.data.sensor,globalPropagationRate=2e3):s.data.sensor&&(sensor=s.data.sensor,s.data.setlatlong&&(s.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={}):(globalPropagationRate=2e3,sensor.observerGd={longitude:s.data.sensor.long*DEG2RAD,latitude:s.data.sensor.lat*DEG2RAD,height:1*s.data.sensor.obshei})),isMultiSensor=!1),s.data.typ){case"offset":return propOffset=Number(s.data.dat.split(" ")[0]),propRate=Number(s.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var e=JSON.parse(s.data.dat);len=e.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,e[t].static||e[t].missile?(a=e[t],o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(e[t].TLE1,e[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),satInSun=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),e=null;break;case"satEdit":satCache[s.data.id]=satellite.twoline2satrec(s.data.TLE1,s.data.TLE2),a=satCache[s.data.id],o=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*Math.PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=s.data.TLE1,n.TLE2=s.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:s.data.id});break;case"newMissile":satCache[s.data.id]=s.data}propagationRunning||(len=-1,propagateCruncher())};var StarCalc={},PI=Math.PI,sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180,dayMs=864e5,J1970=2440588,J2000=2451545;function toJulian(s){return s.valueOf()/dayMs-.5+J1970}function toDays(s){return toJulian(s)-J2000}function getAzimuth(s,e,a){return atan(sin(s),cos(s)*sin(e)-tan(a)*cos(e))}function getAltitude(s,e,a){return asin(sin(e)*sin(a)+cos(e)*cos(a)*cos(s))}function getSiderealTime(s,e){return rad*(280.16+360.9856235*s)-e}StarCalc.getStarPosition=function(s,e,a,t){var o=rad*-a,n=rad*e,r=getSiderealTime(toDays(s),o)-t.ra/12*Math.PI,i=getAltitude(r,n,t.dec/180*Math.PI);return i+=.017*rad/tan(i+10.26*rad/(i+5.1*rad)),{azimuth:getAzimuth(r,n,t.dec/180*Math.PI),altitude:i,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}};
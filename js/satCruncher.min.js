importScripts("lib/satellite.js"),importScripts("lib/numeric.js"),importScripts("lib/meuusjs.1.0.3.min.js");const PI=Math.PI,TAU=2*PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,GROUND_BUFFER_DISTANCE=45,RADIUS_OF_SUN=695700,STAR_DISTANCE=25e4,MILLISECONDS_PER_DAY=864e5;var satPos,satVel,satInView,satInSun,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1];let globalPropagationRate=1e3,globalPropagationRateMultiplier=1;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now(),selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,isSunlightView=!1,isLowPerf=!1,isResetMarker=!1,isResetInView=!1,isResetSunlight=!1;let fieldOfViewSetLength,len,postMessageArray={};var geodeticCoords,siteXYZ,sitex,sitey,sitez,slat,slon,clat,clon,azRad,elRad,south,east,zenith,x,y,z,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};function _lookAnglesToEcf(s,e,a,t,o,n){return(geodeticCoords={}).latitude=t,geodeticCoords.longitude=o,geodeticCoords.height=n,siteXYZ=satellite.geodeticToEcf(geodeticCoords),sitex=siteXYZ.x,sitey=siteXYZ.y,sitez=siteXYZ.z,slat=Math.sin(t),slon=Math.sin(o),clat=Math.cos(t),clon=Math.cos(o),azRad=DEG2RAD*s,elRad=DEG2RAD*e,south=-a*Math.cos(elRad)*Math.cos(azRad),east=a*Math.cos(elRad)*Math.sin(azRad),zenith=a*Math.sin(elRad),{x:x=slat*clon*south+-slon*east+clat*clon*zenith+sitex,y:y=slat*slon*south+clon*east+clat*slon*zenith+sitey,z:z=-clat*south+slat*zenith+sitez}}function propagateCruncher(){propagationRunning=!0;var s=propTime(),e=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds());e+=1.15741e-8*s.getUTCMilliseconds();var a=satellite.gstime(e),t=!1;if(isSunlightView&&!isMultiSensor){var o=new A.JulianDay(e),n=A.EclCoord.fromWgs84(0,0,0),r=A.EclCoord.fromWgs84(sensor.observerGd.latitude*RAD2DEG,sensor.observerGd.longitude*RAD2DEG,sensor.observerGd.height),i=A.Solar.topocentricPosition(o,n,!1),l=A.Solar.topocentricPosition(o,r,!1);sunAz=i.hz.az*RAD2DEG+180,sunEl=i.hz.alt*RAD2DEG%360,sunElRel=l.hz.alt*RAD2DEG%360;var c=new A.JulianDay(A.JulianDay.dateToJD(s)).jdJ2000Century();sunG=180*A.Solar.meanAnomaly(c)/PI,sunG%=360,sunR=1.00014-.01671*Math.cos(sunG)-14e-5*Math.cos(2*sunG),sunRange=149597870700*sunR/1e3,sunECI=satellite.ecfToEci(_lookAnglesToEcf(sunAz,sunEl,sunRange,0,0,0),a),t=sensor.observerGd!==defaultGd&&("Optical"===sensor.type||"Observer"===sensor.type)&&sunElRel>-6}var h=e;h=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()+1),h+=1.15741e-8*s.getUTCMilliseconds();var d=satellite.gstime(h);len=satCache.length-1,(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(len-=fieldOfViewSetLength);for(var b,m,u,g,f,S,M,P,R,E,D,p,x,V,v,G,z,C,w,y,T,I,O,L,k,F,_,U,N=-1,H=!1;N<len;){if((w=satCache[++N]).satnum){if(w.skip)continue;v=1440*(e-w.jdsatepoch),G=satellite.sgp4(w,v);try{satPos[3*N]=G.position.x,satPos[3*N+1]=G.position.y,satPos[3*N+2]=G.position.z,satVel[3*N]=G.velocity.x,satVel[3*N+1]=G.velocity.y,satVel[3*N+2]=G.velocity.z,H||(sensor.observerGd===defaultGd||isMultiSensor?H=!0:(b=satellite.eciToEcf(G.position,a),u=(m=satellite.ecfToLookAngles(sensor.observerGd,b)).azimuth,g=m.elevation,f=m.rangeSat))}catch(s){satCache[N].skip=!0,satPos[3*N]=0,satPos[3*N+1]=0,satPos[3*N+2]=0,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,b=0,m=0,u=0,g=0,f=0}if(satInView[N]=!1,satInSun[N]=2,isSunlightView&&(k=Math.asin(RADIUS_OF_EARTH/Math.sqrt(Math.pow(-satPos[3*N],2)+Math.pow(-satPos[3*N+1],2)+Math.pow(-satPos[3*N+2],2)))*RAD2DEG,F=Math.asin(RADIUS_OF_SUN/Math.sqrt(Math.pow(-satPos[3*N]+sunECI.x,2)+Math.pow(-satPos[3*N+1]+sunECI.y,2)+Math.pow(-satPos[3*N+2]+sunECI.z,2)))*RAD2DEG,_=Math.acos(numeric.dot([-satPos[3*N],-satPos[3*N+1],-satPos[3*N+2]],[-satPos[3*N]+sunECI.x,-satPos[3*N+1]+sunECI.y,-satPos[3*N+2]+sunECI.z])/(Math.sqrt(Math.pow(-satPos[3*N],2)+Math.pow(-satPos[3*N+1],2)+Math.pow(-satPos[3*N+2],2))*Math.sqrt(Math.pow(-satPos[3*N]+sunECI.x,2)+Math.pow(-satPos[3*N+1]+sunECI.y,2)+Math.pow(-satPos[3*N+2]+sunECI.z,2))))*RAD2DEG,k>F&&_<k-F&&(satInSun[N]=0),Math.abs(k-F)<_&&_<k+F&&(satInSun[N]=1),F>k&&(satInSun[N]=1),_<F-k&&(satInSun[N]=1)),sensor.observerGd!==defaultGd&&!t)if(isMultiSensor){for(V=0;V<mSensor.length;V++)if("Optical"!=sensor.type||0!=satInSun[N]){if(satInView[N])break;(sensor=mSensor[V]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei};try{b=satellite.eciToEcf(G.position,a),m=satellite.ecfToLookAngles(sensor.observerGd,b)}catch(s){continue}u=m.azimuth,g=m.elevation,f=m.rangeSat,u*=RAD2DEG,g*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((u>=sensor.obsminaz||u<=sensor.obsmaxaz)&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||(u>=sensor.obsminaz2||u<=sensor.obsmaxaz2)&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2)&&(satInView[N]=!0):(u>=sensor.obsminaz&&u<=sensor.obsmaxaz&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||u>=sensor.obsminaz2&&u<=sensor.obsmaxaz2&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2)&&(satInView[N]=!0)}}else"Optical"==sensor.type&&0==satInSun[N]||(u*=RAD2DEG,g*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((u>=sensor.obsminaz||u<=sensor.obsmaxaz)&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||(u>=sensor.obsminaz2||u<=sensor.obsmaxaz2)&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2)&&(satInView[N]=!0):(u>=sensor.obsminaz&&u<=sensor.obsmaxaz&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||u>=sensor.obsminaz2&&u<=sensor.obsmaxaz2&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2)&&(satInView[N]=!0))}else if(satCache[N].isRadarData){if(satCache[N].skip)continue;satCache[N].skip=!0,satPos[3*N]=0,satPos[3*N+1]=0,satPos[3*N+2]=0,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0}else if(satCache[N].static&&!satCache[N].marker)"Star"==satCache[N].type?(U=_lookAnglesToEcf((U=getStarPosition(s,180,0,satCache[N])).azimuth*RAD2DEG,U.altitude*RAD2DEG,STAR_DISTANCE,0,0,0),(0==satPos[3*N]||satPos[3*N]-U.x<.1&&satPos[3*N]-U.x>-.1)&&(satPos[3*N]=U.x),(0==satPos[3*N+1]||satPos[3*N+1]-U.y<.1&&satPos[3*N+1]-U.y>-.1)&&(satPos[3*N+1]=U.y),(0==satPos[3*N+2]||satPos[3*N+2]-U.z<.1&&satPos[3*N+2]-U.z>-.1)&&(satPos[3*N+2]=U.z)):(R=Math.cos(satCache[N].lat*DEG2RAD),E=Math.sin(satCache[N].lat*DEG2RAD),D=Math.cos(satCache[N].lon*DEG2RAD+a),p=Math.sin(satCache[N].lon*DEG2RAD+a),satPos[3*N]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[N].alt)*R*D,satPos[3*N+1]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[N].alt)*R*p,satPos[3*N+2]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[N].alt)*E),satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0;else if(satCache[N].missile){if(!satCache[N].active)continue;for(z=satCache[N].altList.length,C=0;C<z;C++)if(1*satCache[N].startTime+1e3*C>1*s){x=C;break}R=Math.cos(satCache[N].latList[x]*DEG2RAD),E=Math.sin(satCache[N].latList[x]*DEG2RAD),D=Math.cos(satCache[N].lonList[x]*DEG2RAD+a),p=Math.sin(satCache[N].lonList[x]*DEG2RAD+a),satPos[3*N]=(6371+satCache[N].altList[x])*R*D,satPos[3*N+1]=(6371+satCache[N].altList[x])*R*p,satPos[3*N+2]=(6371+satCache[N].altList[x])*E,x=Math.min(x,z),R=Math.cos(satCache[N].latList[x+1]*DEG2RAD),E=Math.sin(satCache[N].latList[x+1]*DEG2RAD),D=Math.cos(satCache[N].lonList[x+1]*DEG2RAD+d),p=Math.sin(satCache[N].lonList[x+1]*DEG2RAD+d),satVel[3*N]=(6371+satCache[N].altList[x+1])*R*D-satPos[3*N],satVel[3*N+1]=(6371+satCache[N].altList[x+1])*R*p-satPos[3*N+1],satVel[3*N+2]=(6371+satCache[N].altList[x+1])*E-satPos[3*N+2],S=satPos[3*N],M=satPos[3*N+1],P=satPos[3*N+2],b=satellite.eciToEcf({x:S,y:M,z:P},a),satellite.eciToGeodetic({x:S,y:M,z:P},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[N].skip=!0),u=(m=satellite.ecfToLookAngles(sensor.observerGd,b)).azimuth,g=m.elevation,f=m.rangeSat,u*=RAD2DEG,g*=RAD2DEG,satInView[N]=!1,sensor.obsminaz>sensor.obsmaxaz?(u>=sensor.obsminaz||u<=sensor.obsmaxaz)&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||(u>=sensor.obsminaz2||u<=sensor.obsmaxaz2)&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2?satInView[N]=!0:satInView[N]=!1:u>=sensor.obsminaz&&u<=sensor.obsmaxaz&&g>=sensor.obsminel&&g<=sensor.obsmaxel&&f<=sensor.obsmaxrange&&f>=sensor.obsminrange||u>=sensor.obsminaz2&&u<=sensor.obsmaxaz2&&g>=sensor.obsminel2&&g<=sensor.obsmaxel2&&f<=sensor.obsmaxrange2&&f>=sensor.obsminrange2?satInView[N]=!0:satInView[N]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],V=0;V<mSensor.length;V++)if(sensorMarkerArray.push(N),(sensor=mSensor[V]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[N].marker){if(satPos[3*N]=0,satPos[3*N+1]=0,satPos[3*N+2]=0,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Observer"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(L=20,!isShowSurvFence||sensor.volume)if(0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(I=Math.max(sensor.obsminrange,100);I<Math.min(sensor.obsmaxrange,6e4);I+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=sensor.obsminaz,T=sensor.obsminel;T<sensor.obsmaxel;T+=2){O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a);try{satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}catch(s){console.log(s)}}for(I=Math.max(sensor.obsminrange,100);I<Math.min(sensor.obsmaxrange,6e4);I+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=sensor.obsmaxaz,T=sensor.obsminel;T<sensor.obsmaxel;T+=2)O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++;if(void 0!==sensor.obsminaz2){for(I=Math.max(sensor.obsminrange2,100);I<Math.min(sensor.obsmaxrange2,6e4);I+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=sensor.obsminaz2,T=sensor.obsminel2;T<sensor.obsmaxel2;T+=2)O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++;for(I=Math.max(sensor.obsminrange2,100);I<Math.min(sensor.obsmaxrange2,6e4);I+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=sensor.obsmaxaz2,T=sensor.obsminel2;T<sensor.obsmaxel2;T+=2)O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}}else for(I=Math.max(sensor.obsminrange,100);I<Math.min(sensor.obsmaxrange,6e4);I+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=sensor.obsmaxel,y=sensor.obsminaz;y<sensor.obsmaxaz;y+=2)O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++;for(L=2,I=Math.max(sensor.obsminrange,100);I<Math.min(sensor.obsmaxrange,6e4);I+=Math.min(sensor.obsmaxrange,6e4)/30)for(y=0;y<360;y+=1*L){if(sensor.obsminaz>sensor.obsmaxaz){if(!(y>=sensor.obsminaz||y<=sensor.obsmaxaz))continue}else if(!(y>=sensor.obsminaz&&y<=sensor.obsmaxaz))continue;if(O=satellite.ecfToEci(_lookAnglesToEcf(y,sensor.obsminel,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),N===len){console.error("No More Markers");break}satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}if(void 0!==sensor.obsminaz2)for(L=2,I=Math.max(sensor.obsminrange2,100);I<Math.min(sensor.obsmaxrange2,6e4);I+=Math.min(sensor.obsmaxrange2,6e4)/30)for(y=0;y<360;y+=1*L){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(y>=sensor.obsminaz2||y<=sensor.obsmaxaz2))continue}else if(!(y>=sensor.obsminaz2&&y<=sensor.obsmaxaz2))continue;if(O=satellite.ecfToEci(_lookAnglesToEcf(y,sensor.obsminel2,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),N===len){console.error("No More Markers");break}satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}if(!isShowSurvFence||sensor.volume){for(I=Math.min(sensor.obsmaxrange,6e4),y=0;y<360;y+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(y>=sensor.obsminaz||y<=sensor.obsmaxaz))continue}else if(!(y>=sensor.obsminaz&&y<=sensor.obsmaxaz))continue;for(T=sensor.obsminel;T<sensor.obsmaxel;T+=2){if(O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),N===len){console.error("No More Markers");break}satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}}if(void 0!==sensor.obsminaz2)for(I=Math.min(sensor.obsmaxrange2,6e4),y=0;y<360;y+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(y>=sensor.obsminaz2||y<=sensor.obsmaxaz2))continue}else if(!(y>=sensor.obsminaz2&&y<=sensor.obsmaxaz2))continue;for(T=sensor.obsminel2;T<sensor.obsmaxel2;T+=2){if(O=satellite.ecfToEci(_lookAnglesToEcf(y,T,I,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),N===len){console.error("No More Markers");break}satCache[N].active=!0,satPos[3*N]=O.x,satPos[3*N+1]=O.y,satPos[3*N+2]=O.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[N].marker){if(isResetSatOverfly&&!0===satCache[N].active){satCache[N].active=!1,satPos[3*N]=0,satPos[3*N+1]=0,satPos[3*N+2]=0,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0;continue}for(snum=0;snum<satelliteSelected.length;snum++)if(-1!==satelliteSelected[snum]){if(!isShowSatOverfly)continue;for(satSelPosX=satPos[3*satelliteSelected[snum]],satSelPosY=satPos[3*satelliteSelected[snum]+1],satSelPosZ=satPos[3*satelliteSelected[snum]+2],satSelPosEcf={x:satSelPosX,y:satSelPosY,z:satSelPosZ},satSelPos=satellite.ecfToEci(satSelPosEcf,a),satSelGeodetic=satellite.eciToGeodetic(satSelPos,a),satHeight=satSelGeodetic.height,satSelPosEarth={longitude:satSelGeodetic.longitude,latitude:satSelGeodetic.latitude,height:1},deltaLatInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLatInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLatInt=2),satelliteSelected.length>1&&(deltaLatInt=2),deltaLat=-60;deltaLat<60;deltaLat+=deltaLatInt)if(lat=Math.max(Math.min(Math.round(satSelGeodetic.latitude*RAD2DEG)+deltaLat,90),-90)*DEG2RAD,!(lat>90))for(deltaLonInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLonInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLonInt=2),satelliteSelected.length>1&&(deltaLonInt=2),deltaLon=0;deltaLon<181;deltaLon+=deltaLonInt){if(long=satSelGeodetic.longitude+deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(g=(m=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-g*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),N===len){console.error("Ran out of Markers");continue}satCache[N].active=!0,satPos[3*N]=satSelPosEarth.x,satPos[3*N+1]=satSelPosEarth.y,satPos[3*N+2]=satSelPosEarth.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}if(0!==deltaLon&&180!==deltaLon){if(long=satSelGeodetic.longitude-deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(g=(m=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-g*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),N===len){console.error("Ran out of Markers");continue}satCache[N].active=!0,satPos[3*N]=satSelPosEarth.x,satPos[3*N+1]=satSelPosEarth.y,satPos[3*N+2]=satSelPosEarth.z,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,N++}if(90===lat||-90===lat)break}}}}if(isResetSatOverfly=!1,satCache[N].marker)for(;N<len;N++){if(!satCache[N].active){len-=fieldOfViewSetLength;break}satPos[3*N]=0,satPos[3*N+1]=0,satPos[3*N+2]=0,satVel[3*N]=0,satVel[3*N+1]=0,satVel[3*N+2]=0,satCache[N].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,len-=fieldOfViewSetLength),postMessageArray={satPos:satPos.buffer,satVel:satVel.buffer},sensor.observerGd!==defaultGd&&(postMessageArray.satInView=satInView.buffer),isSunlightView&&(postMessageArray.satInSun=satInSun.buffer),sensorMarkerArray.length>1&&(postMessageArray.sensorMarkerArray=sensorMarkerArray),postMessage(postMessageArray),setTimeout(()=>{propagateCruncher()},1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(s,e,a,t,o,n){"use strict";return 367*s-Math.floor(7*(s+Math.floor((e+9)/12))*.25)+Math.floor(275*e/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){"use strict";var s=new Date,e=(Number(s)-Number(propRealTime))*propRate;return s.setTime(Number(propRealTime)+propOffset+e),s}sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd,onmessage=function(s){switch(propRealTime=Date.now(),s.data.isSunlightView&&0==(isSunlightView=s.data.isSunlightView)&&(isResetSunlight=!0),s.data.satelliteSelected&&-1===(satelliteSelected=s.data.satelliteSelected)[0]&&(isResetSatOverfly=!0,0==isResetMarker&&(isResetMarker=!0)),s.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),s.data.isLowPerf&&(isLowPerf=!0),s.data.fieldOfViewSetLength&&(fieldOfViewSetLength=s.data.fieldOfViewSetLength),"enable"===s.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=s.data.selectedSatFOV),"reset"===s.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===s.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowSurvFence&&(isShowSurvFence=!0,0==isResetMarker&&(isResetMarker=!0)),"disable"===s.data.isShowSurvFence&&(isShowSurvFence=!1,0==isResetMarker&&(isResetMarker=!0)),s.data.multiSensor?(isMultiSensor=!0,mSensor=s.data.sensor,sensor=s.data.sensor,globalPropagationRate=2e3,0==isResetInView&&(isResetInView=!0)):s.data.sensor&&(sensor=s.data.sensor,s.data.setlatlong&&(s.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={},0==isResetInView&&(isResetInView=!0)):(globalPropagationRate=2e3,sensor.observerGd={longitude:s.data.sensor.long*DEG2RAD,latitude:s.data.sensor.lat*DEG2RAD,height:1*s.data.sensor.obshei},0==isResetInView&&(isResetInView=!0))),isMultiSensor=!1),s.data.typ){case"offset":return propOffset=Number(s.data.dat.split(" ")[0]),propRate=Number(s.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var e=JSON.parse(s.data.dat);len=e.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,e[t].static||e[t].missile||e[t].isRadarData?(delete(a=e[t]).id,o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(e[t].TLE1,e[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),delete a.id,satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),satInSun=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),e=null;break;case"satEdit":satCache[s.data.id]=satellite.twoline2satrec(s.data.TLE1,s.data.TLE2),a=satCache[s.data.id],o=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=s.data.TLE1,n.TLE2=s.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:s.data.id});break;case"newMissile":satCache[s.data.id]=s.data}propagationRunning||(len=-1,propagateCruncher())};var sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180;const J1970=2440588,J2000=2451545;function toJulian(s){return s.valueOf()/MILLISECONDS_PER_DAY-.5+J1970}function toDays(s){return toJulian(s)-J2000}function getAzimuth(s,e,a){return atan(sin(s),cos(s)*sin(e)-tan(a)*cos(e))}function getAltitude(s,e,a){return asin(sin(e)*sin(a)+cos(e)*cos(a)*cos(s))}function getSiderealTime(s,e){return rad*(280.16+360.9856235*s)-e}var lw,phi,d,H,h;function getStarPosition(s,e,a,t){return lw=rad*-a,phi=rad*e,d=toDays(s),H=getSiderealTime(d,lw)-t.ra/12*PI,h=getAltitude(H,phi,t.dec/180*PI),h+=.017*rad/tan(h+10.26*rad/(h+5.1*rad)),{azimuth:getAzimuth(H,phi,t.dec/180*PI),altitude:h,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}}
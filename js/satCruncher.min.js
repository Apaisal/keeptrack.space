"use strict";importScripts("lib/satellite.js"),importScripts("lib/numeric.js"),importScripts("lib/meuusjs.1.0.3.min.js");const PI=Math.PI,TAU=2*PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,GROUND_BUFFER_DISTANCE=1,RADIUS_OF_SUN=695700,STAR_DISTANCE=25e4,MILLISECONDS_PER_DAY=864e5;var satPos,satVel,satInView,satInSun,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1];let globalPropagationRate=1e3,globalPropagationRateMultiplier=1;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now(),selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,isSunlightView=!1,isLowPerf=!1,isResetMarker=!1,isResetInView=!1,isResetSunlight=!1;let fieldOfViewSetLength,len,postMessageArray={};var geodeticCoords,siteXYZ,sitex,sitey,sitez,slat,slon,clat,clon,azRad,elRad,south,east,zenith,x,y,z,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};function _lookAnglesToEcf(s,e,a,t,o,n){return(geodeticCoords={}).latitude=t,geodeticCoords.longitude=o,geodeticCoords.height=n,siteXYZ=satellite.geodeticToEcf(geodeticCoords),sitex=siteXYZ.x,sitey=siteXYZ.y,sitez=siteXYZ.z,slat=Math.sin(t),slon=Math.sin(o),clat=Math.cos(t),clon=Math.cos(o),azRad=DEG2RAD*s,elRad=DEG2RAD*e,south=-a*Math.cos(elRad)*Math.cos(azRad),east=a*Math.cos(elRad)*Math.sin(azRad),zenith=a*Math.sin(elRad),{x:x=slat*clon*south+-slon*east+clat*clon*zenith+sitex,y:y=slat*slon*south+clon*east+clat*slon*zenith+sitey,z:z=-clat*south+slat*zenith+sitez}}function propagateCruncher(){propagationRunning=!0;var s=propTime(),e=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds());e+=1.15741e-8*s.getUTCMilliseconds();var a=satellite.gstime(e),t=!1;if(isSunlightView&&!isMultiSensor){var o=new A.JulianDay(e),n=A.EclCoord.fromWgs84(0,0,0),r=A.EclCoord.fromWgs84(sensor.observerGd.latitude*RAD2DEG,sensor.observerGd.longitude*RAD2DEG,sensor.observerGd.height),i=A.Solar.topocentricPosition(o,n,!1),l=A.Solar.topocentricPosition(o,r,!1);sunAz=i.hz.az*RAD2DEG+180,sunEl=i.hz.alt*RAD2DEG%360,sunElRel=l.hz.alt*RAD2DEG%360;var c=new A.JulianDay(A.JulianDay.dateToJD(s)).jdJ2000Century();sunG=180*A.Solar.meanAnomaly(c)/PI,sunG%=360,sunR=1.00014-.01671*Math.cos(sunG)-14e-5*Math.cos(2*sunG),sunRange=149597870700*sunR/1e3,sunECI=satellite.ecfToEci(_lookAnglesToEcf(sunAz,sunEl,sunRange,0,0,0),a),t=sensor.observerGd!==defaultGd&&("Optical"===sensor.type||"Observer"===sensor.type)&&sunElRel>-6}var h=e;h=jday(s.getUTCFullYear(),s.getUTCMonth()+1,s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()+1),h+=1.15741e-8*s.getUTCMilliseconds();var d=satellite.gstime(h);len=satCache.length-1,(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(len-=fieldOfViewSetLength);var b=-1;let m,u,g,f,M,S,R,D,p,P,x,E,V,v,z,G,C,w,y,T,I,O,k,F,_,L,U,N,B,j,H,J,Y,q,X,Z,W,K,Q,$,ss,es,as,ts=!1;for(;b<len;){if((y=satCache[++b]).satnum){if(y.skip)continue;z=1440*(e-y.jdsatepoch),G=satellite.sgp4(y,z);try{satPos[3*b]=G.position.x,satPos[3*b+1]=G.position.y,satPos[3*b+2]=G.position.z,satVel[3*b]=G.velocity.x,satVel[3*b+1]=G.velocity.y,satVel[3*b+2]=G.velocity.z,ts||(sensor.observerGd===defaultGd||isMultiSensor?ts=!0:(m=satellite.eciToEcf(G.position,a),g=(u=satellite.ecfToLookAngles(sensor.observerGd,m)).azimuth,f=u.elevation,M=u.rangeSat))}catch(s){satCache[b].skip=!0,satPos[3*b]=0,satPos[3*b+1]=0,satPos[3*b+2]=0,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,m=0,u=0,g=0,f=0,M=0}if(satInView[b]=!1,satInSun[b]=2,isSunlightView&&(_=Math.asin(RADIUS_OF_EARTH/Math.sqrt(Math.pow(-satPos[3*b],2)+Math.pow(-satPos[3*b+1],2)+Math.pow(-satPos[3*b+2],2)))*RAD2DEG,L=Math.asin(RADIUS_OF_SUN/Math.sqrt(Math.pow(-satPos[3*b]+sunECI.x,2)+Math.pow(-satPos[3*b+1]+sunECI.y,2)+Math.pow(-satPos[3*b+2]+sunECI.z,2)))*RAD2DEG,U=Math.acos(numeric.dot([-satPos[3*b],-satPos[3*b+1],-satPos[3*b+2]],[-satPos[3*b]+sunECI.x,-satPos[3*b+1]+sunECI.y,-satPos[3*b+2]+sunECI.z])/(Math.sqrt(Math.pow(-satPos[3*b],2)+Math.pow(-satPos[3*b+1],2)+Math.pow(-satPos[3*b+2],2))*Math.sqrt(Math.pow(-satPos[3*b]+sunECI.x,2)+Math.pow(-satPos[3*b+1]+sunECI.y,2)+Math.pow(-satPos[3*b+2]+sunECI.z,2))))*RAD2DEG,_>L&&U<_-L&&(satInSun[b]=0),Math.abs(_-L)<U&&U<_+L&&(satInSun[b]=1),L>_&&(satInSun[b]=1),U<L-_&&(satInSun[b]=1)),sensor.observerGd!==defaultGd&&!t)if(isMultiSensor){for(v=0;v<mSensor.length;v++)if("Optical"!=sensor.type||0!=satInSun[b]){if(satInView[b])break;(sensor=mSensor[v]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei};try{m=satellite.eciToEcf(G.position,a),u=satellite.ecfToLookAngles(sensor.observerGd,m)}catch(s){continue}g=u.azimuth,f=u.elevation,M=u.rangeSat,g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[b]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[b]=!0)}}else"Optical"==sensor.type&&0==satInSun[b]||(g*=RAD2DEG,f*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[b]=!0):(g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2)&&(satInView[b]=!0))}else if(satCache[b].isRadarData){if(satCache[b].skip)continue;satCache[b].skip=!0,satPos[3*b]=0,satPos[3*b+1]=0,satPos[3*b+2]=0,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0}else if(satCache[b].static&&!satCache[b].marker)"Star"==satCache[b].type?(N=_lookAnglesToEcf((N=getStarPosition(s,180,0,satCache[b])).azimuth*RAD2DEG,N.altitude*RAD2DEG,STAR_DISTANCE,0,0,0),(0==satPos[3*b]||satPos[3*b]-N.x<.1&&satPos[3*b]-N.x>-.1)&&(satPos[3*b]=N.x),(0==satPos[3*b+1]||satPos[3*b+1]-N.y<.1&&satPos[3*b+1]-N.y>-.1)&&(satPos[3*b+1]=N.y),(0==satPos[3*b+2]||satPos[3*b+2]-N.z<.1&&satPos[3*b+2]-N.z>-.1)&&(satPos[3*b+2]=N.z)):(p=Math.cos(satCache[b].lat*DEG2RAD),P=Math.sin(satCache[b].lat*DEG2RAD),x=Math.cos(satCache[b].lon*DEG2RAD+a),E=Math.sin(satCache[b].lon*DEG2RAD+a),satPos[3*b]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[b].alt)*p*x,satPos[3*b+1]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[b].alt)*p*E,satPos[3*b+2]=(RADIUS_OF_EARTH+GROUND_BUFFER_DISTANCE+satCache[b].alt)*P),satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0;else if(satCache[b].missile){if(!satCache[b].active)continue;for(C=satCache[b].altList.length,w=0;w<C;w++)if(1*satCache[b].startTime+1e3*w>1*s){V=w;break}p=Math.cos(satCache[b].latList[V]*DEG2RAD),P=Math.sin(satCache[b].latList[V]*DEG2RAD),x=Math.cos(satCache[b].lonList[V]*DEG2RAD+a),E=Math.sin(satCache[b].lonList[V]*DEG2RAD+a),satPos[3*b]=(6371+satCache[b].altList[V])*p*x,satPos[3*b+1]=(6371+satCache[b].altList[V])*p*E,satPos[3*b+2]=(6371+satCache[b].altList[V])*P,V=Math.min(V,C),p=Math.cos(satCache[b].latList[V+1]*DEG2RAD),P=Math.sin(satCache[b].latList[V+1]*DEG2RAD),x=Math.cos(satCache[b].lonList[V+1]*DEG2RAD+d),E=Math.sin(satCache[b].lonList[V+1]*DEG2RAD+d),satVel[3*b]=(6371+satCache[b].altList[V+1])*p*x-satPos[3*b],satVel[3*b+1]=(6371+satCache[b].altList[V+1])*p*E-satPos[3*b+1],satVel[3*b+2]=(6371+satCache[b].altList[V+1])*P-satPos[3*b+2],S=satPos[3*b],R=satPos[3*b+1],D=satPos[3*b+2],m=satellite.eciToEcf({x:S,y:R,z:D},a),satellite.eciToGeodetic({x:S,y:R,z:D},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[b].skip=!0),g=(u=satellite.ecfToLookAngles(sensor.observerGd,m)).azimuth,f=u.elevation,M=u.rangeSat,g*=RAD2DEG,f*=RAD2DEG,satInView[b]=!1,sensor.obsminaz>sensor.obsmaxaz?(g>=sensor.obsminaz||g<=sensor.obsmaxaz)&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||(g>=sensor.obsminaz2||g<=sensor.obsmaxaz2)&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2?satInView[b]=!0:satInView[b]=!1:g>=sensor.obsminaz&&g<=sensor.obsmaxaz&&f>=sensor.obsminel&&f<=sensor.obsmaxel&&M<=sensor.obsmaxrange&&M>=sensor.obsminrange||g>=sensor.obsminaz2&&g<=sensor.obsmaxaz2&&f>=sensor.obsminel2&&f<=sensor.obsmaxel2&&M<=sensor.obsmaxrange2&&M>=sensor.obsminrange2?satInView[b]=!0:satInView[b]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],v=0;v<mSensor.length;v++)if(sensorMarkerArray.push(b),(sensor=mSensor[v]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[b].marker){if(satPos[3*b]=0,satPos[3*b+1]=0,satPos[3*b+2]=0,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Observer"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(F=20,!isShowSurvFence||sensor.volume)if(0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=sensor.obsminaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2){k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a);try{satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}catch(s){console.log(s)}}for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=sensor.obsmaxaz,I=sensor.obsminel;I<sensor.obsmaxel;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++;if(void 0!==sensor.obsminaz2){for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=sensor.obsminaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++;for(O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=sensor.obsmaxaz2,I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2)k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}}else for(O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(I=sensor.obsmaxel,T=sensor.obsminaz;T<sensor.obsmaxaz;T+=2)k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++;for(F=2,O=Math.max(sensor.obsminrange,100);O<Math.min(sensor.obsmaxrange,6e4);O+=Math.min(sensor.obsmaxrange,6e4)/30)for(T=0;T<360;T+=1*F){if(sensor.obsminaz>sensor.obsmaxaz){if(!(T>=sensor.obsminaz||T<=sensor.obsmaxaz))continue}else if(!(T>=sensor.obsminaz&&T<=sensor.obsmaxaz))continue;if(k=satellite.ecfToEci(_lookAnglesToEcf(T,sensor.obsminel,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),b===len){console.error("No More Markers");break}satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}if(void 0!==sensor.obsminaz2)for(F=2,O=Math.max(sensor.obsminrange2,100);O<Math.min(sensor.obsmaxrange2,6e4);O+=Math.min(sensor.obsmaxrange2,6e4)/30)for(T=0;T<360;T+=1*F){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(T>=sensor.obsminaz2||T<=sensor.obsmaxaz2))continue}else if(!(T>=sensor.obsminaz2&&T<=sensor.obsmaxaz2))continue;if(k=satellite.ecfToEci(_lookAnglesToEcf(T,sensor.obsminel2,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),b===len){console.error("No More Markers");break}satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}if(!isShowSurvFence||sensor.volume){for(O=Math.min(sensor.obsmaxrange,6e4),T=0;T<360;T+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(T>=sensor.obsminaz||T<=sensor.obsmaxaz))continue}else if(!(T>=sensor.obsminaz&&T<=sensor.obsmaxaz))continue;for(I=sensor.obsminel;I<sensor.obsmaxel;I+=2){if(k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),b===len){console.error("No More Markers");break}satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}}if(void 0!==sensor.obsminaz2)for(O=Math.min(sensor.obsmaxrange2,6e4),T=0;T<360;T+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(T>=sensor.obsminaz2||T<=sensor.obsmaxaz2))continue}else if(!(T>=sensor.obsminaz2&&T<=sensor.obsmaxaz2))continue;for(I=sensor.obsminel2;I<sensor.obsmaxel2;I+=2){if(k=satellite.ecfToEci(_lookAnglesToEcf(T,I,O,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),b===len){console.error("No More Markers");break}satCache[b].active=!0,satPos[3*b]=k.x,satPos[3*b+1]=k.y,satPos[3*b+2]=k.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[b].marker){if(isResetSatOverfly&&!0===satCache[b].active){satCache[b].active=!1,satPos[3*b]=0,satPos[3*b+1]=0,satPos[3*b+2]=0,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0;continue}for(B=0;B<satelliteSelected.length;B++)if(-1!==satelliteSelected[B]){if(!isShowSatOverfly)continue;for(X={x:J=satPos[3*satelliteSelected[B]],y:Y=satPos[3*satelliteSelected[B]+1],z:q=satPos[3*satelliteSelected[B]+2]},Z=satellite.ecfToEci(X,a),K=(W=satellite.eciToGeodetic(Z,a)).height,Q={longitude:W.longitude,latitude:W.latitude,height:1},ss=1,K<2500&&selectedSatFOV<=60&&(ss=.5),(K>7e3||selectedSatFOV>=90)&&(ss=2),satelliteSelected.length>1&&(ss=2),$=-60;$<60;$+=ss)if(!((j=Math.max(Math.min(Math.round(W.latitude*RAD2DEG)+$,90),-90)*DEG2RAD)>90))for(as=1,K<2500&&selectedSatFOV<=60&&(as=.5),(K>7e3||selectedSatFOV>=90)&&(as=2),satelliteSelected.length>1&&(as=2),es=0;es<181;es+=as){if(Q={longitude:H=W.longitude+es*DEG2RAD,latitude:j,height:15},(f=(u=satellite.ecfToLookAngles(Q,X)).elevation)*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(Q=satellite.geodeticToEcf(Q),b===len){console.error("Ran out of Markers");continue}satCache[b].active=!0,satPos[3*b]=Q.x,satPos[3*b+1]=Q.y,satPos[3*b+2]=Q.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}if(0!==es&&180!==es){if(Q={longitude:H=W.longitude-es*DEG2RAD,latitude:j,height:15},(f=(u=satellite.ecfToLookAngles(Q,X)).elevation)*RAD2DEG>0&&90-f*RAD2DEG<selectedSatFOV){if(Q=satellite.geodeticToEcf(Q),b===len){console.error("Ran out of Markers");continue}satCache[b].active=!0,satPos[3*b]=Q.x,satPos[3*b+1]=Q.y,satPos[3*b+2]=Q.z,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,b++}if(90===j||-90===j)break}}}}if(isResetSatOverfly=!1,satCache[b].marker)for(;b<len;b++){if(!satCache[b].active){len-=fieldOfViewSetLength;break}satPos[3*b]=0,satPos[3*b+1]=0,satPos[3*b+2]=0,satVel[3*b]=0,satVel[3*b+1]=0,satVel[3*b+2]=0,satCache[b].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,len-=fieldOfViewSetLength),postMessageArray={satPos:satPos,satVel:satVel},sensor.observerGd!==defaultGd&&(postMessageArray.satInView=satInView),isSunlightView&&(postMessageArray.satInSun=satInSun),sensorMarkerArray.length>1&&(postMessageArray.sensorMarkerArray=sensorMarkerArray),postMessage(postMessageArray),setTimeout(()=>{propagateCruncher()},1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(s,e,a,t,o,n){return 367*s-Math.floor(7*(s+Math.floor((e+9)/12))*.25)+Math.floor(275*e/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){var s=new Date,e=(Number(s)-Number(propRealTime))*propRate;return s.setTime(Number(propRealTime)+propOffset+e),s}sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd,onmessage=function(s){switch(propRealTime=Date.now(),s.data.isSunlightView&&0==(isSunlightView=s.data.isSunlightView)&&(isResetSunlight=!0),s.data.satelliteSelected&&-1===(satelliteSelected=s.data.satelliteSelected)[0]&&(isResetSatOverfly=!0,0==isResetMarker&&(isResetMarker=!0)),s.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),s.data.isLowPerf&&(isLowPerf=!0),s.data.fieldOfViewSetLength&&(fieldOfViewSetLength=s.data.fieldOfViewSetLength),"enable"===s.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=s.data.selectedSatFOV),"reset"===s.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===s.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1,0==isResetMarker&&(isResetMarker=!0)),"enable"===s.data.isShowSurvFence&&(isShowSurvFence=!0,0==isResetMarker&&(isResetMarker=!0)),"disable"===s.data.isShowSurvFence&&(isShowSurvFence=!1,0==isResetMarker&&(isResetMarker=!0)),s.data.multiSensor?(isMultiSensor=!0,mSensor=s.data.sensor,sensor=s.data.sensor,globalPropagationRate=2e3,0==isResetInView&&(isResetInView=!0)):s.data.sensor&&(sensor=s.data.sensor,s.data.setlatlong&&(s.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={},0==isResetInView&&(isResetInView=!0)):(globalPropagationRate=2e3,sensor.observerGd={longitude:s.data.sensor.long*DEG2RAD,latitude:s.data.sensor.lat*DEG2RAD,height:1*s.data.sensor.obshei},0==isResetInView&&(isResetInView=!0))),isMultiSensor=!1),s.data.typ){case"offset":return propOffset=Number(s.data.dat.split(" ")[0]),propRate=Number(s.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var e=JSON.parse(s.data.dat);len=e.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,e[t].static||e[t].missile||e[t].isRadarData?(delete(a=e[t]).id,o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(e[t].TLE1,e[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),delete a.id,satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),satInSun=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),e=null;break;case"satEdit":satCache[s.data.id]=satellite.twoline2satrec(s.data.TLE1,s.data.TLE2),a=satCache[s.data.id],o=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=s.data.TLE1,n.TLE2=s.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:s.data.id});break;case"newMissile":satCache[s.data.id]=s.data}propagationRunning||(len=-1,propagateCruncher())};var sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180;const J1970=2440588,J2000=2451545;function toJulian(s){return s.valueOf()/MILLISECONDS_PER_DAY-.5+J1970}function toDays(s){return toJulian(s)-J2000}function getAzimuth(s,e,a){return atan(sin(s),cos(s)*sin(e)-tan(a)*cos(e))}function getAltitude(s,e,a){return asin(sin(e)*sin(a)+cos(e)*cos(a)*cos(s))}function getSiderealTime(s,e){return rad*(280.16+360.9856235*s)-e}var lw,phi,d,H,h;function getStarPosition(s,e,a,t){return lw=rad*-a,phi=rad*e,d=toDays(s),H=getSiderealTime(d,lw)-t.ra/12*PI,h=getAltitude(H,phi,t.dec/180*PI),h+=.017*rad/tan(h+10.26*rad/(h+5.1*rad)),{azimuth:getAzimuth(H,phi,t.dec/180*PI),altitude:h,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}}
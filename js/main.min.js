var gl,pitchRotate,yawRotate,fpsEl,fpsAz,pickFb,pickTex,pickColorBuf,drawLoopCallback,ZOOM_EXP=3,DIST_MIN=6800,DIST_MAX=2e5,TAU=2*Math.PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,RADIUS_OF_SUN=695700,MINUTES_PER_DAY=1440,PLANETARIUM_DIST=3,MILLISECONDS_PER_DAY=1.15741e-8,debugTimeArray=[],timeManager=window.timeManager,satCruncher=window.satCruncher,camYaw=0,camPitch=.5,camYawTarget=0,camPitchTarget=0,camSnapMode=!1,camZoomSnappedOnSat=!1,camAngleSnappedOnSat=!1,zoomLevel=.5,zoomTarget=.5,isZoomIn=!1,camPitchSpeed=0,camYawSpeed=0,camRotateSpeed=0,isEditSatMenuOpen=!1,isDOPMenuOpen=!1,isLookanglesMenuOpen=!1,isLookanglesMultiSiteMenuOpen=!1,isNewLaunchMenuOpen=!1,isBreakupMenuOpen=!1,isMissileMenuOpen=!1,isPlanetariumView=!1,isAstronomyView=!1,isSatView=!1,isVideoRecording=!1,isCustomSensorMenuOpen=!1,pMatrix=mat4.create(),camMatrix=mat4.create(),camMatrixEmpty=mat4.create(),selectedSat=-1,lastSelectedSat=-1,drawLineList=[],updateHoverDelay=0,updateHoverDelayLimit=1,cameraType={current:0,DEFAULT:0,OFFSET:1,FPS:2,PLANETARIUM:3,SATELLITE:4,ASTRONOMY:5},mouseX=0,mouseY=0,mouseTimeout=null,mouseSat=-1,isMouseMoving=!1,dragPoint=[0,0,0],screenDragPoint=[0,0],dragStartPitch=0,dragStartYaw=0,isDragging=!1,dragHasMoved=!1,isPinching=!1,deltaPinchDistance=0,startPinchDistance=0,FPSPitch=0,FPSPitchRate=0,FPSRotate=0,FPSRotateRate=0,FPSYaw=0,FPSYawRate=0,FPSxPos=0,FPSyPos=25e3,FPSzPos=0,FPSForwardSpeed=0,FPSSideSpeed=0,FPSVertSpeed=0,isFPSForwardSpeedLock=!1,isFPSSideSpeedLock=!1,isFPSVertSpeedLock=!1,FPSRun=1,FPSLastTime=1,satScreenPositionArray={},isShowNextPass=!1,isShowDistance=!0,isHoverBoxVisible=!1,rotateTheEarth=!0,rotateTheEarthSpeed=75e-6;function webGlInit(){db.log("webGlInit");var e=$("#canvas")[0];e.width=window.innerWidth,e.height=window.innerHeight;var t=e.getContext("webgl",{alpha:!1,desynchronized:!0})||e.getContext("experimental-webgl",{alpha:!1,desynchronized:!0});t||browserUnsupported(),t.viewport(0,0,e.width,e.height),t.enable(t.DEPTH_TEST);var a=t.createShader(t.FRAGMENT_SHADER),i=shaderLoader.getShaderCode("pick-fragment.glsl");t.shaderSource(a,i),t.compileShader(a);var r=t.createShader(t.VERTEX_SHADER),s=shaderLoader.getShaderCode("pick-vertex.glsl");t.shaderSource(r,s),t.compileShader(r);var n=t.createProgram();t.attachShader(n,r),t.attachShader(n,a),t.linkProgram(n),n.aPos=t.getAttribLocation(n,"aPos"),n.aColor=t.getAttribLocation(n,"aColor"),n.aPickable=t.getAttribLocation(n,"aPickable"),n.uCamMatrix=t.getUniformLocation(n,"uCamMatrix"),n.uMvMatrix=t.getUniformLocation(n,"uMvMatrix"),n.uPMatrix=t.getUniformLocation(n,"uPMatrix"),t.pickShaderProgram=n,pickFb=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,pickFb),pickTex=t.createTexture(),t.bindTexture(t.TEXTURE_2D,pickTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.drawingBufferWidth,t.drawingBufferHeight,0,t.RGBA,t.UNSIGNED_BYTE,null);var o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,t.drawingBufferWidth,t.drawingBufferHeight),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,pickTex,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,o),t.pickFb=pickFb,pickColorBuf=new Uint8Array(4),pMatrix=mat4.create(),mat4.perspective(pMatrix,settingsManager.fieldOfView,t.drawingBufferWidth/t.drawingBufferHeight,20,6e5);mat4.mul(pMatrix,pMatrix,[1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]),window.gl=t}function _getCamDist(){return db.log("_getCamDist",!0),Math.pow(zoomLevel,ZOOM_EXP)*(DIST_MAX-DIST_MIN)+DIST_MIN}function _unProject(e,t){return glScreenX=e/gl.drawingBufferWidth*2-1,glScreenY=1-t/gl.drawingBufferHeight*2,screenVec=[glScreenX,glScreenY,-.01,1],comboPMat=mat4.create(),mat4.mul(comboPMat,pMatrix,camMatrix),invMat=mat4.create(),mat4.invert(invMat,comboPMat),worldVec=vec4.create(),vec4.transformMat4(worldVec,screenVec,invMat),[worldVec[0]/worldVec[3],worldVec[1]/worldVec[3],worldVec[2]/worldVec[3]]}function _normalizeAngle(e){return(e%=TAU)>Math.PI&&(e-=TAU),e<-Math.PI&&(e+=TAU),e}function getSatIdFromCoord(e,t){return gl.bindFramebuffer(gl.FRAMEBUFFER,gl.pickFb),gl.readPixels(e,gl.drawingBufferHeight-t,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pickColorBuf),(pickColorBuf[2]<<16|pickColorBuf[1]<<8|pickColorBuf[0])-1}function getEarthScreenPoint(e,t){return rayOrigin=getCamPos(),ptThru=_unProject(e,t),rayDir=vec3.create(),vec3.subtract(rayDir,ptThru,rayOrigin),vec3.normalize(rayDir,rayDir),toCenterVec=vec3.create(),vec3.scale(toCenterVec,rayOrigin,-1),dParallel=vec3.dot(rayDir,toCenterVec),longDir=vec3.create(),vec3.scale(longDir,rayDir,dParallel),vec3.add(ptThru,rayOrigin,longDir),dPerp=vec3.len(ptThru),dSubSurf=Math.sqrt(RADIUS_OF_EARTH*RADIUS_OF_EARTH-dPerp*dPerp),dSurf=dParallel-dSubSurf,ptSurf=vec3.create(),vec3.scale(ptSurf,rayDir,dSurf),vec3.add(ptSurf,ptSurf,rayOrigin),ptSurf}function getCamPos(){return gCPr=_getCamDist(),gCPz=gCPr*Math.sin(camPitch),gCPrYaw=gCPr*Math.cos(camPitch),gCPx=gCPrYaw*Math.sin(camYaw),gCPy=gCPrYaw*-Math.cos(camYaw),[gCPx,gCPy,gCPz]}function longToYaw(e){var t=$("#datetime-text").text().substr(0,19),a=new Date;t=t.split(" "),t=new Date(t[0]+"T"+t[1]+"Z"),a.setUTCHours(t.getUTCHours()+2*t.getUTCMonth()-10),a.setUTCMinutes(t.getUTCMinutes()),a.setUTCSeconds(t.getUTCSeconds()),t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0);var i=(a-t)/60/60/1e3;return i>24&&(i-=24),_normalizeAngle((e+(i*=15))*DEG2RAD)}function latToPitch(e){var t=e*DEG2RAD;return t>TAU/4&&(t=TAU/4),t<-TAU/4&&(t=-TAU/4),t}function camSnap(e,t){camPitchTarget=e,camYawTarget=_normalizeAngle(t),camSnapMode=!0}function changeZoom(e){zoomTarget="geo"!==e?"leo"!==e?e:.45:.82}function updateUrl(){db.log("updateUrl",!0);var e=window.location.href.split("?")[0],t=[];-1!==selectedSat&&"none"!==satSet.getSatExtraOnly(selectedSat).intlDes&&t.push("intldes="+satSet.getSatExtraOnly(selectedSat).intlDes);var a=searchBox.getCurrentSearch();null!=a&&t.push("search="+a),(timeManager.propRate<.99||timeManager.propRate>1.01)&&t.push("rate="+timeManager.propRate),(timeManager.propOffset<-1e3||timeManager.propOffset>1e3)&&t.push("hrs="+(timeManager.propOffset/1e3/3600).toString()),t.length>0&&(e+="?"+t.join("&")),window.history.replaceState(null,"Keeptrack",e)}!function(){var e,t,a,i,r,s,n,o,l,d,c,m,S,p,g,u,M,P,h;$(document).ready(function(){void 0===settingsManager.tleSource&&(settingsManager.tleSource="TLE.json"),webGlInit(),earth.init(),ColorScheme.init(),satSet.init(function(e){$("#loader-text").text("Coloring Inside the Lines..."),orbitDisplay.init(),groups.init(),searchBox.init(e)}),satSet.onCruncherReady(function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=")[0],r=t[a].split("=")[1];switch(i){case"intldes":var s=satSet.getIdFromIntlDes(r.toUpperCase());null!==s&&selectSat(s);break;case"search":searchBox.doSearch(r),$("#search").val(r);break;case"rate":r=Math.min(r,1e3),r=Math.max(r,0),timeManager.propRate=Number(r),satCruncher.postMessage({typ:"offset",dat:timeManager.propOffset.toString()+" "+timeManager.propRate.toString()});break;case"hrs":timeManager.propOffset=3600*Number(r)*1e3,satCruncher.postMessage({typ:"offset",dat:timeManager.propOffset.toString()+" "+timeManager.propRate.toString()})}}searchBox.init(e),satSet.satDataString=null}),L()});var w=0;function L(){if(requestAnimationFrame(L),t=Date.now(),a=t-(e||t),void 0!==w){if(++w>100)return void(w=null);w>50&&a>500&&settingsManager.isSlowCPUModeEnabled}if(a>20?updateHoverDelayLimit=10:a>50?updateHoverDelayLimit=15:updateHoverDelayLimit>1&&--updateHoverDelayLimit,e=t,timeManager.now=t,isDragging&&!settingsManager.isMobileModeEnabled||isDragging&&settingsManager.isMobileModeEnabled&&(0!==mouseX||0!==mouseY)?(n=getEarthScreenPoint(mouseX,mouseY),isNaN(n[0])||isNaN(n[1])||isNaN(n[2])||isNaN(dragPoint[0])||isNaN(dragPoint[1])||isNaN(dragPoint[2])||cameraType.current===cameraType.FPS||cameraType.current===cameraType.SATELLITE||cameraType.current===cameraType.ASTRONOMY||settingsManager.isMobileModeEnabled?(o=screenDragPoint[0]-mouseX,l=screenDragPoint[1]-mouseY,d=dragStartYaw+o*settingsManager.cameraMovementSpeed,c=dragStartPitch+l*-settingsManager.cameraMovementSpeed,camPitchSpeed=_normalizeAngle(camPitch-c)*-settingsManager.cameraMovementSpeed,camYawSpeed=_normalizeAngle(camYaw-d)*-settingsManager.cameraMovementSpeed):(m=Math.sqrt(dragPoint[0]*dragPoint[0]+dragPoint[1]*dragPoint[1]),S=Math.sqrt(n[0]*n[0]+n[1]*n[1]),p=Math.atan2(dragPoint[1],dragPoint[0]),g=Math.atan2(n[1],n[0]),u=Math.atan2(dragPoint[2],m),M=Math.atan2(n[2],S),P=u-M,h=_normalizeAngle(p-g),camPitchSpeed=P*settingsManager.cameraMovementSpeed,camYawSpeed=h*settingsManager.cameraMovementSpeed),camSnapMode=!1):settingsManager.isMobileModeEnabled?settingsManager.isMobileModeEnabled&&(camPitchSpeed-=camPitchSpeed*a*settingsManager.cameraMovementSpeed*5,camYawSpeed-=camYawSpeed*a*settingsManager.cameraMovementSpeed*5):(camPitchSpeed-=camPitchSpeed*a*settingsManager.cameraMovementSpeed,camYawSpeed-=camYawSpeed*a*settingsManager.cameraMovementSpeed),camRotateSpeed-=camRotateSpeed*a*settingsManager.cameraMovementSpeed,cameraType.current===cameraType.FPS||cameraType.current===cameraType.SATELLITE||cameraType.current===cameraType.ASTRONOMY?(FPSYaw-=20*camYawSpeed*a,FPSRotate-=20*camRotateSpeed*a,(FPSPitch-=20*camPitchSpeed*a)>90&&(FPSPitch=90),FPSPitch<-90&&(FPSPitch=-90),cameraType.current===cameraType.ASTRONOMY?(FPSRotate>90&&(FPSRotate=90),FPSRotate<-90&&(FPSRotate=-90)):(FPSRotate>360&&(FPSRotate-=360),FPSRotate<0&&(FPSRotate+=360)),FPSYaw>360&&(FPSYaw-=360),FPSYaw<0&&(FPSYaw+=360)):(camPitch+=camPitchSpeed*a,camYaw+=camYawSpeed*a,FPSRotate+=camRotateSpeed*a),rotateTheEarth&&(camYaw-=rotateTheEarthSpeed*a),camSnapMode){camPitch+=.003*(camPitchTarget-camPitch)*a;let e=_normalizeAngle(camYawTarget-camYaw);camYaw+=.003*e*a,zoomLevel+=(zoomTarget-zoomLevel)*a*.0025}else isZoomIn?zoomLevel-=zoomLevel*a/100*Math.abs(zoomTarget-zoomLevel):zoomLevel+=zoomLevel*a/100*Math.abs(zoomTarget-zoomLevel),(zoomLevel>=zoomTarget&&!isZoomIn||zoomLevel<=zoomTarget&&isZoomIn)&&(zoomLevel=zoomTarget);if(camPitch>TAU/4&&(camPitch=TAU/4),camPitch<-TAU/4&&(camPitch=-TAU/4),camYaw=_normalizeAngle(camYaw),-1!==selectedSat){let e=satSet.getSat(selectedSat);e.static||function(e){if(camAngleSnappedOnSat){var t=e.position,a=Math.sqrt(t.x*t.x+t.y*t.y),i=Math.atan2(t.y,t.x)+TAU/4,r=Math.atan2(t.z,a);r||(console.warn("Pitch Calculation Error"),r=0,camZoomSnappedOnSat=!1,camAngleSnappedOnSat=!1),i||(console.warn("Yaw Calculation Error"),i=0,camZoomSnappedOnSat=!1,camAngleSnappedOnSat=!1),cameraType.current===cameraType.PLANETARIUM||camSnap(r,i)}if(camZoomSnappedOnSat){var s,n;e.missile||e.static||!e.active||(satellite.getTEARR(e),s=satellite.currentTEARR.alt),e.missile&&(s=e.maxAlt+1e3,orbitDisplay.setSelectOrbit(e.satId)),s?n=s+RADIUS_OF_EARTH+settingsManager.camDistBuffer:(n=RADIUS_OF_EARTH+settingsManager.camDistBuffer,console.warn("Zoom Calculation Error: "+s+" -- "+n),camZoomSnappedOnSat=!1,camAngleSnappedOnSat=!1),Math.pow((n-DIST_MIN)/(DIST_MAX-DIST_MIN),1/ZOOM_EXP)<zoomTarget&&(zoomTarget=Math.pow((n-DIST_MIN)/(DIST_MAX-DIST_MIN),1/ZOOM_EXP))}cameraType.current===cameraType.PLANETARIUM&&(zoomTarget=.01)}(e),e.static&&(cameraType.current,cameraType.PLANETARIUM)}!function(){gl.bindFramebuffer(gl.FRAMEBUFFER,gl.pickFb),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,null),(cameraType.current===cameraType.FPS||cameraType.current===cameraType.SATELLITE||cameraType.current===cameraType.ASTRONOMY)&&function(){r=Date.now(),0!==FPSLastTime&&(s=r-FPSLastTime,isFPSForwardSpeedLock&&FPSForwardSpeed<0?FPSForwardSpeed=Math.max(FPSForwardSpeed+Math.min(-1.02*FPSForwardSpeed*s,-.2),-settingsManager.FPSForwardSpeed):isFPSForwardSpeedLock&&FPSForwardSpeed>0&&(FPSForwardSpeed=Math.min(FPSForwardSpeed+Math.max(1.02*FPSForwardSpeed*s,.2),settingsManager.FPSForwardSpeed)),isFPSSideSpeedLock&&FPSSideSpeed<0?FPSSideSpeed=Math.max(FPSSideSpeed+Math.min(-1.02*FPSSideSpeed*s,-.2),-settingsManager.FPSSideSpeed):isFPSSideSpeedLock&&FPSSideSpeed<0&&(FPSSideSpeed=Math.min(FPSSideSpeed+Math.max(1.02*FPSSideSpeed*s,.2),settingsManager.FPSSideSpeed)),isFPSVertSpeedLock&&FPSVertSpeed<0?FPSVertSpeed=Math.max(FPSVertSpeed+Math.min(-1.02*FPSVertSpeed*s,-.2),-settingsManager.FPSVertSpeed):isFPSVertSpeedLock&&FPSVertSpeed<0&&(FPSVertSpeed=Math.min(FPSVertSpeed+Math.max(1.02*FPSVertSpeed*s,.2),settingsManager.FPSVertSpeed)),cameraType.FPS&&(0!==FPSForwardSpeed&&(FPSxPos-=Math.sin(FPSYaw*DEG2RAD)*FPSForwardSpeed*FPSRun*s,FPSyPos-=Math.cos(FPSYaw*DEG2RAD)*FPSForwardSpeed*FPSRun*s,FPSzPos+=Math.sin(FPSPitch*DEG2RAD)*FPSForwardSpeed*FPSRun*s),0!==FPSVertSpeed&&(FPSzPos-=FPSVertSpeed*FPSRun*s),0!==FPSSideSpeed&&(FPSxPos-=Math.cos(-FPSYaw*DEG2RAD)*FPSSideSpeed*FPSRun*s,FPSyPos-=Math.sin(-FPSYaw*DEG2RAD)*FPSSideSpeed*FPSRun*s)),isFPSForwardSpeedLock||(FPSForwardSpeed*=Math.min(.98*s,.98)),isFPSSideSpeedLock||(FPSSideSpeed*=Math.min(.98*s,.98)),isFPSVertSpeedLock||(FPSVertSpeed*=Math.min(.98*s,.98)),FPSForwardSpeed<.01&&FPSForwardSpeed>-.01&&(FPSForwardSpeed=0),FPSSideSpeed<.01&&FPSSideSpeed>-.01&&(FPSSideSpeed=0),FPSVertSpeed<.01&&FPSVertSpeed>-.01&&(FPSVertSpeed=0),FPSPitch+=FPSPitchRate*s,FPSRotate+=FPSRotateRate*s,FPSYaw+=FPSYawRate*s);FPSLastTime=r}();camMatrix=function(){camMatrix=camMatrixEmpty,mat4.identity(camMatrix),(isNaN(camPitch)||isNaN(camYaw)||isNaN(camPitchTarget)||isNaN(camYawTarget)||isNaN(zoomLevel)||isNaN(zoomTarget))&&(camPitch=.5,camYaw=.5,zoomLevel=.5,camPitchTarget=0,camYawTarget=0,zoomTarget=.5,console.error("Camera Math Error - Camera Reset"));switch(cameraType.current){case cameraType.DEFAULT:mat4.translate(camMatrix,camMatrix,[0,_getCamDist(),0]),mat4.rotateX(camMatrix,camMatrix,camPitch),mat4.rotateZ(camMatrix,camMatrix,-camYaw);break;case cameraType.OFFSET:mat4.translate(camMatrix,camMatrix,[15e3,_getCamDist(),-6e3]),mat4.rotateX(camMatrix,camMatrix,camPitch),mat4.rotateZ(camMatrix,camMatrix,-camYaw);break;case cameraType.FPS:mat4.rotate(camMatrix,camMatrix,-FPSPitch*DEG2RAD,[1,0,0]),mat4.rotate(camMatrix,camMatrix,FPSYaw*DEG2RAD,[0,0,1]),mat4.translate(camMatrix,camMatrix,[FPSxPos,FPSyPos,-FPSzPos]);break;case cameraType.PLANETARIUM:{let e=T({});pitchRotate=-1*satellite.currentSensor.lat*DEG2RAD,yawRotate=(90-satellite.currentSensor.long)*DEG2RAD-e.gmst,mat4.rotate(camMatrix,camMatrix,pitchRotate,[1,0,0]),mat4.rotate(camMatrix,camMatrix,yawRotate,[0,0,1]),mat4.translate(camMatrix,camMatrix,[-e.x,-e.y,-e.z]),y();break}case cameraType.SATELLITE:{-1!==selectedSat&&(lastSelectedSat=selectedSat);let e=satSet.getSat(lastSelectedSat);mat4.rotate(camMatrix,camMatrix,-FPSPitch*DEG2RAD,[1,0,0]),mat4.rotate(camMatrix,camMatrix,FPSYaw*DEG2RAD,[0,0,1]),mat4.rotate(camMatrix,camMatrix,FPSRotate*DEG2RAD,[0,1,0]),orbitDisplay.updateOrbitBuffer(lastSelectedSat);let t=e.position;mat4.translate(camMatrix,camMatrix,[-t.x,-t.y,-t.z]);break}case cameraType.ASTRONOMY:{let e=T({});pitchRotate=-1*satellite.currentSensor.lat*DEG2RAD,yawRotate=(90-satellite.currentSensor.long)*DEG2RAD-e.gmst;let t=null;if(void 0===satellite.currentSensor.name){if(null==(t=satSet.getIdFromSensorName(satellite.currentSensor.name)))return}else t=satSet.getSat(satSet.getIdFromSensorName(satellite.currentSensor.name));mat4.rotate(camMatrix,camMatrix,pitchRotate+-FPSPitch*DEG2RAD,[1,0,0]),mat4.rotate(camMatrix,camMatrix,yawRotate+FPSYaw*DEG2RAD,[0,0,1]),mat4.rotate(camMatrix,camMatrix,FPSRotate*DEG2RAD,[0,1,0]);let a=t.position;FPSxPos=a.x,FPSyPos=a.y,FPSzPos=a.z,mat4.translate(camMatrix,camMatrix,[1.01*-a.x,1.01*-a.y,1.01*-a.z]),y();break}}return camMatrix}(),gl.useProgram(gl.pickShaderProgram),gl.uniformMatrix4fv(gl.pickShaderProgram.uPMatrix,!1,pMatrix),gl.uniformMatrix4fv(gl.pickShaderProgram.camMatrix,!1,camMatrix),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),earth.draw(pMatrix,camMatrix),satSet.draw(pMatrix,camMatrix,t),orbitDisplay.draw(pMatrix,camMatrix)}(),drawLines(),function(){if(searchBox.isHovering())i=searchBox.getHoverSat(),satSet.getScreenCoords(i,pMatrix,camMatrix),e=satScreenPositionArray.x,t=satScreenPositionArray.y,gl.bindFramebuffer(gl.FRAMEBUFFER,gl.pickFb),gl.readPixels(e,gl.drawingBufferHeight-t,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pickColorBuf),0!==pickColorBuf[0]||0!==pickColorBuf[1]||0!==pickColorBuf[2]?D(i,satScreenPositionArray.x,satScreenPositionArray.y):D(-1,0,0);else{if(!isMouseMoving||isDragging||settingsManager.isMobileModeEnabled)return;++updateHoverDelay>=updateHoverDelayLimit&&(updateHoverDelay=0,mouseSat=getSatIdFromCoord(mouseX,mouseY)),-1!==mouseSat?orbitDisplay.setHoverOrbit(mouseSat):orbitDisplay.clearHoverOrbit(),satSet.setHover(mouseSat),D(mouseSat,mouseX,mouseY)}var e,t}(),function(e){if(void 0===e)return;e()}(drawLoopCallback),settingsManager.isDemoModeOn&&function(){if(!satellite.sensorSelected())return;if(t-R<settingsManager.demoModeInterval)return;R=t,E===satSet.getSatData().length&&(E=0);for(var e=E;e<satSet.getSatData().length;e++){var a=satSet.getSat(e);if(!a.static&&!(a.missile||1===a.OT&&!1===ColorScheme.objectTypeFlags.payload||2===a.OT&&!1===ColorScheme.objectTypeFlags.rocketBody||3===a.OT&&!1===ColorScheme.objectTypeFlags.debris||a.inview&&!1===ColorScheme.objectTypeFlags.inFOV||(satSet.getScreenCoords(e,pMatrix,camMatrix),satScreenPositionArray.error||void 0===satScreenPositionArray.x||void 0===satScreenPositionArray.y||satScreenPositionArray.x>window.innerWidth||satScreenPositionArray.y>window.innerHeight)))return D(e,satScreenPositionArray.x,satScreenPositionArray.y),orbitDisplay.setSelectOrbit(e),void(E=e+1)}}(),settingsManager.isSatLabelModeOn&&cameraType.current===cameraType.PLANETARIUM||(f&&$("#sat-minibox").html(""),f=!1)}function T(e){var t,a,i,r,s,n,o=timeManager.propTime(),l=(t=o.getUTCFullYear(),a=o.getUTCMonth()+1,i=o.getUTCDate(),r=o.getUTCHours(),s=o.getUTCMinutes(),n=o.getUTCSeconds(),367*t-Math.floor(7*(t+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+i+1721013.5+((n/60+s)/60+r)/24);l+=1.15741e-8*o.getUTCMilliseconds();var d=satellite.gstime(l),c=Math.cos(satellite.currentSensor.lat*DEG2RAD),m=Math.sin(satellite.currentSensor.lat*DEG2RAD),S=Math.cos(satellite.currentSensor.long*DEG2RAD+d),p=Math.sin(satellite.currentSensor.long*DEG2RAD+d);return e.x=(RADIUS_OF_EARTH+PLANETARIUM_DIST)*c*S,e.y=(RADIUS_OF_EARTH+PLANETARIUM_DIST)*c*p,e.z=(RADIUS_OF_EARTH+PLANETARIUM_DIST)*m,e.gmst=d,e}var F,x,v=0,f=!1,b=[];function y(){if(!settingsManager.isSatLabelModeOn||cameraType.current!==cameraType.PLANETARIUM)return f&&$("#sat-minibox").html(""),void(f=!1);if(satellite.sensorSelected()&&!(t-v<settingsManager.satLabelInterval)){var e;orbitDisplay.clearInViewOrbit(),F=0,isHoverBoxVisible=!0,(b=document.getElementById("sat-minibox")).innerHTML="";for(var a=0;a<satSet.orbitalSats&&F<settingsManager.maxLabels;a++)(e=satSet.getSatPosOnly(a)).static||e.missile||1===e.OT&&!1===ColorScheme.objectTypeFlags.payload||2===e.OT&&!1===ColorScheme.objectTypeFlags.rocketBody||3===e.OT&&!1===ColorScheme.objectTypeFlags.debris||e.inview&&!1===ColorScheme.objectTypeFlags.inFOV||(satSet.getScreenCoords(a,pMatrix,camMatrix,e.position),satScreenPositionArray.error||void 0!==satScreenPositionArray.x&&void 0!==satScreenPositionArray.y&&(satScreenPositionArray.x>window.innerWidth||satScreenPositionArray.y>window.innerHeight||(orbitDisplay.addInViewOrbit(a),(x=document.createElement("div")).id="sat-minibox-"+a,x.textContent=e.SCC_NUM,x.setAttribute("style","display: block; position: absolute; left: "+satScreenPositionArray.x+"10px; top: "+satScreenPositionArray.y+"px;"),b.appendChild(x),F++)));f=!0,v=t}}function D(e,t,a){if(cameraType.current===cameraType.PLANETARIUM&&!settingsManager.isDemoModeOn)return satHoverBoxDOM.css({display:"none"}),void(-1===e?canvasDOM.css({cursor:"default"}):canvasDOM.css({cursor:"pointer"}));if(-1===e){if(!isHoverBoxVisible||settingsManager.isDisableSatHoverBox)return;!0!==starManager.isConstellationVisible||starManager.isAllConstellationVisible||starManager.clearConstellations(),satHoverBoxDOM.css({display:"none"}),canvasDOM.css({cursor:"default"}),isHoverBoxVisible=!1}else if(!isDragging&&!settingsManager.isDisableSatHoverBox){var i=satSet.getSatExtraOnly(e),r=satSet.getSatExtraOnly(selectedSat);if(isHoverBoxVisible=!0,i.static)if("Launch Facility"===i.type){var s=objectManager.extractLaunchSite(i.name);satHoverBoxNode1.textContent=s.site+", "+s.sitec,satHoverBoxNode2.innerHTML=i.type+satellite.distance(i,r)+"",satHoverBoxNode3.textContent=""}else"Control Facility"===i.type?(satHoverBoxNode1.textContent=i.name,satHoverBoxNode2.innerHTML=i.typeExt+satellite.distance(i,r)+"",satHoverBoxNode3.textContent=""):"Star"===i.type?(null!==starManager.findStarsConstellation(i.name)?satHoverBoxNode1.innerHTML=i.name+"</br>"+starManager.findStarsConstellation(i.name):satHoverBoxNode1.textContent=i.name,satHoverBoxNode2.innerHTML=i.type,satHoverBoxNode3.innerHTML="RA: "+i.ra.toFixed(3)+" deg </br> DEC: "+i.dec.toFixed(3)+" deg",starManager.drawConstellations(starManager.findStarsConstellation(i.name))):(satHoverBoxNode1.textContent=i.name,satHoverBoxNode2.innerHTML=i.type+satellite.distance(i,r)+"",satHoverBoxNode3.textContent="");else i.missile?(satHoverBoxNode1.innerHTML=i.ON+"<br >"+i.desc,satHoverBoxNode2.textContent="",satHoverBoxNode3.textContent=""):satellite.sensorSelected()&&isShowNextPass&&isShowDistance?(satHoverBoxNode1.textContent=i.ON,satHoverBoxNode2.textContent=i.SCC_NUM,satHoverBoxNode3.innerHTML=satellite.nextpass(i)+satellite.distance(i,r)+""):isShowDistance?(satHoverBoxNode1.textContent=i.ON,satHoverBoxNode2.innerHTML=i.SCC_NUM+satellite.distance(i,r)+"",satHoverBoxNode3.innerHTML="X: "+i.position.x.toFixed(2)+" Y: "+i.position.y.toFixed(2)+" Z: "+i.position.z.toFixed(2)+"</br>X: "+i.velocityX.toFixed(2)+"km/s Y: "+i.velocityY.toFixed(2)+"km/s Z: "+i.velocityZ.toFixed(2)+"km/s"):satellite.sensorSelected()&&isShowNextPass?(satHoverBoxNode1.textContent=i.ON,satHoverBoxNode2.textContent=i.SCC_NUM,satHoverBoxNode3.textContent=satellite.nextpass(i)):(satHoverBoxNode1.textContent=i.ON,satHoverBoxNode2.textContent=i.SCC_NUM,satHoverBoxNode3.innerHTML="X: "+i.position.x.toFixed(2)+" Y: "+i.position.y.toFixed(2)+" Z: "+i.position.z.toFixed(2)+"</br>X: "+i.velocityX.toFixed(2)+" Y: "+i.velocityY.toFixed(2)+" Z: "+i.velocityZ.toFixed(2));satHoverBoxDOM.css({display:"block","text-align":"center",position:"absolute",left:t+20,top:a-10}),canvasDOM.css({cursor:"pointer"})}}var E=0,R=0}();var isSelectedSatNegativeOne=!1;function selectSat(e){var t;if(db.log("selectSat"),db.log(`satId: ${e}`,!0),-1!==e){if("Star"==(t=satSet.getSat(e)).type)return;if((0==t.active||void 0===t.active)&&void 0===t.staticNum)return}if(satSet.selectSat(e),camSnapMode=!1,-1===e&&(settingsManager.currentColorScheme===ColorScheme.group||$("#search").val().length>=3?$("#menu-sat-fov").removeClass("bmenu-item-disabled"):($("#menu-sat-fov").removeClass("bmenu-item-selected"),$("#menu-sat-fov").addClass("bmenu-item-disabled"),settingsManager.isSatOverflyModeOn=!1,satCruncher.postMessage({isShowSatOverfly:"reset"}))),-1!==e||isSelectedSatNegativeOne){if(isSelectedSatNegativeOne=!1,selectedSat=e,!(t=satSet.getSatExtraOnly(e)))return;if("Star"==t.type)return;if(t.static){if(void 0===t.staticNum)return;return adviceList.sensor(),t=satSet.getSat(e),sensorManager.setSensor(null,t.staticNum),sensorManager.curSensorPositon=[t.position.x,t.position.y,t.position.z],selectedSat=-1,$("#menu-sensor-info").removeClass("bmenu-item-disabled"),$("#menu-fov-bubble").removeClass("bmenu-item-disabled"),$("#menu-surveillance").removeClass("bmenu-item-disabled"),$("#menu-planetarium").removeClass("bmenu-item-disabled"),$("#menu-astronomy").removeClass("bmenu-item-disabled"),void(-1!==selectedSat&&$("#menu-lookangles").removeClass("bmenu-item-disabled"))}var a,i;camZoomSnappedOnSat=!0,camAngleSnappedOnSat=!0,orbitDisplay.setSelectOrbit(e),satellite.sensorSelected()&&$("#menu-lookangles").removeClass("bmenu-item-disabled"),$("#menu-lookanglesmultisite").removeClass("bmenu-item-disabled"),$("#menu-satview").removeClass("bmenu-item-disabled"),$("#menu-editSat").removeClass("bmenu-item-disabled"),$("#menu-sat-fov").removeClass("bmenu-item-disabled"),$("#menu-map").removeClass("bmenu-item-disabled"),$("#menu-newLaunch").removeClass("bmenu-item-disabled"),"block"===$("#search-results").css("display")?window.innerWidth<=1e3||($("#search-results").attr("style","display:block; max-height:27%"),cameraType.current,cameraType.PLANETARIUM):window.innerWidth<=1e3||($("#search-results").attr("style","max-height:27%"),cameraType.current,cameraType.PLANETARIUM),t.missile?$(".sat-only-info").hide():$(".sat-only-info").show(),$("#sat-infobox").fadeIn(),$("#sat-info-title").html(t.ON),t.URL&&""!==t.URL&&$("#sat-info-title").html("<a class='iframe' href='"+t.URL+"'>"+t.ON+"</a>"),$("#edit-satinfo-link").html("<a class='iframe' href='editor.htm?scc="+t.SCC_NUM+"&popup=true'>Edit Satellite Info</a>"),$("#sat-intl-des").html(t.intlDes),"unknown"===t.OT?$("#sat-objnum").html(1+t.TLE2.substr(2,7).toString()):($("#sat-objnum").html(t.SCC_NUM),ga("send","event","Satellite","SCC: "+t.SCC_NUM,"SCC Number")),0===t.OT&&(a="TBA"),1===t.OT&&(a="Payload"),2===t.OT&&(a="Rocket Body"),3===t.OT&&(a="Debris"),4===t.OT&&(a="Amateur Report"),t.missile&&(a="Ballistic Missile"),$("#sat-type").html(a),i=objectManager.extractCountry(t.C),$("#sat-country").html(i);var r,s,n,o=[];if(t.missile?(s=(o=t.desc.split("("))[0].substr(0,o[0].length-1),r=t.desc.split("(")[1].split(")")[0],o.site=s,o.sitec=t.C):o=objectManager.extractLaunchSite(t.LS),$("#sat-site").html(o.site),$("#sat-sitec").html(o.sitec),ga("send","event","Satellite","Country: "+i,"Country"),ga("send","event","Satellite","Site: "+o,"Site"),t.missile?(t.LV=r,$("#sat-vehicle").html(t.LV)):($("#sat-vehicle").html(t.LV),"U"===t.LV&&$("#sat-vehicle").html("Unknown"),objectManager.extractLiftVehicle(t.LV)),null===t.R||void 0===t.R)$("#sat-rcs").html("Unknown");else t.R<.1&&(n="Small"),t.R>=.1&&(n="Medium"),t.R>1&&(n="Large"),$("#sat-rcs").html(n),$("#sat-rcs").tooltip({delay:50,html:t.R,position:"left"});if(!t.missile){$("a.iframe").colorbox({iframe:!0,width:"80%",height:"80%",fastIframe:!1,closeButton:!1}),$("#sat-apogee").html(t.apogee.toFixed(0)+" km"),$("#sat-perigee").html(t.perigee.toFixed(0)+" km"),$("#sat-inclination").html((t.inclination*RAD2DEG).toFixed(2)+"°"),$("#sat-eccentricity").html(t.eccentricity.toFixed(3)),$("#sat-period").html(t.period.toFixed(2)+" min"),$("#sat-period").tooltip({delay:50,html:"Mean Motion: "+MINUTES_PER_DAY/t.period.toFixed(2),position:"left"});var l,d=new Date,c=timeManager.getDayOfYear(d);d=(d=d.getFullYear()).toString().substr(2,2),l=satSet.getSat(e).TLE1.substr(18,2)===d?c-satSet.getSat(e).TLE1.substr(20,3):c-satSet.getSat(e).TLE1.substr(20,3)+365*satSet.getSat(e).TLE1.substr(17,2),$("#sat-elset-age").html(l+" Days"),$("#sat-elset-age").tooltip({delay:50,html:"Epoch Year: "+t.TLE1.substr(18,2).toString()+" Day: "+t.TLE1.substr(20,8).toString(),position:"left"}),d=new Date(timeManager.propRealTime+timeManager.propOffset);var m=SunCalc.getTimes(d,satellite.currentSensor.lat,satellite.currentSensor.long),S=satellite.isInSun(t);satellite.sensorSelected()?"Optical"!==satellite.currentSensor.type&&"Observer"!==satellite.currentSensor.type?$("#sat-sun").html("No Effect"):m.dawn.getTime()-d>0||m.dusk.getTime()-d<0?(0==S&&$("#sat-sun").html("No Sunlight"),1==S&&$("#sat-sun").html("Limited Sunlight"),2==S&&$("#sat-sun").html("Direct Sunlight")):"Invalid Date"==m.night||"Invalid Date"!=m.dawn&&"Invalid Date"!=m.dusk?$("#sat-sun").html("Sun Exclusion"):(0==S&&$("#sat-sun").html("No Sunlight"),1==S&&$("#sat-sun").html("Limited Sunlight"),2==S&&$("#sat-sun").html("Direct Sunlight")):(0==S&&$("#sat-sun").html("No Sunlight"),1==S&&$("#sat-sun").html("Limited Sunlight"),2==S&&$("#sat-sun").html("Direct Sunlight"))}satellite.sensorSelected()&&satellite.getlookangles(t,isLookanglesMenuOpen)}else isSelectedSatNegativeOne=!0,$("#sat-infobox").fadeOut(),orbitDisplay.clearSelectOrbit(),$("#menu-lookanglesmultisite").removeClass("bmenu-item-selected"),$("#menu-lookangles").removeClass("bmenu-item-selected"),$("#menu-editSat").removeClass("bmenu-item-selected"),$("#menu-map").removeClass("bmenu-item-selected"),$("#menu-newLaunch").removeClass("bmenu-item-selected"),$("#menu-breakup").removeClass("bmenu-item-selected"),$("#menu-customSensor").removeClass("bmenu-item-selected"),$("#menu-lookanglesmultisite").addClass("bmenu-item-disabled"),$("#menu-lookangles").addClass("bmenu-item-disabled"),$("#menu-satview").addClass("bmenu-item-disabled"),$("#menu-editSat").addClass("bmenu-item-disabled"),$("#menu-map").addClass("bmenu-item-disabled"),$("#menu-newLaunch").addClass("bmenu-item-disabled"),$("#menu-breakup").addClass("bmenu-item-disabled"),$("#editSat-menu").effect("slide",{direction:"left",mode:"hide"},1e3),$("#map-menu").effect("slide",{direction:"left",mode:"hide"},1e3),$("#newLaunch-menu").effect("slide",{direction:"left",mode:"hide"},1e3),$("#breakup-menu").effect("slide",{direction:"left",mode:"hide"},1e3),$("#customSensor-menu").effect("slide",{direction:"left",mode:"hide"},1e3),isEditSatMenuOpen=!1,isLookanglesMenuOpen=!1,settingsManager.isMapMenuOpen=!1,isLookanglesMultiSiteMenuOpen=!1,isNewLaunchMenuOpen=!1,isBreakupMenuOpen=!1,isMissileMenuOpen=!1,isCustomSensorMenuOpen=!1;selectedSat=e,-1!==e&&(void 0!==t.TTP?($("#sat-ttp-wrapper").show(),$("#sat-ttp").html(t.TTP)):$("#sat-ttp-wrapper").hide(),void 0!==t.NOTES?($("#sat-notes-wrapper").show(),$("#sat-notes").html(t.NOTES)):$("#sat-notes-wrapper").hide(),void 0!==t.FMISSED?($("#sat-fmissed-wrapper").show(),$("#sat-fmissed").html(t.FMISSED)):$("#sat-fmissed-wrapper").hide(),void 0!==t.ORPO?($("#sat-oRPO-wrapper").show(),$("#sat-oRPO").html(t.ORPO)):$("#sat-oRPO-wrapper").hide(),void 0!==t.constellation?($("#sat-constellation-wrapper").show(),$("#sat-constellation").html(t.constellation)):$("#sat-constellation-wrapper").hide(),void 0!==t.maneuver?($("#sat-maneuver-wrapper").show(),$("#sat-maneuver").html(t.maneuver)):$("#sat-maneuver-wrapper").hide(),void 0!==t.associates?($("#sat-associates-wrapper").show(),$("#sat-associates").html(t.associates)):$("#sat-associates-wrapper").hide(),uiController.updateMap()),updateUrl()}function enableSlowCPUMode(){db.log("enableSlowCPUMode"),settingsManager.cruncherReady&&(settingsManager.isSlowCPUModeEnabled=!0,settingsManager.minimumSearchCharacters=3,settingsManager.satLabelInterval=500,satCruncher.postMessage({isSlowCPUModeEnabled:!0}))}function debugDrawLine(e,t,a){switch(void 0===a&&(a=[1,0,1,1]),a){case"r":a=[1,0,0,1];break;case"o":a=[1,.5,0,1];break;case"y":a=[1,1,0,1];break;case"g":a=[0,1,0,1];break;case"b":a=[0,0,1,1];break;case"c":a=[0,1,1,1];break;case"p":a=[1,0,1,1]}if("sat"==e){let e=satSet.getSat(t);drawLineList.push({line:new Line,sat:e,ref:[0,0,0],ref2:[e.position.x,e.position.y,e.position.z],color:a})}if("sat2"==e){let e=satSet.getSat(t[0]);drawLineList.push({line:new Line,sat:e,ref:[t[1],t[2],t[3]],ref2:[e.position.x,e.position.y,e.position.z],color:a})}if("sat3"==e){let e=satSet.getSat(t[0]);var i=satSet.getSat(t[1]);drawLineList.push({line:new Line,sat:e,sat2:i,ref:[e.position.x,e.position.y,e.position.z],ref2:[i.position.x,i.position.y,i.position.z],color:a})}"ref"==e&&drawLineList.push({line:new Line,ref:[0,0,0],ref2:[t[0],t[1],t[2]],color:a}),"ref2"==e&&drawLineList.push({line:new Line,ref:[t[0],t[1],t[2]],ref2:[t[3],t[4],t[5]],color:a})}var tempStar1,tempStar2,satPos,drawLinesI=0;function drawLines(){if(0!=drawLineList.length)for(drawLinesI=0;drawLinesI<drawLineList.length;drawLinesI++)void 0!==drawLineList[drawLinesI].sat?(drawLineList[drawLinesI].sat=satSet.getSatPosOnly(drawLineList[drawLinesI].sat.id),void 0!==drawLineList[drawLinesI].sat2?void 0!==drawLineList[drawLinesI].sat2.name?(void 0===drawLineList[drawLinesI].sat2.id&&(drawLineList[drawLinesI].sat2.id=satSet.getIdFromSensorName(drawLineList[drawLinesI].sat2.name)),drawLineList[drawLinesI].sat2=satSet.getSatPosOnly(drawLineList[drawLinesI].sat2.id),drawLineList[drawLinesI].line.set([drawLineList[drawLinesI].sat.position.x,drawLineList[drawLinesI].sat.position.y,drawLineList[drawLinesI].sat.position.z],[drawLineList[drawLinesI].sat2.position.x,drawLineList[drawLinesI].sat2.position.y,drawLineList[drawLinesI].sat2.position.z])):(drawLineList[drawLinesI].sat2=satSet.getSatPosOnly(drawLineList[drawLinesI].sat2.id),drawLineList[drawLinesI].line.set([drawLineList[drawLinesI].sat.position.x,drawLineList[drawLinesI].sat.position.y,drawLineList[drawLinesI].sat.position.z],[drawLineList[drawLinesI].sat2.position.x,drawLineList[drawLinesI].sat2.position.y,drawLineList[drawLinesI].sat2.position.z])):drawLineList[drawLinesI].line.set(drawLineList[drawLinesI].ref,[drawLineList[drawLinesI].sat.position.x,drawLineList[drawLinesI].sat.position.y,drawLineList[drawLinesI].sat.position.z])):void 0!==drawLineList[drawLinesI].star1&&void 0!==drawLineList[drawLinesI].star2?(void 0===drawLineList[drawLinesI].star1ID&&(drawLineList[drawLinesI].star1ID=satSet.getIdFromStarName(drawLineList[drawLinesI].star1)),void 0===drawLineList[drawLinesI].star2ID&&(drawLineList[drawLinesI].star2ID=satSet.getIdFromStarName(drawLineList[drawLinesI].star2)),tempStar1=satSet.getSatPosOnly(drawLineList[drawLinesI].star1ID),tempStar2=satSet.getSatPosOnly(drawLineList[drawLinesI].star2ID),drawLineList[drawLinesI].line.set([tempStar1.position.x,tempStar1.position.y,tempStar1.position.z],[tempStar2.position.x,tempStar2.position.y,tempStar2.position.z])):drawLineList[drawLinesI].line.set(drawLineList[drawLinesI].ref,drawLineList[drawLinesI].ref2),drawLineList[drawLinesI].line.draw(drawLineList[drawLinesI].color)}
var propRealTime,propOffset,propRate;importScripts("lib/satellite.js");var NUM_SEGS,TAU=2*Math.PI,DEG2RAD=TAU/360,RADIUS_OF_EARTH=6371,satCache=[];let orbitFadeFactor=1;function jday(t,a,e,s,i,r){"use strict";return 367*t-Math.floor(7*(t+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+e+1721013.5+((r/60+i)/60+s)/24}function propTime(){"use strict";var t=new Date,a=(Number(t)-Number(propRealTime))*propRate;return t.setTime(Number(propRealTime)+propOffset+a),t}onmessage=function(t){if(t.data.isUpdate&&(1!=t.data.missile&&t.data.satId<99999&&(satCache[t.data.satId]=satellite.twoline2satrec(t.data.TLE1,t.data.TLE2)),t.data.missile&&(satCache[t.data.satId]=t.data)),t.data.isInit){var a=JSON.parse(t.data.satData);orbitFadeFactor=JSON.parse(t.data.orbitFadeFactor);var e=a.length-1;console.log(e);let s=-1;for(;s<e;)delete a[++s].id,a[s].static||a[s].missile?satCache[s]=a[s]:satCache[s]=satellite.twoline2satrec(a[s].TLE1,a[s].TLE2);NUM_SEGS=t.data.numSegs}else{var s=t.data.satId;propRealTime=t.data.realTime,propOffset=t.data.offset,propRate=t.data.rate;var i=new Float32Array(4*(NUM_SEGS+1)),r=propTime(),o=jday(r.getUTCFullYear(),r.getUTCMonth()+1,r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds()),l=1440*((o+=1.15741e-8*r.getUTCMilliseconds())-satCache[s].jdsatepoch),c=NUM_SEGS+1;let a=0;if(satCache[s].missile){satCache[s].altList.length;for(;a<c;){var d=parseInt(satCache[s].altList.length*(a/NUM_SEGS)),n=propTime(),p=jday(n.getUTCFullYear(),n.getUTCMonth()+1,n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds());p+=1.15741e-8*n.getUTCMilliseconds();var h=satellite.gstime(p),T=Math.cos(satCache[s].latList[d]*DEG2RAD),C=Math.sin(satCache[s].latList[d]*DEG2RAD),U=Math.cos(satCache[s].lonList[d]*DEG2RAD+h),M=Math.sin(satCache[s].lonList[d]*DEG2RAD+h);i[4*a]=(RADIUS_OF_EARTH+satCache[s].altList[d])*T*U,i[4*a+1]=(RADIUS_OF_EARTH+satCache[s].altList[d])*T*M,i[4*a+2]=(RADIUS_OF_EARTH+satCache[s].altList[d])*C,i[4*a+3]=Math.min(orbitFadeFactor*(c/(a+1)),1),a++}}else{let t=2*Math.PI/satCache[s].no/NUM_SEGS;for(;a<c;){var f=l+a*t,g=satellite.sgp4(satCache[s],f).position;try{i[4*a]=g.x,i[4*a+1]=g.y,i[4*a+2]=g.z,i[4*a+3]=Math.min(orbitFadeFactor*(c/(a+1)),1)}catch(t){i[4*a]=0,i[4*a+1]=0,i[4*a+2]=0,i[4*a+3]=0}a++}}postMessage({pointsOut:i.buffer,satId:s},[i.buffer])}};
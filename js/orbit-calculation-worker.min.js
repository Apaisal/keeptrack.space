var propRealTime,propOffset,propRate;importScripts("lib/satellite.min.js");var NUM_SEGS,TAU=2*Math.PI,DEG2RAD=TAU/360,RADIUS_OF_EARTH=6371,satCache=[];function jday(t,a,e,s,i,r){"use strict";return 367*t-Math.floor(7*(t+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+e+1721013.5+((r/60+i)/60+s)/24}function propTime(){"use strict";var t=new Date,a=(Number(t)-Number(propRealTime))*propRate;return t.setTime(Number(propRealTime)+propOffset+a),t}onmessage=function(t){if(t.data.isUpdate&&(t.data.missile||(satCache[t.data.satId]=satellite.twoline2satrec(t.data.TLE1,t.data.TLE2)),t.data.missile&&(satCache[t.data.satId]=t.data)),t.data.isInit){for(var a=JSON.parse(t.data.satData),e=a.length-1,s=-1;s<e;)a[++s].static||a[s].missile?satCache[s]=a[s]:satCache[s]=satellite.twoline2satrec(a[s].TLE1,a[s].TLE2);NUM_SEGS=t.data.numSegs}else{var i=t.data.satId;propRealTime=t.data.realTime,propOffset=t.data.offset,propRate=t.data.rate;var r=new Float32Array(3*(NUM_SEGS+1)),o=propTime(),l=jday(o.getUTCFullYear(),o.getUTCMonth()+1,o.getUTCDate(),o.getUTCHours(),o.getUTCMinutes(),o.getUTCSeconds()),c=1440*((l+=1.15741e-8*o.getUTCMilliseconds())-satCache[i].jdsatepoch),p=NUM_SEGS+1;if(s=0,satCache[i].missile)for(var n=satCache[i].altList.length/NUM_SEGS;s<p;){var h=parseInt(satCache[i].altList.length*(s/NUM_SEGS)),T=propTime(),C=jday(T.getUTCFullYear(),T.getUTCMonth()+1,T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds());C+=1.15741e-8*T.getUTCMilliseconds();var d=satellite.gstime(C),U=Math.cos(satCache[i].latList[h]*DEG2RAD),f=Math.sin(satCache[i].latList[h]*DEG2RAD),M=Math.cos(satCache[i].lonList[h]*DEG2RAD+d),S=Math.sin(satCache[i].lonList[h]*DEG2RAD+d);r[3*s]=(RADIUS_OF_EARTH+satCache[i].altList[h])*U*M,r[3*s+1]=(RADIUS_OF_EARTH+satCache[i].altList[h])*U*S,r[3*s+2]=(RADIUS_OF_EARTH+satCache[i].altList[h])*f,s++}else for(n=2*Math.PI/satCache[i].no/NUM_SEGS;s<p;){var g=c+s*n,m=satellite.sgp4(satCache[i],g).position;try{r[3*s]=m.x,r[3*s+1]=m.y,r[3*s+2]=m.z}catch(t){r[3*s]=0,r[3*s+1]=0,r[3*s+2]=0}s++}postMessage({pointsOut:r.buffer,satId:i},[r.buffer])}};
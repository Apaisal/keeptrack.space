var propRealTime,propOffset,propRate;importScripts("lib/satellite.js");var NUM_SEGS,TAU=2*Math.PI,DEG2RAD=TAU/360,RADIUS_OF_EARTH=6371,satCache=[];function jday(t,a,e,s,i,r){"use strict";return 367*t-Math.floor(7*(t+Math.floor((a+9)/12))*.25)+Math.floor(275*a/9)+e+1721013.5+((r/60+i)/60+s)/24}function propTime(){"use strict";var t=new Date,a=(Number(t)-Number(propRealTime))*propRate;return t.setTime(Number(propRealTime)+propOffset+a),t}onmessage=function(t){if(t.data.isUpdate&&(0==t.data.missile&&t.data.satId<99999&&(satCache[t.data.satId]=satellite.twoline2satrec(t.data.TLE1,t.data.TLE2)),t.data.missile&&(satCache[t.data.satId]=t.data)),t.data.isInit){var a=JSON.parse(t.data.satData),e=a.length-1;let s=-1;for(;s<e;)delete a[++s].id,a[s].static||a[s].missile?satCache[s]=a[s]:satCache[s]=satellite.twoline2satrec(a[s].TLE1,a[s].TLE2);NUM_SEGS=t.data.numSegs}else{var s=t.data.satId;propRealTime=t.data.realTime,propOffset=t.data.offset,propRate=t.data.rate;var i=new Float32Array(3*(NUM_SEGS+1)),r=propTime(),l=jday(r.getUTCFullYear(),r.getUTCMonth()+1,r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds()),o=1440*((l+=1.15741e-8*r.getUTCMilliseconds())-satCache[s].jdsatepoch),c=NUM_SEGS+1;let a=0;if(satCache[s].missile){satCache[s].altList.length;for(;a<c;){var p=parseInt(satCache[s].altList.length*(a/NUM_SEGS)),h=propTime(),n=jday(h.getUTCFullYear(),h.getUTCMonth()+1,h.getUTCDate(),h.getUTCHours(),h.getUTCMinutes(),h.getUTCSeconds());n+=1.15741e-8*h.getUTCMilliseconds();var T=satellite.gstime(n),d=Math.cos(satCache[s].latList[p]*DEG2RAD),C=Math.sin(satCache[s].latList[p]*DEG2RAD),U=Math.cos(satCache[s].lonList[p]*DEG2RAD+T),f=Math.sin(satCache[s].lonList[p]*DEG2RAD+T);i[3*a]=(RADIUS_OF_EARTH+satCache[s].altList[p])*d*U,i[3*a+1]=(RADIUS_OF_EARTH+satCache[s].altList[p])*d*f,i[3*a+2]=(RADIUS_OF_EARTH+satCache[s].altList[p])*C,a++}}else{let t=2*Math.PI/satCache[s].no/NUM_SEGS;for(;a<c;){var g=o+a*t,M=satellite.sgp4(satCache[s],g).position;try{i[3*a]=M.x,i[3*a+1]=M.y,i[3*a+2]=M.z}catch(t){i[3*a]=0,i[3*a+1]=0,i[3*a+2]=0}a++}}postMessage({pointsOut:i.buffer,satId:s},[i.buffer])}};